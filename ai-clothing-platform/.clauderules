# .clauderules - 项目宪法文件

> **作用**：这是AI的"长期记忆外挂"，防止遗忘关键决策，避免重复无效沟通
> **更新**：每次确认重要架构决策后，必须更新此文件
> **读取**：每次开始工作前，必须先读取此文件

---

## 🤖 AI 行为准则（通用规则）

> **严格执行**：以下规则适用于所有AI辅助开发工作，违反这些规则将导致代码腐化

### 1. **NO DELETION**（禁止删除）
- ❌ **严禁**删除任何非空文件
- ✅ 若需废弃代码，请重命名为 `*.deprecated.ts` 或注释掉
- ✅ 删除前必须确认文件无引用

### 2. **NO SECRETS**（禁止硬编码密钥）
- ❌ **严禁**在代码中硬编码密码、Token或API Key
- ✅ 必须使用环境变量（`.env`）
- ✅ 敏感信息通过 `process.env.VAR_NAME` 访问

### 3. **MODULARITY**（模块化原则）
- ⚠️ 单个文件超过 **250行** 时，必须主动提议拆分
- ✅ 拆分建议：按功能模块、按数据层/视图层、按业务逻辑

### 4. **DRY PRINCIPLE**（不要重复自己）
- ✅ 编写新功能前，必须先扫描 `src/utils` 或 `src/lib/utils`
- ✅ 优先复用现有工具函数
- ✅ 发现重复代码 > 3次时，必须提取为公共函数

### 5. **NAMING**（语义化命名）
- ✅ 变量命名必须具备语义（如 `userList` 而非 `list`）
- ❌ 禁止使用单字母变量（循环索引 `i`, `j`, `k` 除外）
- ✅ 布尔值使用 `is`/`has`/`should` 前缀（如 `isLoading`）

### 6. **DOCS FIRST**（文档优先）
- ✅ 进行重大架构变更前，必须先更新 `docs/00-架构设计/` 中的相关文档
- ✅ 记录决策原因（ADR - Architecture Decision Record）

---

## 🎯 项目核心定位

### 项目名称
AI服装平台 (AI Clothing Platform) - Next.js 16 + N8N + 飞书集成

### 核心业务逻辑
**双轨并行架构**：用户既可在前端操作，又可在飞书多维表格操作，提交信息后交给N8N工作流处理，数据回填到飞书表格，双轨并行，且不能互相冲突。

---

## ⚠️ 最容易犯的错误（历史教训）

### ❌ 错误1：创建"合并工作流"
**现象**：在一个JSON文件中包含2个Webhook触发器（前端+飞书）
**正确做法**：必须创建2个完全独立的N8N工作流JSON文件
- 工作流1：`AI服装平台-前端触发-同步飞书.json`
- 工作流2：`AI服装平台-飞书触发-独立流程.json`

### ❌ 错误2：飞书表格字段数量错误
**实际字段（10个）**：序号、提示词、商品图片、场景图、点击按钮、生成结果、状态、生成数量、尺寸比例、AI模型
**错误假设**：13个字段（包含清晰度、进度、数据来源、同步状态、用户ID）
**正确做法**：以用户截图为准，不要假设额外字段

### ❌ 错误3：前端配置DeerAPI凭证
**错误做法**：在前端设置页面配置DeerAPI密钥
**正确做法**：
- 前端：❌ 不配置DeerAPI凭证
- N8N：✅ 配置DeerAPI account凭证（两个工作流共用）

### ❌ 错误4：不理解飞书凭证的双重用途
**错误理解**：前端和N8N都配置飞书凭证会冲突
**正确理解**：
- 前端飞书凭证：用于创建记录、同步状态（通过后端API）
- N8N飞书凭证：用于读取记录、更新结果（工作流2）
- **不会冲突**：用途不同、调用时机不同

---

## 📊 飞书多维表格结构（确认版）

### 10个实际字段

| 字段名称 | 字段类型 | 用途 | 数据来源 | 必填 |
|---------|---------|------|---------|------|
| 序号 | 数字 | 自动编号 | 系统自动 | - |
| 提示词 | 多行文本 | AI生成提示词 | 用户填写 | ✅ |
| 商品图片 | 附件 | 产品图片 | 用户上传 | ✅ |
| 场景图 | 附件 | 场景参考图 | 用户上传 | ❌ |
| 点击按钮 | 按钮 | 触发生成 | 用户点击 | - |
| 生成结果 | 附件 | AI生成的图片 | N8N写入 | - |
| 状态 | 单选 | 任务状态 | N8N更新 | - |
| 生成数量 | 数字 | 生成几张图 | 用户填写 | ❌ |
| 尺寸比例 | 单选 | 图片比例 | 用户选择 | ❌ |
| AI模型 | 单选 | AI模型 | 用户选择 | ❌ |

### 默认值
- AI模型：Gemini-3-Pro-Image
- 尺寸比例：3:4
- 生成数量：4

---

## 🔐 凭证管理策略

### N8N凭证（两个工作流共用）

1. **DeerAPI account**
   - 用途：调用AI图片生成API
   - 配置位置：仅N8N
   - 使用工作流：工作流1 + 工作流2

2. **Feishu Credentials account**
   - 用途：读取/更新飞书记录
   - 配置位置：仅N8N
   - 使用工作流：仅工作流2

### 前端环境变量

```env
# 飞书配置（用于后端API同步）
FEISHU_APP_ID=cli_xxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxx

# N8N配置
N8N_WEBHOOK_URL=https://n8n.your-domain.com/webhook/ai-clothing-frontend

# 前端URL
NEXT_PUBLIC_APP_URL=https://your-app.vercel.app
```

### 前端不配置的凭证
- ❌ DeerAPI密钥（安全风险）
- ❌ N8N回调密钥（不需要）

---

## 🔄 双轨工作流架构

### 工作流1：前端触发流程

**文件名**：`AI服装平台-前端触发-同步飞书.json`

**触发器**：Webhook (POST)

**完整流程**：
```
1. Webhook接收前端请求
   ↓
2. Header Auth验证
   ↓
3. 解析请求参数
   ↓
4. 下载图片（商品图 + 场景图）
   ↓
5. 判断比例并设置尺寸
   ↓
6. DeerAPI生成（使用Gemini-3-Pro-Image）
   ↓
7. 上传结果图到图床
   ↓
8. ⭐ 创建飞书记录
   ↓
9. 回调前端API
   ↓
10. Webhook响应
```

**关键节点配置**：
```javascript
// 创建飞书记录节点
{
  "node": "Feishu Bitable - Create Record",
  "credentials": "Feishu Credentials account",
  "appToken": "app_xxx",
  "tableId": "tbl_xxx",
  "fields": {
    "提示词": "{{ $json.prompt }}",
    "商品图片": "{{ $json.productImageUrl }}",
    "场景图": "{{ $json.sceneImageUrl }}",
    "AI模型": "{{ $json.aiModel }}",
    "尺寸比例": "{{ $json.aspectRatio }}",
    "生成数量": {{ $json.imageCount }},
    "生成结果": "{{ $json.resultImageUrls }}",
    "状态": "✅ 已完成"
  }
}
```

**接收参数**：
```json
{
  "taskId": "uuid-xxx",
  "userId": "user-xxx",
  "mode": "scene",
  "prompt": "红色连衣裙",
  "productImageUrl": "https://...",
  "sceneImageUrl": "https://...",
  "aiModel": "Gemini-3-Pro-Image",
  "aspectRatio": "3:4",
  "imageCount": 4,
  "quality": "high"
}
```

---

### 工作流2：飞书触发流程

**文件名**：`AI服装平台-飞书触发-独立流程.json`

**触发器**：Webhook (POST) - 由飞书自动化调用

**完整流程**：
```
1. Webhook接收飞书自动化请求
   ↓
2. 飞书鉴权验证
   ↓
3. 获取触发记录详情
   ↓
4. 提取记录参数
   ↓
5. 更新飞书状态为"处理中"
   ↓
6. 下载商品图片
   ↓
7. 判断是否有场景图
   ↓
8. DeerAPI生成（使用Gemini-3-Pro-Image）
   ↓
9. 处理生成结果
   ↓
10. 上传结果图到图床
   ↓
11. ⭐ 更新飞书记录
   ↓
12. 返回成功响应
```

**飞书自动化触发**：
- 触发条件：点击"点击按钮"字段
- Webhook URL：工作流2的Webhook URL
- 请求体：
```json
{
  "app_token": "app_xxx",
  "table_id": "tbl_xxx",
  "record_id": "rec_xxx"
}
```

**关键节点配置**：
```javascript
// 读取记录节点
{
  "node": "Feishu Bitable - Get Record",
  "credentials": "Feishu Credentials account",
  "appToken": "{{ $json.app_token }}",
  "tableId": "{{ $json.table_id }}",
  "recordId": "{{ $json.record_id }}"
}

// 提取参数节点
{
  "prompt": "{{ $json.data.records[0].fields['提示词'][0].text }}",
  "productImageUrl": "{{ $json.data.records[0].fields['商品图片'][0].url }}",
  "sceneImageUrl": "{{ $json.data.records[0].fields['场景图'] && $json.data.records[0].fields['场景图'][0].url || '' }}",
  "aiModel": "{{ $json.data.records[0].fields['AI模型'] || 'Gemini-3-Pro-Image' }}",
  "aspectRatio": "{{ $json.data.records[0].fields['尺寸比例'] || '3:4' }}",
  "imageCount": "{{ $json.data.records[0].fields['生成数量'] || 4 }}"
}

// 更新记录节点
{
  "node": "Feishu Bitable - Update Record",
  "credentials": "Feishu Credentials account",
  "appToken": "{{ $json.app_token }}",
  "tableId": "{{ $json.table_id }}",
  "recordId": "{{ $json.recordId }}",
  "fields": {
    "生成结果": "{{ $json.resultImageUrls }}",
    "状态": "✅ 已完成"
  }
}
```

---

## 📋 字段映射关系

### 前端 → N8N → 飞书

| 数据含义 | 前端字段名 | N8N参数名 | 飞书字段名 | 转换 |
|---------|-----------|----------|-----------|------|
| 提示词 | `prompt` | `prompt` | `提示词` | 直接映射 |
| 商品图 | `productImageUrl` | `productImageUrl` | `商品图片` | URL → 附件 |
| 场景图 | `sceneImageUrl` | `sceneImageUrl` | `场景图` | URL → 附件 |
| AI模型 | `aiModel` | `aiModel` | `AI模型` | 直接映射 |
| 尺寸比例 | `aspectRatio` | `aspectRatio` | `尺寸比例` | 直接映射 |
| 生成数量 | `imageCount` | `imageCount` | `生成数量` | 直接映射 |
| 生成结果 | `resultImageUrls` | `resultImageUrls` | `生成结果` | URL → 附件 |
| 任务状态 | `status` | `status` | `状态` | 枚举转换 |

### 飞书 → N8N → 飞书（更新）

| 数据含义 | 飞书读取 | N8N参数名 | 飞书写入 | 转换 |
|---------|---------|----------|---------|------|
| 提示词 | `['提示词'][0].text` | `prompt` | - | 读取使用 |
| 商品图 | `['商品图片'][0].url` | `productImageUrl` | - | 读取使用 |
| 场景图 | `['场景图'][0].url` | `sceneImageUrl` | - | 可选读取 |
| AI模型 | `['AI模型']` | `aiModel` | - | 读取使用 |
| 尺寸比例 | `['尺寸比例']` | `aspectRatio` | - | 读取使用 |
| 生成数量 | `['生成数量']` | `imageCount` | - | 读取使用 |
| - | - | `resultImageUrls` | `生成结果` | 写入结果 |
| - | - | - | `状态` | 更新状态 |

---

## 🛠️ 开发规范

### TypeScript配置
- 严格模式：`"strict": true`
- 无`any`类型（除非绝对必要且有注释说明）
- 接口定义优先于类型别名

### 代码结构
```
src/
├── app/              # Next.js App Router
│   ├── api/          # API路由
│   └── page.tsx      # 页面（<250行）
├── components/       # React组件
│   ├── ui/          # 基础UI组件（<150行）
│   └── workspace/   # 业务组件（<200行）
├── lib/
│   ├── services/    # 业务逻辑层
│   ├── repositories/# 数据访问层
│   └── utils/       # 工具函数
└── hooks/           # 自定义Hooks（<150行）
```

### 命名约定
- 文件名：`kebab-case.ts` 或 `PascalCase.tsx`
- 变量名：`camelCase`
- 常量名：`UPPER_SNAKE_CASE`
- 接口名：`PascalCase`，以`I`开头或不用前缀
- 类型名：`PascalCase`，以`T`开头或不用前缀

### 文件大小限制
- 页面组件：≤250行（强制）
- 业务组件：≤200行（警告）
- UI组件：≤150行（警告）
- Hooks：≤150行（警告）

### 提交前检查
```bash
# 必须全部通过
npm run build        # 编译成功
npm run lint         # 无警告
npm run format       # 代码格式化
```

### 禁止事项
- ❌ 使用`console.log`（保留`console.error`和`console.warn`）
- ❌ 提交`.old`、`.bak`、`.disabled`文件
- ❌ 硬编码API密钥或凭证
- ❌ 跳过类型检查（使用`@ts-ignore`等）
- ❌ 在组件中直接调用API（使用services层）

---

## 📚 文档管理规范

### 文档目录结构

```
docs/
├── 00-架构设计/          # 核心架构决策和设计文档
├── 01-配置指南/          # 具体配置步骤和操作指南
├── 02-工作流文件/        # N8N工作流JSON文件（直接导入）
├── 03-开发记录/          # 开发历史记录（按日期命名）
└── 99-历史归档/          # 过时废弃文档
```

### 文档位置规范（严格执行）

| 文档类型 | 存放位置 | 命名格式 |
|---------|---------|---------|
| 架构设计文档 | `docs/00-架构设计/` | `功能-架构.md` |
| 配置指南 | `docs/01-配置指南/` | `系统-配置指南.md` |
| N8N工作流JSON | `docs/02-工作流文件/` | `轨道-触发方式-功能描述.json` |
| 开发记录 | `docs/03-开发记录/` | `YYYY-MM-DD-任务描述.md` |
| 过时文档 | `docs/99-历史归档/_废弃文档/` | 原文件名 |

### 🚨 禁止事项

- ❌ **严禁**在 `docs/` 根目录下直接散放文件
- ❌ **严禁**创建 `v2`、`v3`、`最终版`、`确认版` 等版本后缀（直接替换原文件）
- ❌ **严禁**保留 `.old`、`.bak`、`.disabled` 文件（直接归档或删除）
- ❌ **严禁**在过时文档上修改内容（创建新文件，旧文件归档）

### 文档更新流程

1. 确定文档类型和存放位置
2. 检查是否已有同名文档
3. 如有同名文档，直接替换内容（不创建副本）
4. 如文档内容变化较大，先将旧文档移至 `99-历史归档/_废弃文档/`
5. 更新 `docs/README.md` 索引

### AI助手必读

每次开始工作前，必须：
1. 阅读本项目 `.clauderules`
2. 阅读 `docs/README.md` 了解文档结构
3. 如需创建新文档，严格按照上述位置规范存放

---

## 🔍 记忆唤醒机制

### 每次开始工作前，必须回答：

1. **这是哪个轨道的工作？**
   - [ ] 前端轨道（工作流1）
   - [ ] 飞书轨道（工作流2）
   - [ ] 前端代码开发
   - [ ] N8N工作流开发

2. **凭证配置位置是否正确？**
   - [ ] DeerAPI：仅N8N
   - [ ] Feishu：前端环境变量 + N8N凭证
   - [ ] 前端不配置DeerAPI

3. **飞书表格字段数量是否正确？**
   - [ ] 10个字段（不是13个）

4. **是否创建了2个独立的工作流？**
   - [ ] 工作流1：前端触发
   - [ ] 工作流2：飞书触发

5. **是否包含了飞书操作节点？**
   - [ ] 工作流1：创建记录节点
   - [ ] 工作流2：读取+更新记录节点

### 如果不确定，立即停止工作并查阅本文件！

---

## 📝 更新日志

### 2026-01-29 - 初始版本
- 确认双轨架构（2个独立工作流）
- 确认飞书表格10个字段
- 确认凭证管理策略
- 确认字段映射关系
- 确认开发规范

### 2026-01-29 - 创建N8N工作流JSON文件
- ✅ 创建工作流1：`AI服装平台-前端触发-同步飞书.json`
- ✅ 创建工作流2：`AI服装平台-飞书触发-独立流程.json`
- ✅ 包含飞书创建记录节点（工作流1）
- ✅ 包含飞书读取+更新记录节点（工作流2）
- ✅ 创建配置指南：`双轨工作流配置指南-v2.md`

### 2026-01-29 - docs目录重新整理（已完成）
- ✅ 建立清晰的文档目录结构（00-架构, 01-配置, 02-工作流, 03-记录, 99-归档）
- ✅ 归档过时文档（30+个文件移至99-历史归档/_废弃文档/）
- ✅ 创建文档导航中心（docs/README.md）
- ✅ 更新.clauderules添加文档管理规范

### 下一个Session任务
- ⏳ 根据实际需求继续功能开发

### 更新模板（在此之后添加）
```markdown
### YYYY-MM-DD - 更新内容
- 确认XXX
- 修正XXX
- 新增XXX
```

---

## 🚨 紧急情况处理

### 如果出现以下情况，立即查阅本文件：
1. 不确定应该创建1个还是2个工作流
2. 不确定凭证应该在哪里配置
3. 不确定飞书表格有几个字段
4. 准备在前端配置DeerAPI凭证
5. 准备创建合并工作流
6. 用户说"你之前不是说..."的时候

### 如果用户指出错误：
1. 立即承认错误
2. 查阅本文件确认正确做法
3. 更新本文件（如果是新问题）
4. 继续工作

---

_本文件是项目的"宪法"，任何违反本文件的行为都是错误的！_
_最后更新：2026-01-29_
_维护者：Claude Code AI Assistant_
