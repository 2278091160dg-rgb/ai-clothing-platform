// Prisma Schema for AI Clothing Platform
// æœ¬åœ°å¼€å‘ä½¿ç”¨ SQLiteï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // ä½¿ç”¨ Supabase Session Pooler (ä¸æ˜¯ Transaction mode)ä»¥é¿å… prepared statement é—®é¢˜
  url      = "postgresql://postgres.xjojyolfqpjfgdkywkew:G2d2Avr6dCW3J2@aws-1-ap-south-1.pooler.supabase.com:5432/postgres"
}

// ============================================
// User & Authentication
// ============================================

model User {
  id                String    @id @default(uuid())
  feishuUserId      String?   @unique
  feishuOpenId      String?   @unique
  feishuUnionId     String?
  name              String?
  email             String?   @unique
  avatar            String?
  role              UserRole  @default(USER)

  // Relations
  tasks             Task[]
  syncLogs          SyncLog[]
  auditLogs         AuditLog[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([feishuUserId])
  @@index([email])
  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

// ============================================
// Task Management
// ============================================

model Task {
  id                String        @id @default(uuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Feishu Integration (Primary Source of Truth)
  feishuRecordId    String?       @unique
  feishuAppToken    String?
  feishuTableId     String?

  // Input Data
  productImageUrl   String?
  productImageToken String?
  sceneImageUrl     String?
  sceneImageToken   String?
  prompt            String?

  // Prompt Optimization (AIä¼˜åŒ–æç¤ºè¯)
  originalPrompt    String?       // ç”¨æˆ·è¾“å…¥çš„åŸå§‹æç¤ºè¯
  optimizedPrompt   String?       // AIä¼˜åŒ–åçš„æç¤ºè¯
  promptSource      PromptSource  @default(USER)  // æœ€ç»ˆä½¿ç”¨çš„æç¤ºè¯æ¥æº
  promptOptimizationEnabled Boolean  @default(false)  // ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†AIä¼˜åŒ–
  promptOptimizationId    String?  // ä¼˜åŒ–ä»»åŠ¡IDï¼ˆç”¨äºè¿½æº¯ï¼‰
  promptOptimizedAt       DateTime?  // æç¤ºè¯ä¼˜åŒ–æ—¶é—´

  // Generation Configuration
  aiModel           String        @default("FLUX.1")
  aspectRatio       String        @default("1:1")
  imageCount        Int           @default(4)
  quality           String        @default("high")

  // Result (SQLite ä½¿ç”¨ JSON å­—ç¬¦ä¸²å­˜å‚¨æ•°ç»„)
  resultImageUrls   String?   // JSON string array
  resultImageTokens String?   // JSON string array

  // Status Tracking
  status            TaskStatus    @default(PENDING)
  progress          Int           @default(0)
  errorMessage      String?

  // Concurrency Control (å¹¶å‘æ§åˆ¶)
  version           Int           @default(0)  // ä¹è§‚é”ç‰ˆæœ¬å·
  lastModifiedBy    String?       // 'web' | 'feishu' | 'api'
  lastModifiedAt    DateTime      @default(now())  // æœ€åä¿®æ”¹æ—¶é—´
  conflictDetected  Boolean       @default(false)  // å†²çªæ ‡è®°

  // Sync Status (åŒæ­¥çŠ¶æ€)
  syncStatus        TaskSyncStatus @default(PENDING)  // ä¸é£ä¹¦åŒæ­¥çŠ¶æ€
  syncError         String?       // åŒæ­¥å¤±è´¥åŸå› 
  lastSyncAt        DateTime?     // æœ€ååŒæ­¥æ—¶é—´

  // Batch Support
  batchId           String?
  batchIndex        Int?

  // Cache Expiration (7 days)
  expiresAt         DateTime?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  completedAt       DateTime?

  @@index([userId])
  @@index([feishuRecordId])
  @@index([status])
  @@index([batchId])
  @@index([expiresAt])
  @@index([version])
  @@index([lastModifiedAt])
  @@index([syncStatus])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  UPLOADING
  PROCESSING
  GENERATING
  COMPLETED
  FAILED
}

enum PromptSource {
  USER           // ç”¨æˆ·ç›´æ¥è¾“å…¥
  AI_OPTIMIZED   // AIä¼˜åŒ–å
  FEISHU         // é£ä¹¦è¡¨æ ¼è¾“å…¥
  MERGED         // åˆå¹¶åçš„æç¤ºè¯
}

enum TaskSyncStatus {
  PENDING      // å¾…åŒæ­¥
  SYNCING      // åŒæ­¥ä¸­
  SYNCED       // å·²åŒæ­¥
  FAILED       // åŒæ­¥å¤±è´¥
}

// ============================================
// Sync & Audit
// ============================================

model SyncLog {
  id              String      @id @default(uuid())
  userId          String?
  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  source          SyncSource
  action          SyncAction
  entityType      String
  entityId        String

  // Request/Response tracking
  requestData     Json?
  responseData    Json?

  status          SyncStatus
  errorCode       String?
  errorMessage    String?

  // Retry tracking
  retryCount      Int         @default(0)
  maxRetries      Int         @default(3)

  createdAt       DateTime    @default(now())
  completedAt     DateTime?

  @@index([userId])
  @@index([entityId])
  @@index([status])
  @@index([createdAt])
  @@map("sync_logs")
}

enum SyncSource {
  FEISHU
  FRONTEND
  SYSTEM
}

enum SyncAction {
  CREATE
  UPDATE
  DELETE
  SYNC
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  RETRYING
}

model AuditLog {
  id              String      @id @default(uuid())
  userId          String?
  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  action          String
  entity          String
  entityId        String?

  // Change tracking
  changes         Json?
  oldValues       Json?
  newValues       Json?

  // Context
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime    @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// Quota & Usage
// ============================================

model UserQuota {
  id              String      @id @default(uuid())
  userId          String      @unique

  totalQuota      Int         @default(1000)
  usedQuota       Int         @default(0)
  remainingQuota  Int         @default(1000)

  resetPeriod     QuotaPeriod @default(MONTHLY)
  resetAt         DateTime?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("user_quotas")
}

enum QuotaPeriod {
  DAILY
  WEEKLY
  MONTHLY
}

// ============================================
// Template Management
// ============================================

model PromptTemplate {
  id              String      @id @default(uuid())
  name            String
  description     String?
  category        String?

  template        String
  variables       String?   // JSON string array

  isPublic        Boolean     @default(false)
  userId          String?

  usageCount      Int         @default(0)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([category])
  @@map("prompt_templates")
}

// ============================================
// AI Conversation (å¤šè½®å¯¹è¯)
// ============================================

model PromptConversation {
  id          String   @id @default(uuid())

  // å…³è”é£ä¹¦è®°å½•ï¼ˆé€šè¿‡recordIdï¼Œä¸ä¾èµ–Taskï¼‰
  recordId    String   // é£ä¹¦å¤šç»´è¡¨æ ¼è®°å½•ID

  // å¯¹è¯çŠ¶æ€
  status      String   @default("active") // active | completed | discarded
  source      String   @default("web")    // web | feishu

  // æœ€ç»ˆç»“æœ
  finalPrompt String?  // ç”¨æˆ·ç¡®è®¤åçš„æœ€ç»ˆæç¤ºè¯
  appliedAt   DateTime? // åº”ç”¨æ—¶é—´

  // å¯¹è¯æ¶ˆæ¯ï¼ˆJSONå­˜å‚¨ï¼Œé¿å…å¤æ‚è¡¨ç»“æ„ï¼‰
  // æ ¼å¼: [{id, role: "user"|"assistant"|"system", content, timestamp}]
  messages    Json     @default("[]")

  // å…ƒæ•°æ®
  messageCount Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([recordId])
  @@index([status])
  @@map("prompt_conversations")
}

// ============================================
// Login Page Configuration
// ============================================

model LoginPageConfig {
  id              String      @id @default(uuid())

  // Logo Configuration
  logoUrl         String?     // Custom logo image URL
  logoEmoji       String      @default("ğŸ­ï¸")

  // Title & Subtitle
  title           String      @default("æ­å·é¾™æ˜“AIç³»ç»Ÿ")
  subtitle1       String      @default("ç”µå•†AIè·µè¡Œä¸­")
  subtitle2       String      @default("AIæ™ºèƒ½ Â· æµ·æŠ¥ç”Ÿæˆ Â· åœºæ™¯åˆ›ä½œ")

  // Form Labels
  passwordLabel   String      @default("VIPå¯†ç ")
  passwordPlaceholder  String  @default("è¯·è¾“å…¥VIPå¯†ç ")
  buttonText      String      @default("èŠéº»å¼€é—¨")
  buttonLoadingText   String  @default("éªŒè¯ä¸­...")

  // Footer Information
  footerText      String      @default("ğŸ”’ ç³»ç»Ÿå·²å¯ç”¨è®¿é—®å¯†ç ä¿æŠ¤")
  copyrightText   String      @default("Â© 2026 æ­å·é¾™æ˜“ç§‘æŠ€ Â· v1.0.0")

  // Background Image
  backgroundImageUrl   String? // Custom background image URL
  backgroundStyle      String  @default("tech-ai") // tech-ai, neural-network, data-flow, etc.

  // Status
  isActive        Boolean     @default(true)

  // Metadata
  createdBy       String?     // User ID who created/updated
  updatedBy       String?     // User ID who last updated
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("login_page_config")
}
