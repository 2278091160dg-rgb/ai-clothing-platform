# 🔧 双轨工作流配置指南 v2.0

## 📅 日期：2026-01-29

## 🎯 基于实际架构的完整配置方案

---

## 📋 工作流文件清单

### ✅ 已创建的文件

1. **`AI服装平台-前端触发-同步飞书.json`**
   - 轨道：前端触发流程
   - 节点数：12个
   - 关键特性：包含飞书创建记录节点

2. **`AI服装平台-飞书触发-独立流程.json`**
   - 轨道：飞书触发流程
   - 节点数：13个
   - 关键特性：包含飞书读取和更新记录节点

---

## 🚀 快速开始

### 步骤1：导入工作流

1. 登录你的N8N实例
2. 点击右上角 **"Import from File"** 或 **"从文件导入"**
3. 分别导入2个JSON文件
4. 保存工作流

### 步骤2：配置凭证

#### 凭证1：DeerAPI account

**用途**：调用AI图片生成API
**使用位置**：工作流1 + 工作流2

**配置步骤**：

1. 在N8N中进入 **Credentials** → **New**
2. 选择 **Header Auth**
3. 名称填写：`DeerAPI account`
4. 配置：
   - **Name**: `Authorization`
   - **Value**: `Bearer YOUR_DEERAPI_KEY`
5. 保存

**获取DeerAPI Key**：

- 访问：https://www.deerapi.com/
- 注册账号并获取API密钥

#### 凭证2：Feishu Credentials account

**用途**：读取/更新飞书记录
**使用位置**：仅工作流2 + 工作流1的创建记录节点

**配置步骤**：

1. 在N8N中进入 **Credentials** → **New**
2. 选择 **Feishu Credentials API** 或 **Header Auth**
3. 名称填写：`Feishu Credentials account`
4. 配置：
   - **App ID**: `cli_xxxxxxxxxxxx`
   - **App Secret**: `xxxxxxxxxxxxxxxx`
5. 保存

**获取飞书凭证**：

- 访问：https://open.feishu.cn/app
- 创建应用并获取凭证

#### 凭证3：Webhook Auth（可选）

**用途**：验证前端请求
**使用位置**：仅工作流1

**配置步骤**：

1. 在N8N中进入 **Credentials** → **New**
2. 选择 **Header Auth**
3. 名称填写：`Webhook Auth`
4. 配置：
   - **Name**: `X-Webhook-Token`
   - **Value**: `your-webhook-secret-token`
5. 保存

#### 凭证4：Callback Auth（可选）

**用途**：回调前端API时的认证
**使用位置**：仅工作流1

**配置步骤**：

1. 在N8N中进入 **Credentials** → **New**
2. 选择 **Header Auth**
3. 名称填写：`Callback Auth`
4. 配置：
   - **Name**: `X-Callback-Token`
   - **Value**: `your-callback-secret-token`
5. 保存

---

## 🔧 工作流1：前端触发 - 详细配置

### 节点1：【Webhook】接收前端请求

**配置**：

- **HTTP Method**: POST
- **Path**: `ai-clothing-frontend`
- **Response Mode**: Using 'Respond to Webhook' Node

**获取Webhook URL**：

1. 点击节点右上角 **"Production URL"**
2. 复制URL，格式：`https://your-n8n.com/webhook/ai-clothing-frontend`
3. 更新到前端环境变量：`N8N_WEBHOOK_URL`

### 节点2：【鉴权】验证请求

**配置**：

- **凭证**：Webhook Auth（可选）
- **验证方式**：Header Auth

### 节点3：提取请求参数

**无需配置** - 自动提取以下参数：

```json
{
  "taskId": "uuid-xxx",
  "userId": "user-xxx",
  "mode": "scene",
  "prompt": "红色连衣裙",
  "productImageUrl": "https://...",
  "sceneImageUrl": "https://...",
  "aiModel": "Gemini-3-Pro-Image",
  "aspectRatio": "3:4",
  "imageCount": 4,
  "quality": "high"
}
```

### 节点4：判断比例并设置尺寸

**配置**：

- **9:16** → 720x1280
- **3:4** → 768x1024
- **1:1** → 1024x1024
- **16:9** → 1280x720

### 节点5-6：下载图片

- **下载商品图片**：从 `productImageUrl` 下载
- **下载场景图片**：从 `sceneImageUrl` 下载（可选）

### 节点7：【DeerAPI】AI图片生成 ⭐

**配置**：

- **URL**: `https://api.deerapi.com/v1/ai/generate`
- **Method**: POST
- **凭证**：DeerAPI account
- **Body Parameters**:
  ```json
  {
    "model": "Gemini-3-Pro-Image",
    "prompt": "{{提示词}}",
    "image": "{{商品图二进制}}",
    "image2": "{{场景图二进制（可选）}}",
    "aspect_ratio": "{{比例}}",
    "num_images": {{数量}},
    "resolution": "1K"
  }
  ```

### 节点8：提取生成结果

**无需配置** - 自动提取：

- `resultImageUrls`: 生成的图片URL数组
- `imageCount`: 生成数量

### 节点9：【DeerAPI】上传结果图

**配置**：

- **URL**: `https://api.deerapi.com/v1/upload`
- **Method**: POST
- **凭证**：DeerAPI account
- **批量上传**：逐个上传生成的图片

### 节点10：【飞书】创建记录 ⭐（关键）

**配置**：

- **操作**：createRecord
- **凭证**：Feishu Credentials account
- **App Token**: `app_xxx`（修改为你的）
- **Table ID**: `tbl_xxx`（修改为你的）
- **Fields**:
  ```json
  {
    "提示词": "{{prompt}}",
    "商品图片": "{{productImageUrl}}",
    "场景图": "{{sceneImageUrl}}",
    "AI模型": "{{aiModel}}",
    "尺寸比例": "{{aspectRatio}}",
    "生成数量": {{imageCount}},
    "生成结果": "{{uploadedUrls}}",
    "状态": "✅ 已完成"
  }
  ```

### 节点11：【回调】通知前端

**配置**：

- **URL**: `{{callbackUrl}}`（从前端请求中获取）
- **Method**: POST
- **凭证**：Callback Auth（可选）
- **Body**:
  ```json
  {
    "taskId": "{{taskId}}",
    "status": "completed",
    "resultImageUrls": "{{uploadedUrls}}",
    "progress": 100,
    "feishuRecordId": "{{recordId}}"
  }
  ```

### 节点12：【响应】返回成功

**配置**：

- **Response Body**:
  ```json
  {
    "success": true,
    "message": "任务已完成",
    "taskId": "{{taskId}}",
    "resultImageUrls": "{{uploadedUrls}}"
  }
  ```

---

## 🔧 工作流2：飞书触发 - 详细配置

### 节点1：【Webhook】接收飞书自动化

**配置**：

- **HTTP Method**: POST
- **Path**: `ai-clothing-feishu`
- **Response Mode**: Using 'Respond to Webhook' Node

**获取Webhook URL**：

1. 点击节点右上角 **"Production URL"**
2. 复制URL，格式：`https://your-n8n.com/webhook/ai-clothing-feishu`
3. 配置到飞书自动化（见下方）

### 节点2：提取触发信息

**无需配置** - 自动提取：

- `app_token`: 飞书应用Token
- `table_id`: 飞书表格ID
- `record_id`: 触发的记录ID

### 节点3：【飞书】获取记录详情 ⭐

**配置**：

- **操作**：getRecord
- **凭证**：Feishu Credentials account
- **App Token**: `{{app_token}}`
- **Table ID**: `{{table_id}}`
- **Record ID**: `{{record_id}}`

### 节点4：提取记录字段 ⭐（关键）

**配置**：从飞书记录中提取：

```javascript
{
  "prompt": "{{ $json.data.records[0].fields['提示词'][0].text }}",
  "productImageUrl": "{{ $json.data.records[0].fields['商品图片'][0].url }}",
  "sceneImageUrl": "{{ $json.data.records[0].fields['场景图'] && $json.data.records[0].fields['场景图'][0].url || '' }}",
  "aiModel": "{{ $json.data.records[0].fields['AI模型'] || 'Gemini-3-Pro-Image' }}",
  "aspectRatio": "{{ $json.data.records[0].fields['尺寸比例'] || '3:4' }}",
  "imageCount": "{{ $json.data.records[0].fields['生成数量'] || 4 }}"
}
```

### 节点5：【飞书】更新状态-处理中

**配置**：

- **操作**：updateRecord
- **凭证**：Feishu Credentials account
- **Fields**:
  ```json
  {
    "状态": "⏳ 处理中"
  }
  ```

### 节点6：判断比例并设置尺寸

同工作流1

### 节点7-8：下载图片

同工作流1

### 节点9：【DeerAPI】AI图片生成

同工作流1

### 节点10：提取生成结果

同工作流1

### 节点11：【DeerAPI】上传结果图

同工作流1

### 节点12：【飞书】更新记录-完成 ⭐（关键）

**配置**：

- **操作**：updateRecord
- **凭证**：Feishu Credentials account
- **Fields**:
  ```json
  {
    "生成结果": "{{uploadedUrls}}",
    "状态": "✅ 已完成"
  }
  ```

### 节点13：【响应】返回成功

**配置**：

- **Response Body**:
  ```json
  {
    "success": true,
    "message": "飞书记录已更新",
    "recordId": "{{recordId}}"
  }
  ```

---

## 📱 飞书自动化配置

### 配置飞书自动化（工作流2触发）

**目的**：当用户点击飞书表格中的"点击按钮"时，自动调用N8N工作流2

**步骤**：

1. **打开飞书多维表格**
   - 进入你的多维表格
   - 点击右上角 **"自动化"** 标签

2. **创建新自动化**
   - 点击 **"+ 新建自动化"**
   - 名称：`AI生图触发`

3. **配置触发器**
   - 选择 **"当记录被更改时"**
   - 选择你的表格
   - 监听字段：`点击按钮`

4. **配置操作**
   - 添加操作：**"发送请求"**
   - 请求类型：**POST**
   - URL：填入N8N工作流2的Webhook URL
   - Headers：
     ```json
     {
       "Content-Type": "application/json"
     }
     ```
   - Body：
     ```json
     {
       "app_token": "{{app_token}}",
       "table_id": "{{table_id}}",
       "record_id": "{{record_id}}"
     }
     ```

5. **启用自动化**
   - 点击右上角 **"开启"**
   - 测试：点击表格中的"点击按钮"，查看是否触发

---

## 🧪 测试验证

### 测试1：前端轨道

**测试命令**：

```bash
curl -X POST https://your-n8n.com/webhook/ai-clothing-frontend \
  -H "Content-Type: application/json" \
  -H "X-Webhook-Token: your-webhook-secret-token" \
  -d '{
    "taskId": "test-frontend-001",
    "userId": "test-user",
    "mode": "scene",
    "prompt": "时尚模特在现代咖啡厅",
    "productImageUrl": "https://picsum.photos/300/300",
    "sceneImageUrl": "https://picsum.photos/301/301",
    "aiModel": "Gemini-3-Pro-Image",
    "aspectRatio": "3:4",
    "imageCount": 2,
    "quality": "high",
    "callbackUrl": "https://your-app.com/api/webhooks/n8n/callback"
  }'
```

**验证点**：

- ✅ N8N收到请求
- ✅ DeerAPI生成成功
- ✅ 飞书记录已创建
- ✅ 前端收到回调

### 测试2：飞书轨道

**测试步骤**：

1. 在飞书表格中填写：
   - 提示词：`测试提示词`
   - 商品图片：上传一张图片
   - 场景图：上传一张图片（可选）
   - AI模型：`Gemini-3-Pro-Image`
   - 尺寸比例：`3:4`
   - 生成数量：`2`

2. 点击"点击按钮"

**验证点**：

- ✅ N8N收到请求
- ✅ 飞书记录状态变为"⏳ 处理中"
- ✅ DeerAPI生成成功
- ✅ 飞书记录状态变为"✅ 已完成"
- ✅ 生成结果字段有图片

---

## ❓ 常见问题

### Q1: 飞书创建记录失败

**错误**：`Field not found`

**原因**：字段名称不匹配

**解决**：

1. 确认飞书表格字段名称完全一致
2. 注意：`提示词` 不是 `提示 ` 或 `提示词：`
3. 检查字段类型是否正确

### Q2: DeerAPI调用失败

**错误**：`Unauthorized`

**原因**：API密钥错误

**解决**：

1. 确认DeerAPI凭证配置正确
2. 检查API密钥是否有效
3. 确认凭证已关联到节点

### Q3: 飞书自动化不触发

**原因**：自动化未启用或配置错误

**解决**：

1. 确认自动化已开启
2. 检查Webhook URL是否正确
3. 查看飞书自动化日志

### Q4: 图片下载失败

**错误**：`Cannot download image`

**原因**：图片URL不可访问

**解决**：

1. 确认图片URL可公开访问
2. 检查是否有CORS限制
3. 确认N8N服务器有网络访问权限

---

## 📝 配置检查清单

### 凭证配置

- [ ] DeerAPI account 已创建
- [ ] Feishu Credentials account 已创建
- [ ] Webhook Auth 已创建（可选）
- [ ] Callback Auth 已创建（可选）

### 工作流1配置

- [ ] Webhook URL已复制并更新到前端
- [ ] DeerAPI凭证已关联到AI生成节点
- [ ] DeerAPI凭证已关联到上传节点
- [ ] Feishu凭证已关联到创建记录节点
- [ ] App Token和Table ID已修改
- [ ] 所有连线已验证

### 工作流2配置

- [ ] Webhook URL已复制并配置到飞书自动化
- [ ] Feishu凭证已关联到读取记录节点
- [ ] Feishu凭证已关联到更新记录节点（2个）
- [ ] DeerAPI凭证已关联到AI生成节点
- [ ] DeerAPI凭证已关联到上传节点
- [ ] 所有连线已验证

### 飞书配置

- [ ] 自动化已创建
- [ ] 触发条件已配置（点击按钮）
- [ ] Webhook URL已配置
- [ ] 自动化已启用

### 测试验证

- [ ] 前端轨道测试成功
- [ ] 飞书轨道测试成功
- [ ] 飞书记录创建成功
- [ ] 飞书记录更新成功

---

## 🎯 完成后的下一步

1. **监控N8N执行日志**
   - 查看 **Executions** 标签
   - 确认所有节点执行成功

2. **检查飞书表格**
   - 确认记录创建成功
   - 确认字段数据正确

3. **测试完整流程**
   - 前端提交任务
   - 飞书表格操作
   - 验证结果一致性

---

_配置指南版本: v2.0_
_创建时间: 2026-01-29_
_基于: .clauderules 宪法文件_
