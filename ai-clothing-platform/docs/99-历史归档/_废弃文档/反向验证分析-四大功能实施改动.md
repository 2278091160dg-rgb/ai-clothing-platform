# 🔍 反向验证分析 - 四大功能实施改动清单

## 📅 分析日期：2026-01-29

---

## 🎯 分析目的

基于新识别的**4大功能需求**，反向验证系统各部分需要进行的改动：

1. **功能1**: 服装白底图上身试穿（虚拟试衣）
2. **功能2**: 鞋包穿戴搭配（智能穿戴）
3. **功能3**: 自由搭配组合生图（批量搭配）
4. **功能4**: 产品场景生图（已实现）

---

## 📊 改动影响矩阵

```
┌─────────────────────────────────────────────────────────────────────┐
│                         改动影响矩阵                                  │
├──────────────┬──────────────────────────────────────────────────────┤
│              │ 功能1 │ 功能2 │ 功能3 │ 功能4 │ 改动等级 │
│              │ 虚拟试衣 │ 智能穿戴 │ 自由搭配 │ 场景生图 │          │
├──────────────┼────────┼────────┼────────┼────────┼──────────┤
│ 前端界面     │   ⭐⭐⭐⭐⭐  │  ⭐⭐⭐⭐⭐  │  ⭐⭐⭐⭐⭐  │  ⭐⭐    │  P0 必须改 │
│ API接口      │   ⭐⭐⭐⭐⭐  │  ⭐⭐⭐⭐⭐  │  ⭐⭐⭐⭐⭐  │  ⭐⭐    │  P0 必须改 │
│ N8N工作流    │   ⭐⭐⭐⭐⭐  │  ⭐⭐⭐⭐⭐  │  ⭐⭐⭐⭐   │  ⭐     │  P0 必须改 │
│ DeerAPI调用  │   ⭐⭐⭐⭐⭐  │  ⭐⭐⭐⭐⭐  │  ⭐⭐⭐⭐   │  ⭐     │  P0 必须改 │
│ 提示词模板   │   ⭐⭐⭐⭐   │  ⭐⭐⭐⭐   │  ⭐⭐⭐⭐   │  ⭐⭐⭐  │  P1 推荐改 │
│ 飞书字段     │   ⭐⭐⭐    │  ⭐⭐⭐    │  ⭐⭐⭐    │  ⭐⭐   │  P1 推荐改 │
│ 数据库Schema │   ⭐⭐⭐    │  ⭐⭐⭐    │  ⭐⭐⭐    │  ⭐⭐   │  P1 推荐改 │
├──────────────┴────────┴────────┴────────┴────────┴──────────┤
│ 总结：前端/API/N8N/DeerAPI都需要重大改动                            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 1️⃣ 前端界面改动

### 影响等级: ⭐⭐⭐⭐⭐ P0 必须修改

### 当前状态

只有**功能4（场景生图）**的界面，如图4所示。

### 需要新增的内容

#### 1. 顶部模式选择器（新增）

```tsx
// 位置：页面顶部，商品图上传之前
<div className="mode-selector">
  <h3>📷 选择生成模式</h3>
  <div className="mode-grid">
    <button className={mode === 'scene' ? 'active' : ''} onClick={() => setMode('scene')}>
      <span>🏞️</span>
      <div>场景生图</div>
      <div className="mode-desc">商品+场景图生成</div>
    </button>
    <button className={mode === 'tryon' ? 'active' : ''} onClick={() => setMode('tryon')}>
      <span>👔</span>
      <div>虚拟试衣</div>
      <div className="mode-desc">服装上身试穿</div>
    </button>
    <button className={mode === 'wear' ? 'active' : ''} onClick={() => setMode('wear')}>
      <span>👟</span>
      <div>智能穿戴</div>
      <div className="mode-desc">鞋包配饰穿戴</div>
    </button>
    <button className={mode === 'combine' ? 'active' : ''} onClick={() => setMode('combine')}>
      <span>🎨</span>
      <div>自由搭配</div>
      <div className="mode-desc">多素材组合生图</div>
    </button>
  </div>
</div>
```

#### 2. 动态表单区域（重构）

根据选择的模式，显示不同的表单：

```tsx
// 根据mode动态渲染表单
switch (mode) {
  case 'scene':
    return <SceneGenerationForm />; // 已有，保持不变
  case 'tryon':
    return <VirtualTryOnForm />; // 新增
  case 'wear':
    return <SmartWearingForm />; // 新增
  case 'combine':
    return <FreeCombinationForm />; // 新增
}
```

#### 3. 新增表单组件

**组件1: VirtualTryOnForm.tsx（虚拟试衣）**

```tsx
export function VirtualTryOnForm() {
  return (
    <div className="form-section">
      <h3>👔 虚拟试衣 - 服装上身试穿</h3>

      {/* 第一步：上传服装图 */}
      <div className="upload-section">
        <label>第一步：上传服装图（必填）</label>
        <Uploader
          id="clothing-image"
          accept="image/*"
          maxSize="15M"
          minSize="20K"
          placeholder="📁 上传服装白底图"
        />
        <p className="hint">支持：JPG/PNG/HEIC/WebP, 20K-15M</p>
      </div>

      {/* 第二步：选择参考图 */}
      <div className="upload-section">
        <label>第二步：选择参考图（可选，推荐）</label>
        <Uploader
          id="reference-image"
          accept="image/*"
          maxSize="15M"
          placeholder="🖼️ 选择姿势参考图"
          optional
        />
        <p className="hint">用于指定试穿姿势（推荐上传）</p>
      </div>

      {/* 第三步：选择模特 */}
      <div className="upload-section">
        <label>第三步：选择模特（可选）</label>
        <Uploader
          id="model-image"
          accept="image/*"
          maxSize="15M"
          placeholder="👤 选择模特形象"
          optional
        />
        <p className="hint">指定试穿模特（会增加1分钟生成时间）</p>
      </div>

      {/* 第四步：试穿设置 */}
      <div className="settings-section">
        <label>试穿模式</label>
        <RadioGroup name="tryon-mode" defaultValue="single">
          <RadioButton value="single">单件试穿</RadioButton>
          <RadioButton value="multi">多件试穿</RadioButton>
        </RadioGroup>
      </div>

      {/* 生成按钮 */}
      <button className="btn-primary">🎨 开始试穿</button>
    </div>
  );
}
```

**组件2: SmartWearingForm.tsx（智能穿戴）**

```tsx
export function SmartWearingForm() {
  return (
    <div className="form-section">
      <h3>👟 智能穿戴 - 鞋包配饰穿戴</h3>

      {/* 第一步：上传商品图 */}
      <div className="upload-section">
        <label>第一步：上传商品图（必填）</label>
        <Uploader
          id="product-image"
          accept="image/*"
          maxSize="15M"
          placeholder="📁 上传商品图（鞋/包/表）"
        />
      </div>

      {/* 第二步：选择参考图 */}
      <div className="upload-section">
        <label>第二步：选择参考图（必填）</label>
        <Uploader
          id="reference-image"
          accept="image/*"
          maxSize="15M"
          placeholder="🖼️ 选择姿势参考图"
        />
        <p className="hint">需要包含姿势和场景</p>
      </div>

      {/* 第三步：商品类型 */}
      <div className="select-section">
        <label>商品类型</label>
        <Select name="product-type" defaultValue="shoes">
          <option value="shoes">👟 鞋类</option>
          <option value="bag">👜 包类</option>
          <option value="watch">⌚ 手表</option>
          <option value="jewelry">💍 首饰</option>
          <option value="hat">🧢 帽子</option>
          <option value="scarf">🧣 围巾</option>
        </Select>
      </div>

      {/* 第四步：视角设置 */}
      <div className="settings-section">
        <label>视角</label>
        <RadioGroup name="view-type" defaultValue="single">
          <RadioButton value="single">单视角图</RadioButton>
          <RadioButton value="multi">多视角图</RadioButton>
        </RadioGroup>
      </div>

      <button className="btn-primary">🎨 开始穿戴</button>
    </div>
  );
}
```

**组件3: FreeCombinationForm.tsx（自由搭配）**

```tsx
export function FreeCombinationForm() {
  return (
    <div className="form-section">
      <h3>🎨 自由搭配 - 多素材组合生图</h3>

      {/* 第一步：上传多个素材 */}
      <div className="upload-section">
        <label>第一步：上传素材（1-9张）</label>
        <MultiUploader
          id="material-images"
          accept="image/*"
          maxSize="15M"
          minCount={1}
          maxCount={9}
          placeholder="点击上传素材"
        />
        <p className="hint">支持：JPG/PNG/HEIC/WebP, 20K-15M/张</p>
      </div>

      {/* 第二步：搭配设置 */}
      <div className="settings-section">
        <div className="form-row">
          <div className="form-col">
            <label>搭配数量</label>
            <Select name="combination-count" defaultValue="4">
              <option value="2">2种搭配</option>
              <option value="4">4种搭配</option>
              <option value="6">6种搭配</option>
              <option value="9">9种搭配</option>
            </Select>
          </div>
          <div className="form-col">
            <label>模特类型</label>
            <Select name="model-type" defaultValue="any">
              <option value="any">不限</option>
              <option value="adult">成人</option>
              <option value="child">儿童</option>
              <option value="male">男性</option>
              <option value="female">女性</option>
            </Select>
          </div>
        </div>
        <div className="form-col">
          <label>风格偏好</label>
          <Select name="style-preference" defaultValue="casual">
            <option value="casual">休闲</option>
            <option value="formal">正式</option>
            <option value="sporty">运动</option>
            <option value="elegant">优雅</option>
          </Select>
        </div>
      </div>

      <p className="info-tip">
        💡 AI将自动融合多种搭配，生成<span>4</span>张模特图
      </p>

      <button className="btn-primary">🎨 开始搭配生成</button>
    </div>
  );
}
```

### 文件改动清单

| 文件                                           | 改动类型 | 说明                     |
| ---------------------------------------------- | -------- | ------------------------ |
| `src/app/create/page.tsx`                      | 修改     | 添加mode状态和模式选择器 |
| `src/components/forms/SceneGenerationForm.tsx` | 新建     | 将现有表单提取为独立组件 |
| `src/components/forms/VirtualTryOnForm.tsx`    | 新建     | 虚拟试衣表单             |
| `src/components/forms/SmartWearingForm.tsx`    | 新建     | 智能穿戴表单             |
| `src/components/forms/FreeCombinationForm.tsx` | 新建     | 自由搭配表单             |

---

## 2️⃣ API接口改动

### 影响等级: ⭐⭐⭐⭐⭐ P0 必须修改

### 当前API接口

```typescript
// 只支持场景生成
interface CreateTaskRequest {
  productImage: string;
  sceneImage?: string;
  prompt: string;
  aspectRatio: '3:4' | '1:1' | '16:9';
  aiModel: string;
}
```

### 修改后的API接口

```typescript
// 新增mode参数，根据mode有不同的必填字段
interface CreateTaskRequest {
  // === 通用参数（所有模式都需要） ===
  mode: 'scene' | 'tryon' | 'wear' | 'combine'; // NEW
  aiModel: string;
  aspectRatio?: '3:4' | '1:1' | '16:9';

  // === 模式1：场景生图 ===
  productImage?: string; // 场景模式：商品图
  sceneImage?: string; // 场景模式：场景图
  prompt?: string; // 场景模式：提示词

  // === 模式2：虚拟试衣 ===
  clothingImage?: string; // 试衣模式：服装图
  tryonReferenceImage?: string; // 试衣模式：参考图
  tryonModelImage?: string; // 试衣模式：模特图
  tryonMode?: 'single' | 'multi'; // 试衣模式：单件/多件

  // === 模式3：智能穿戴 ===
  wearProductImage?: string; // 穿戴模式：商品图
  wearReferenceImage?: string; // 穿戴模式：参考图
  productType?: 'shoes' | 'bag' | 'watch' | 'jewelry' | 'hat' | 'scarf';
  viewType?: 'single' | 'multi';

  // === 模式4：自由搭配 ===
  materialImages?: string[]; // 搭配模式：素材数组（1-9张）
  combinationCount?: number; // 搭配模式：搭配数量
  modelType?: 'adult' | 'child' | 'male' | 'female' | 'any';
  stylePreference?: 'casual' | 'formal' | 'sporty' | 'elegant';

  // === AI优化相关（所有模式） ===
  promptSource?: 'USER' | 'TEMPLATE' | 'AI_OPTIMIZED' | 'FEISHU';
  optimizedPrompt?: string;
}
```

### API路由文件改动

**文件**: `src/app/api/tasks/route.ts`

```typescript
export async function POST(request: Request) {
  const body: CreateTaskRequest = await request.json();

  // 根据mode参数分发到不同的处理逻辑
  switch (body.mode) {
    case 'scene':
      return await handleSceneGeneration(body);
    case 'tryon':
      return await handleVirtualTryOn(body);
    case 'wear':
      return await handleSmartWearing(body);
    case 'combine':
      return await handleFreeCombination(body);
    default:
      return NextResponse.json({ error: 'Invalid mode' }, { status: 400 });
  }
}

// 场景生成处理（已有）
async function handleSceneGeneration(params: any) {
  // 现有逻辑
}

// 虚拟试衣处理（新增）
async function handleVirtualTryOn(params: any) {
  // 验证必填参数
  if (!params.clothingImage) {
    throw new Error('服装图不能为空');
  }

  // 构建试衣提示词
  const prompt = buildVirtualTryOnPrompt({
    clothingImage: params.clothingImage,
    referenceImage: params.tryonReferenceImage,
    modelImage: params.tryonModelImage,
    mode: params.tryonMode,
  });

  // 发送到N8N
  // ...
}

// 智能穿戴处理（新增）
async function handleSmartWearing(params: any) {
  // 验证必填参数
  if (!params.wearProductImage || !params.wearReferenceImage) {
    throw new Error('商品图和参考图不能为空');
  }

  // 构建穿戴提示词
  const prompt = buildSmartWearingPrompt({
    productImage: params.wearProductImage,
    referenceImage: params.wearReferenceImage,
    productType: params.productType,
  });

  // 发送到N8N
  // ...
}

// 自由搭配处理（新增）
async function handleFreeCombination(params: any) {
  // 验证必填参数
  if (!params.materialImages || params.materialImages.length === 0) {
    throw new Error('素材图不能为空');
  }

  // 构建搭配提示词
  const prompt = buildFreeCombinationPrompt({
    materials: params.materialImages,
    count: params.combinationCount,
    modelType: params.modelType,
    style: params.stylePreference,
  });

  // 发送到N8N
  // ...
}
```

### 文件改动清单

| 文件                                           | 改动类型 | 说明             |
| ---------------------------------------------- | -------- | ---------------- |
| `src/app/api/tasks/route.ts`                   | 修改     | 添加mode路由逻辑 |
| `src/lib/prompts/virtual-tryon.template.ts`    | 新建     | 虚拟试衣提示词   |
| `src/lib/prompts/smart-wearing.template.ts`    | 新建     | 智能穿戴提示词   |
| `src/lib/prompts/free-combination.template.ts` | 新建     | 自由搭配提示词   |

---

## 3️⃣ N8N工作流改动

### 影响等级: ⭐⭐⭐⭐⭐ P0 必须修改

### 当前N8N工作流

```
前端Webhook → 解析参数 → AI生成 → 飞书记录 → 回调前端
```

### 修改后的N8N工作流

```
前端Webhook → 解析参数 → 根据mode分发 → 对应生成节点 → 飞书记录 → 回调前端
                                   ├─ 场景生成分支
                                   ├─ 虚拟试衣分支
                                   ├─ 智能穿戴分支
                                   └─ 自由搭配分支
```

### 详细改动

#### 1. "解析前端参数"节点（修改）

**位置**: Webhook之后

**改动**: 添加mode参数解析

```javascript
// 解析mode参数
const mode = $json.mode;

// 根据mode设置不同的默认值
const defaults = {
  scene: {
    requiredFields: ['productImage'],
    optionalFields: ['sceneImage', 'prompt'],
  },
  tryon: {
    requiredFields: ['clothingImage'],
    optionalFields: ['tryonReferenceImage', 'tryonModelImage'],
  },
  wear: {
    requiredFields: ['wearProductImage', 'wearReferenceImage'],
    optionalFields: [],
  },
  combine: {
    requiredFields: ['materialImages'],
    optionalFields: ['modelType', 'stylePreference'],
  },
};

// 验证必填字段
const required = defaults[mode].requiredFields;
const missing = required.filter(field => !$json[field]);

if (missing.length > 0) {
  throw new Error(`Mode ${mode}: Missing required fields: ${missing.join(', ')}`);
}

// 返回解析后的数据
return {
  ...$json,
  _mode: mode,
  _validated: true,
};
```

#### 2. "选择生成分支"节点（新增）

**位置**: "解析前端参数"之后

**类型**: Switch节点

**配置**:

```javascript
// 根据_mode分发到不同分支
switch ($json._mode) {
  case 'scene':
    return 0; // 输出到场景生成分支
  case 'tryon':
    return 1; // 输出到虚拟试衣分支
  case 'wear':
    return 2; // 输出到智能穿戴分支
  case 'combine':
    return 3; // 输出到自由搭配分支
  default:
    throw new Error(`Unknown mode: ${$json._mode}`);
}
```

#### 3. 四个生成分支（重构）

**分支1: 场景生成**（已有，保持不变）

```
选择生成分支 → [输出0] → 构建场景提示词 → DeerAPI生成 → 飞书记录 → 回调
```

**分支2: 虚拟试衣**（新增）

```
选择生成分支 → [输出1] → 构建试衣提示词 → DeerAPI试衣端点 → 飞书记录 → 回调
```

**节点1: 构建试衣提示词**（Code节点）

```javascript
// 构建虚拟试衣的提示词
const prompt = `# Virtual Try-On

## Task
Digitally fit the uploaded clothing onto the reference figure.

## Product
- Type: Clothing
- Image: {{$json.clothingImage}}

## Reference
{{$json.tryonReferenceImage ? `- Reference Image: ${$json.tryonReferenceImage}` : ''}}
{{$json.tryonModelImage ? `- Model Image: ${$json.tryonModelImage}` : ''}}

## Instructions
1. Maintain all original design elements
2. Adapt to figure pose naturally
3. Realistic fabric behavior

---

Professional virtual try-on, clothing fit to figure, realistic draping, photo quality, 8k resolution.`;

return {
  ...$json,
  finalPrompt: prompt,
  apiEndpoint: 'deerapi-tryon', // 不同的端点
};
```

**节点2: DeerAPI试衣**（HTTP Request节点）

```
Method: POST
URL: {{DEERAPI_BASE_URL}}/tryon
Authentication: Bearer Token
Body: {
  "prompt": {{$json.finalPrompt}},
  "clothing_image": {{$json.clothingImage}},
  "reference_image": {{$json.tryonReferenceImage}},
  "model_image": {{$json.tryonModelImage}},
  "aspect_ratio": "3:4"
}
```

**分支3: 智能穿戴**（新增）

```
选择生成分支 → [输出2] → 构建穿戴提示词 → DeerAPI穿戴端点 → 飞书记录 → 回调
```

**节点1: 构建穿戴提示词**（Code节点）

```javascript
// 构建智能穿戴的提示词
const productType = $json.productType || 'shoes';

const prompt = `# Product Wearing

## Task
Intelligently place the product onto the appropriate position.

## Product
- Type: ${productType}
- Image: {{$json.wearProductImage}}

## Reference
- Reference Image: {{$json.wearReferenceImage}}

## Instructions
1. Detect appropriate position (feet/shoulder/hand/etc.)
2. Natural integration
3. Size adaptation

---

Product wearing, ${productType} on figure, professional photography, 8k quality.`;

return {
  ...$json,
  finalPrompt: prompt,
  apiEndpoint: 'deerapi-wear',
};
```

**节点2: DeerAPI穿戴**（HTTP Request节点）

```
Method: POST
URL: {{DEERAPI_BASE_URL}}/wear
Body: {
  "prompt": {{$json.finalPrompt}},
  "product_image": {{$json.wearProductImage}},
  "reference_image": {{$json.wearReferenceImage}},
  "product_type": {{$json.productType}}
}
```

**分支4: 自由搭配**（新增）

```
选择生成分支 → [输出3] → 构建搭配提示词 → DeerAPI搭配端点 → 飞书记录 → 回调
```

**节点1: 构建搭配提示词**（Code节点）

```javascript
// 构建自由搭配的提示词
const materials = $json.materialImages || [];
const count = $json.combinationCount || 4;

const prompt = `# Free Combination

## Task
Create ${count} unique outfit combinations from uploaded materials.

## Materials
${materials.map((m, i) => `- Item ${i + 1}: ${m}`).join('\n')}

## Instructions
1. Generate ${count} distinct combinations
2. Style cohesion within each combination
3. Variety across combinations
4. Professional model photography

---

Professional fashion photography, outfit combinations, ${count} different looks, high quality, 8k resolution.`;

return {
  ...$json,
  finalPrompt: prompt,
  apiEndpoint: 'deerapi-combine',
  combinationCount: count,
};
```

**节点2: DeerAPI搭配**（HTTP Request节点）

```
Method: POST
URL: {{DEERAPI_BASE_URL}}/combine
Body: {
  "prompt": {{$json.finalPrompt}},
  "materials": {{$json.materialImages}},
  "count": {{$json.combinationCount}}
}
```

#### 4. "创建飞书记录"节点（修改）

**位置**: 所有生成分支之后，合并点

**改动**: 添加mode字段

```javascript
// 创建飞书记录
const feishuData = {
  // ... 现有字段
  mode: $json._mode, // NEW: 生成模式

  // 根据mode添加特定字段
  ...($json._mode === 'tryon' && {
    clothingImage: $json.clothingImage,
    tryonMode: $json.tryonMode,
  }),
  ...($json._mode === 'wear' && {
    productImage: $json.wearProductImage,
    productType: $json.productType,
  }),
  ...($json._mode === 'combine' && {
    materialCount: $json.materialImages?.length,
    combinationCount: $json.combinationCount,
  }),
};

return feishuData;
```

### N8N工作流改动清单

| 节点             | 改动类型 | 说明                          |
| ---------------- | -------- | ----------------------------- |
| "解析前端参数"   | 修改     | 添加mode参数解析和验证        |
| "选择生成分支"   | 新增     | Switch节点，分发到4个分支     |
| "构建场景提示词" | 保持     | 现有逻辑                      |
| "构建试衣提示词" | 新增     | Code节点                      |
| "构建穿戴提示词" | 新增     | Code节点                      |
| "构建搭配提示词" | 新增     | Code节点                      |
| "DeerAPI生成"    | 重构     | 分为4个不同的HTTP Request节点 |
| "创建飞书记录"   | 修改     | 添加mode字段                  |

---

## 4️⃣ DeerAPI调用改动

### 影响等级: ⭐⭐⭐⭐⭐ P0 必须修改

### 核心问题：DeerAPI是否支持这些功能？

⚠️ **这是最关键的问题！** 需要确认DeerAPI是否支持：

1. **虚拟试衣功能**（Virtual Try-On）
2. **智能穿戴功能**（Product Wearing）
3. **自由搭配功能**（Free Combination）

### 可能的情况

#### 情况A: DeerAPI全部支持 ✅

如果DeerAPI支持这3个新功能：

**改动**: 只需调用不同的API端点

```typescript
// 根据mode选择端点
const endpoints = {
  scene: `${DEERAPI_BASE_URL}/generate`,
  tryon: `${DEERAPI_BASE_URL}/tryon`,
  wear: `${DEERAPI_BASE_URL}/wear`,
  combine: `${DEERAPI_BASE_URL}/combine`,
};

const response = await fetch(endpoints[mode], {
  method: 'POST',
  headers: {
    Authorization: `Bearer ${API_KEY}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(requestBody),
});
```

#### 情况B: DeerAPI部分支持 ⚠️

如果DeerAPI只支持部分功能（例如只支持试衣，不支持穿戴和搭配）：

**改动**: 需要整合其他AI服务

```typescript
// 根据mode选择不同的AI服务
const services = {
  scene: {
    endpoint: DEERAPI_BASE_URL,
    supported: true,
  },
  tryon: {
    endpoint: DEERAPI_BASE_URL,
    supported: true,
  },
  wear: {
    endpoint: 'OTHER_AI_SERVICE_URL', // 切换到其他服务
    supported: true,
  },
  combine: {
    endpoint: DEERAPI_BASE_URL,
    supported: false, // 不支持，需要提示用户
  },
};

if (!services[mode].supported) {
  throw new Error(`Mode ${mode} is not currently supported`);
}
```

#### 情况C: DeerAPI全部不支持 ❌

如果DeerAPI只支持基础场景生成，不支持3个新功能：

**方案1**: 完全切换到其他AI服务（例如：绘蛙平台的API）

**方案2**: 提示用户这3个功能暂不可用

```typescript
// 在前端禁用不支持的功能
<button disabled={mode === 'tryon' && !isTryOnSupported}>
  👔 虚拟试衣
  <span className="badge">即将推出</span>
</button>
```

### ⚠️ 必须确认的问题

请确认以下问题：

1. **DeerAPI是否支持虚拟试衣功能？**
   - 如果支持，API端点是什么？
   - 请求参数格式是什么？

2. **DeerAPI是否支持智能穿戴功能？**
   - 如果支持，如何指定商品类型（鞋/包/表）？
   - 响应格式是什么？

3. **DeerAPI是否支持自由搭配功能？**
   - 如果支持，最多支持多少个素材？
   - 如何指定搭配数量？

4. **如果不支持，是否有替代方案？**
   - 是否可以集成绘蛙平台的API？
   - 是否有其他AI服务可以使用？

---

## 5️⃣ 提示词模板改动

### 影响等级: ⭐⭐⭐⭐ P1 推荐修改

### 新增提示词模板文件

| 文件                                           | 用途     | 说明                     |
| ---------------------------------------------- | -------- | ------------------------ |
| `src/lib/prompts/virtual-tryon.template.ts`    | 虚拟试衣 | 包含试衣相关的提示词结构 |
| `src/lib/prompts/smart-wearing.template.ts`    | 智能穿戴 | 包含穿戴相关的提示词结构 |
| `src/lib/prompts/free-combination.template.ts` | 自由搭配 | 包含搭配相关的提示词结构 |
| `src/lib/prompts/scene-generation.template.ts` | 场景生成 | 重构现有的提示词         |

### 提示词模板示例

#### virtual-tryon.template.ts

```typescript
export interface VirtualTryOnParams {
  clothingImage: string;
  referenceImage?: string;
  modelImage?: string;
  mode: 'single' | 'multi';
}

export function buildVirtualTryOnPrompt(params: VirtualTryOnParams): string {
  const { clothingImage, referenceImage, modelImage, mode } = params;

  return `# Virtual Try-On Prompt

## Task Definition
You are an AI virtual try-on specialist. Your task is to digitally fit the uploaded clothing item onto the reference figure.

## Product Analysis
- **Clothing Image**: ${clothingImage}
- **Try-On Mode**: ${mode}

## Reference Analysis
${referenceImage ? `- **Reference Image**: ${referenceImage}` : ''}
${modelImage ? `- **Model Image**: ${modelImage}` : ''}

## Try-On Instructions
1. **Maintain Design**: STRICTLY preserve all original design elements (color, pattern, logo, print)
2. **Natural Fit**: Adapt clothing to figure pose with realistic draping and wrinkles
3. **Seamless Blend**: Ensure natural transition between clothing and body
4. **Lighting Match**: Match lighting and shadows to reference image

## Quality Constraints
- Photo-realistic quality, no cartoon effects
- Accurate body proportions
- Natural fabric behavior (folds, drape, transparency)
- Consistent with reference image style

---

**Complete Generation Prompt:**

Professional virtual try-on, ${mode === 'single' ? 'single clothing item' : 'multiple clothing items'}, realistic fabric draping, natural fit to figure pose, maintain original design, photo-realistic, 8k quality, commercial fashion photography.`;
}
```

---

## 6️⃣ 飞书多维表格字段改动

### 影响等级: ⭐⭐⭐ P1 推荐修改

### 新增字段

| 字段名称     | 字段类型 | 说明                     | 必需 |
| ------------ | -------- | ------------------------ | ---- |
| **生成模式** | 单选     | scene/tryon/wear/combine | 推荐 |
| **服装图**   | 附件     | 试衣模式：服装图         | 可选 |
| **参考图**   | 附件     | 试衣/穿戴模式：参考图    | 可选 |
| **模特图**   | 附件     | 试衣模式：模特图         | 可选 |
| **商品类型** | 单选     | 穿戴模式：商品类型       | 可选 |
| **素材数量** | 数字     | 搭配模式：素材数量       | 可选 |
| **搭配数量** | 数字     | 搭配模式：搭配数量       | 可选 |

### 飞书字段配置详解

#### 字段1: 生成模式（推荐）

**配置**:

- 字段类型: 单选
- 选项:
  - 场景生图
  - 虚拟试衣
  - 智能穿戴
  - 自由搭配
- 默认值: 无

**用途**: 快速筛选不同模式的任务

#### 字段2: 服装图（可选）

**配置**:

- 字段类型: 附件
- 文件类型: 图片
- 数量限制: 单个或多个

**用途**: 试衣模式存储服装图

#### 字段3: 参考图（可选）

**配置**:

- 字段类型: 附件
- 文件类型: 图片
- 数量限制: 单个

**用途**: 试衣/穿戴模式的参考图

---

## 7️⃣ 数据库Schema改动

### 影响等级: ⭐⭐⭐ P1 推荐修改

### Schema修改

**文件**: `prisma/schema.prisma`

```prisma
model Task {
  id                String   @id @default(cuid())

  // === 通用字段 ===
  mode              GenerationMode @default(SCENE)
  status            TaskStatus @default(PENDING)
  createdAt         DateTime @default(now())
  completedAt       DateTime?

  // === 场景生成模式 ===
  productImageUrl   String?
  sceneImageUrl     String?
  prompt            String?

  // === 虚拟试衣模式 ===
  clothingImageUrl  String?
  tryonReferenceImageUrl  String?
  tryonModelImageUrl      String?
  tryonMode         TryOnMode?

  // === 智能穿戴模式 ===
  wearProductImageUrl      String?
  wearReferenceImageUrl    String?
  productType      ProductType?

  // === 自由搭配模式 ===
  materialImageUrls String[] // JSON array
  combinationCount Int?

  // === AI优化相关 ===
  promptSource      PromptSource @default(USER)
  optimizedPrompt   String?

  // === 结果 ===
  resultImageUrls  String[] // JSON array
}

enum GenerationMode {
  SCENE       // 场景生图
  TRYON       // 虚拟试衣
  WEAR        // 智能穿戴
  COMBINE     // 自由搭配
}

enum TryOnMode {
  SINGLE
  MULTI
}

enum ProductType {
  SHOES
  BAG
  WATCH
  JEWELRY
  HAT
  SCARF
}

enum TaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PromptSource {
  USER
  TEMPLATE
  AI_OPTIMIZED
  FEISHU
}
```

---

## 📋 完整改动清单总结

### 前端改动（P0）

| 组件                | 改动类型 | 工作量 |
| ------------------- | -------- | ------ |
| 模式选择器          | 新增     | 2小时  |
| SceneGenerationForm | 重构     | 1小时  |
| VirtualTryOnForm    | 新增     | 3小时  |
| SmartWearingForm    | 新增     | 3小时  |
| FreeCombinationForm | 新增     | 3小时  |
| 路由逻辑            | 修改     | 2小时  |

**小计**: 14小时

### API改动（P0）

| 文件       | 改动类型 | 工作量 |
| ---------- | -------- | ------ |
| `route.ts` | 修改     | 3小时  |
| 提示词模板 | 新增4个  | 4小时  |
| 参数验证   | 新增     | 2小时  |

**小计**: 9小时

### N8N改动（P0）

| 节点         | 改动类型  | 工作量 |
| ------------ | --------- | ------ |
| 解析参数节点 | 修改      | 1小时  |
| 分支节点     | 新增      | 1小时  |
| 4个生成分支  | 新增/修改 | 4小时  |
| 飞书记录节点 | 修改      | 1小时  |

**小计**: 7小时

### DeerAPI集成（P0）

| 任务     | 工作量 |
| -------- | ------ |
| API调研  | 2小时  |
| 接口对接 | 4小时  |
| 测试验证 | 2小时  |

**小计**: 8小时

### 飞书改动（P1）

| 任务          | 工作量 |
| ------------- | ------ |
| 添加7个新字段 | 1小时  |
| 更新配置教程  | 1小时  |

**小计**: 2小时

### 数据库改动（P1）

| 任务       | 工作量 |
| ---------- | ------ |
| Schema修改 | 1小时  |
| 数据迁移   | 2小时  |

**小计**: 3小时

---

## 🎯 总工作量估算

| 优先级   | 模块        | 工作量     |
| -------- | ----------- | ---------- |
| P0       | 前端改动    | 14小时     |
| P0       | API改动     | 9小时      |
| P0       | N8N改动     | 7小时      |
| P0       | DeerAPI集成 | 8小时      |
| P1       | 飞书改动    | 2小时      |
| P1       | 数据库改动  | 3小时      |
| **总计** |             | **43小时** |

---

## ❓ 必须确认的问题

### 问题1: DeerAPI功能支持情况

请明确回答：

1. ✅/❌ DeerAPI是否支持虚拟试衣功能？
2. ✅/❌ DeerAPI是否支持智能穿戴功能？
3. ✅/❌ DeerAPI是否支持自由搭配功能？
4. 如果支持，API端点分别是什么？
5. 如果不支持，是否有替代方案？

### 问题2: 实施策略

请选择：

- **选项A**: 同时实施全部4个功能（工作量43小时）
- **选项B**: 先实现功能1（虚拟试衣）+ 功能4（场景生图）（工作量25小时）
- **选项C**: 先实现功能4（场景生图）的优化，其他功能暂缓（工作量10小时）
- **选项D**: 其他（请说明）

### 问题3: AI服务选择

如果DeerAPI不支持这些新功能：

- **选项A**: 切换到绘蛙平台API
- **选项B**: 集成多个AI服务（DeerAPI + 其他）
- **选项C**: 暂不实现新功能，只优化现有功能
- **选项D**: 其他（请说明）

---

## 📞 下一步行动

**请先回答上述3个问题**，然后我将：

1. 根据您的回答调整技术方案
2. 创建详细的实施计划
3. 开始具体的开发工作

**不要在不确定这些问题的情况下开始开发**，否则可能导致大量返工！
