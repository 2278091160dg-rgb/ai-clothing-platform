# ✅ 需求确认清单

## 📅 确认日期：2026-01-29

## 📅 文档版本：v1.0

---

## 🎯 需求总览

本次沟通涉及**3个主要需求**，它们之间是**互补关系**，需要同时实施。

---

## 📋 需求1：AI提示词优化功能（之前遗漏的核心功能）

### 🎯 需求描述

用户上传产品图片后，可以通过**多轮AI对话**优化提示词，然后选择使用**原始版**或**AI优化版**来生成图片。

### 核心功能

1. **AI对话界面**：用户可以通过多轮对话与AI交互，优化提示词
2. **版本对比**：显示原始提示词和AI优化后的提示词对比
3. **用户选择**：用户可以选择使用哪个版本生成图片
4. **三端联动**：前端Web、N8N工作流、飞书多维表格完整联动

### 涉及的修改

#### 数据库层面

**文件**：`prisma/schema.prisma`

**新增字段**：

```prisma
model Task {
  // AI提示词优化相关字段
  originalPrompt    String?       // 原始提示词
  optimizedPrompt   String?       // AI优化后的提示词
  promptSource      PromptSource  // 最终使用的提示词来源（USER/AI_OPTIMIZED/FEISHU）
  promptOptimizationEnabled Boolean  // 是否启用AI优化
  promptOptimizationId    String?   // 优化任务ID
  promptOptimizedAt       DateTime? // 优化时间
}

enum PromptSource {
  USER           // 最终使用用户原始提示词
  AI_OPTIMIZED   // 最终使用AI优化后的提示词
  FEISHU         // 飞书表格输入的提示词
}
```

#### 飞书多维表格层面

**新增3个字段**：

| 字段名称         | 字段类型      | 说明                   | 是否必需 |
| ---------------- | ------------- | ---------------------- | -------- |
| **优化后提示词** | 多行文本      | AI优化后的提示词       | 可选     |
| **AI对话**       | URL（超链接） | 点击跳转到AI对话界面   | 推荐     |
| **提示词来源**   | 单选          | 标识最终使用哪个提示词 | 推荐     |

**AI对话URL配置**：

```
URL模板：https://your-app-domain.com/ai-chat/{record_id}?prompt={提示词}
按钮文字：💬 AI对话优化
打开方式：新窗口
```

#### N8N工作流层面

**Webhook接收新增参数**：

```json
{
  "prompt": "红色连衣裙", // 原始提示词（必填）
  "optimizedPrompt": "An elegant red...", // AI优化后的提示词（可选）
  "promptSource": "AI_OPTIMIZED" // 最终使用哪个（必填）
}
```

**新增节点**：

1. **"选择最终提示词"节点**（Code节点）
   - 位置：在"解析前端参数"节点之后
   - 功能：根据promptSource选择使用哪个提示词
   - 代码：

   ```javascript
   if (promptSource === 'AI_OPTIMIZED' && optimizedPrompt) {
     finalPrompt = optimizedPrompt;
   } else {
     finalPrompt = prompt;
   }
   ```

2. **"选择最终提示词-飞书"节点**（Code节点）
   - 位置：在"提取飞书参数"节点之后
   - 功能：同上，用于飞书轨道

**修改节点**：

- "创建飞书记录"：添加"优化后提示词"、"提示词来源"字段
- "AI图片生成-前端"：使用finalPrompt而不是prompt

#### 前端Web层面

**已有功能（需验证）**：

- ✅ AI对话页面：`src/app/ai-chat/[recordId]/page.tsx`
- ✅ AI对话API：`src/app/api/conversations/[id]/messages/route.ts`
- ✅ AI对话服务：`src/lib/services/ai-conversation.service.ts`

**需新增/修改**：

- 任务创建API接收`optimizedPrompt`和`promptSource`参数
- 任务处理器保存AI优化相关字段到数据库

### 已创建的文档

| 文档                                             | 说明                          |
| ------------------------------------------------ | ----------------------------- |
| `AI提示词优化-完整配置指南.md`                   | 完整的配置指南                |
| `AI提示词优化-实施检查清单.md`                   | 各个地方的修改说明和检查清单  |
| `AI提示词优化-遗漏分析与补充说明.md`             | 遗漏分析和补充说明            |
| `ai-clothing-platform-with-ai-optimization.json` | 包含AI优化功能的完整N8N工作流 |

---

## 📋 需求2：结构化提示词模板方案

### 🎯 需求描述

基于实际业务场景的优秀提示词设计，提供**结构化提示词模板**，让用户只需简单输入产品描述，系统自动生成专业的商业摄影提示词。

### 核心功能

1. **用户友好**：用户只需输入"红色连衣裙"，不需要输入复杂的提示词
2. **效果专业**：使用结构化的商业摄影提示词，大幅提升生成质量
3. **模板化**：提供预设的提示词模板，可重复使用
4. **最小改动**：N8N和飞书表格基本不用改

### 涉及的修改

#### 前端Web层面

**新增3个表单项**（方案一：最简化）：

```tsx
// 1. 产品描述（必填）
<Input placeholder="例如：红色连衣裙、蓝色西装..." />

// 2. 模特类型（可选）
<Select>
  <option>默认（亚洲模特）</option>
  <option>年轻亚洲女性</option>
  <option>年轻亚洲男性</option>
  ...
</Select>

// 3. 场景风格（可选）
<Select>
  <option>默认（极简高级环境）</option>
  <option>温馨卧室</option>
  <option>现代客厅</option>
  ...
</Select>
```

#### 后端层面

**新增模板文件**：

- `src/lib/prompts/image-generation.template.ts`
- 包含完整的结构化提示词模板
- 提供`buildImageGenerationPrompt()`函数

**修改API**：

- `src/app/api/tasks/route.ts`
- 使用模板生成最终提示词

#### N8N工作流层面

**无需改动**（方案一）

- 继续接收`prompt`字段
- 现在接收到的是完整的结构化提示词

### 已创建的文档

| 文档                                           | 说明           |
| ---------------------------------------------- | -------------- |
| `src/lib/prompts/image-generation.template.ts` | 提示词模板文件 |
| `结构化提示词模板方案-实施指南.md`             | 完整的实施指南 |

---

## 📋 需求3：多模板系统架构

### 🎯 需求描述

基于两个不同的提示词案例（服装模特展示、分层逻辑控制），设计**多模板系统**，用户可以根据场景选择合适的模板。

### 核心功能

1. **模板选择**：用户选择适合的提示词模板
2. **动态表单**：根据选择的模板显示对应的表单
3. **无限扩展**：可以轻松添加新的模板
4. **避免冲突**：每个模板独立，互不干扰

### 两个模板对比

| 特性         | 模板1：服装模特展示       | 模板2：分层逻辑控制             |
| ------------ | ------------------------- | ------------------------------- |
| **核心目标** | 白底产品图 → 真人模特展示 | 分层逻辑链精准控制生成          |
| **逻辑结构** | 任务导向（STEP 1→2→3）    | 维度导向（物理→空间→光影→感知） |
| **适用场景** | 服装、配饰、鞋包          | 家居、器皿、电子产品、静物      |
| **复杂度**   | 高（人物 + 场景 + 约束）  | 中等（分层清晰）                |
| **用户输入** | 产品描述 + 可选模特/场景  | 分层填写每层级参数              |

### 涉及的修改

#### 系统架构

```
用户选择模板 → 根据模板动态生成表单 → 后端组装提示词 → N8N生成
```

#### 初始模板（4个）

| 模板ID          | 名称         | 图标 | 适用场景             |
| --------------- | ------------ | ---- | -------------------- |
| `fashion_model` | 服装模特展示 | 👔   | 服装、配饰、鞋包     |
| `product_still` | 产品静物展示 | 🏺   | 家居、器皿、电子产品 |
| `layered_logic` | 分层逻辑控制 | 🎯   | 专业摄影、艺术创作   |
| `custom`        | 自定义提示词 | ✏️   | 特殊场景、实验性创作 |

#### 前端Web层面

**新增组件**：

- `TemplateSelector.tsx` - 模板选择器
- `FashionModelForm.tsx` - 服装模特表单
- `ProductStillForm.tsx` - 产品静物表单
- `LayeredLogicForm.tsx` - 分层逻辑表单（4个层级）
- `CustomPromptForm.tsx` - 自定义提示词表单

#### 后端层面

**新增模板文件**：

- `src/lib/prompts/templates/index.ts` - 模板配置
- `src/lib/prompts/templates/fashion-model.template.ts` - 模板1
- `src/lib/prompts/templates/layered-logic.template.ts` - 模板2
- `src/lib/prompts/templates/product-still.template.ts` - 产品静物（基于模板2）

#### 扩展性：如何添加新模板

**步骤**：

1. 在配置文件中添加模板定义
2. 创建对应的表单组件
3. 创建对应的提示词构建函数
4. 在TemplateSelector中注册

### 已创建的文档

| 文档                                           | 说明             |
| ---------------------------------------------- | ---------------- |
| `多模板系统架构-完整实施方案.md`               | 完整的实施方案   |
| `src/lib/prompts/image-generation.template.ts` | 模板1的完整实现  |
| `src/lib/prompts/templates/`目录               | 模板系统目录结构 |

---

## 🔗 三个需求之间的关系

### 互补关系

```
需求1（AI优化）和 需求2（结构化模板）可以组合使用：

用户输入：产品描述
    ↓
使用结构化模板生成基础提示词
    ↓
[可选] 使用AI进一步优化
    ↓
用户选择：使用模板版 / 使用AI优化版
    ↓
生成图片
```

### 多模板系统（需求3）整合需求1和需求2

```
多模板系统 = 需求1 + 需求2 + 无限扩展

├─ 模板1：服装模特展示（结构化模板）
│   └─ 可选：开启AI优化
│
├─ 模板2：产品静物展示（结构化模板）
│   └─ 可选：开启AI优化
│
├─ 模板3：分层逻辑控制（结构化模板）
│   └─ 可选：开启AI优化
│
└─ 模板N：自定义（完全自定义）
```

---

## ✅ 实施优先级

### 第一步：核心功能（必须实施）

#### 1.1 AI提示词优化功能（需求1）

**工作量**：约8-10小时

- [ ] 数据库：添加AI优化相关字段
- [ ] 飞书表格：添加3个新字段
- [ ] N8N工作流：添加"选择最终提示词"节点
- [ ] 前端Web：验证AI对话功能

#### 1.2 结构化提示词模板（需求2）

**工作量**：约3-5小时

- [ ] 创建提示词模板文件
- [ ] 修改前端表单（3个新增项）
- [ ] 修改后端API（使用模板）

### 第二步：增强功能（推荐实施）

#### 2.1 多模板系统（需求3）

**工作量**：约12-15小时

- [ ] 创建模板配置系统
- [ ] 创建模板选择器组件
- [ ] 创建各模板的表单组件
- [ ] 创建各模板的构建函数
- [ ] 集成到主界面

### 第三步：高级功能（按需实施）

- [ ] 模板混合功能
- [ ] 智能模板推荐
- [ ] 用户自定义模板保存
- [ ] 模板使用统计

---

## 📊 工作量估算

| 需求                  | 工作量    | 优先级          | 建议             |
| --------------------- | --------- | --------------- | ---------------- |
| **需求1：AI优化**     | 8-10小时  | ⭐⭐⭐⭐⭐ 最高 | 第一阶段必须实施 |
| **需求2：结构化模板** | 3-5小时   | ⭐⭐⭐⭐⭐ 最高 | 第一阶段必须实施 |
| **需求3：多模板系统** | 12-15小时 | ⭐⭐⭐⭐ 高     | 第二阶段实施     |

**第一阶段总工作量**：约11-15小时
**第二阶段总工作量**：约12-15小时

---

## 🤔 需要您确认的问题

### 1. 实施顺序

您希望按什么顺序实施？

**选项A**：先实施需求1和需求2（AI优化 + 结构化模板）

- 优点：快速见效，工作量较小
- 缺点：暂时不支持多模板

**选项B**：同时实施全部3个需求

- 优点：一次性完成，功能完整
- 缺点：工作量较大，测试复杂

**选项C**：分阶段实施

- 第一阶段：需求1 + 需求2（11-15小时）
- 第二阶段：需求3（12-15小时）
- 优点：风险可控，逐步完善
- 缺点：需要两轮开发

**我的建议**：选项C（分阶段实施）

### 2. 模板设计

**问题2.1**：多模板系统初始提供几个模板？

- A. 2个模板（服装模特、分层逻辑）
- B. 4个模板（服装模特、产品静物、分层逻辑、自定义）
- C. 更多模板...

**问题2.2**：模板选择方式？

- A. 单选（只能选择一个模板）
- B. 主模板 + 辅助增强（一个主模板 + 可选增强）
- C. 完全自定义（用户自己组合）

**我的建议**：初始提供4个模板，使用单选方式

### 3. 用户界面

**问题3.1**：AI对话功能如何触发？

- A. 在主表单旁边有一个"💬 AI对话优化"按钮
- B. 在参数面板中有一个"AI对话"标签页
- C. 在飞书表格中点击"AI对话"URL按钮

**问题3.2**：结构化模板的表单项？

- A. 只提供3个基础项（产品描述、模特类型、场景风格）
- B. 提供更多选项（7种模特类型、9种场景风格）
- C. 完全自定义（用户自己填写）

**我的建议**：选项B（提供更多选择）

### 4. 技术实现

**问题4.1**：N8N工作流如何处理？

- A. 修改现有工作流（包含AI优化逻辑）
- B. 创建新的工作流版本
- C. 保持工作流不变，只修改前端和后端

**问题4.2**：飞书表格如何扩展？

- A. 新增最少字段（3个AI优化字段）
- B. 新增中等字段（3个AI优化 + 3个模板字段）
- C. 新增最多字段（上述 + 用户自定义字段）

**我的建议**：

- 问题4.1：选项A（修改现有工作流）
- 问题4.2：选项A（新增最少字段）

### 5. 测试验证

**问题5**：是否需要完整的测试用例？

- A. 需要（提供详细的测试用例和验证步骤）
- B. 不需要（提供基本的使用说明）
- C. 后续再说（先实施，后测试）

**我的建议**：选项A（需要完整的测试用例）

---

## 📝 确认清单

请您逐一确认以下事项：

### 需求确认

- [ ] **需求1（AI优化）**：您确认需要实施AI提示词优化功能
- [ ] **需求2（结构化模板）**：您确认需要实施结构化提示词模板方案
- [ ] **需求3（多模板系统）**：您确认需要实施多模板系统架构
- [ ] **关系确认**：您理解这三个需求是互补关系，需要同时实施

### 方案确认

- [ ] **实施顺序**：您同意分阶段实施（先需求1+2，后需求3）
- [ ] **模板数量**：您同意初始提供4个模板
- [ ] **选择方式**：您同意使用单选方式（一次只选一个模板）
- [ ] **界面设计**：您同意提供更多选择（7种模特、9种场景）

### 技术确认

- [ ] **N8N工作流**：您同意修改现有工作流
- [ ] **飞书表格**：您同意新增最少字段（3个AI优化字段）
- [ ] **前端Web**：您确认AI对话功能已存在，只需验证和集成

### 测试确认

- [ ] **测试用例**：您需要完整的测试用例和验证步骤

---

## 🚀 下一步行动

如果您确认以上需求：

1. **第一阶段**（AI优化 + 结构化模板）：
   - 我将立即创建完整的实施代码
   - 包括：数据库迁移、N8N工作流、前端组件、后端API
   - 预计工作量：11-15小时

2. **第二阶段**（多模板系统）：
   - 我将创建完整的模板系统
   - 包括：模板选择器、各模板表单、构建函数
   - 预计工作量：12-15小时

3. **测试验证**：
   - 我将提供完整的测试用例和验证步骤
   - 包括：前端测试、N8N测试、飞书测试、端到端测试

---

## ❓ 您的回答

请您回答以下问题，以便我准确理解您的需求：

1. **您是否确认需要实施全部3个需求？**
   - A. 是，全部实施
   - B. 只实施其中某些（请说明）
   - C. 需要进一步讨论

2. **您希望的实施顺序是？**
   - A. 分阶段实施（先需求1+2，后需求3）
   - B. 同时实施全部
   - C. 其他顺序（请说明）

3. **对于上面的"需要您确认的问题"，您的选择是？**
   - 请逐一回答问题1-5中的各个选项

4. **是否有其他需求或调整建议？**
   - 如有，请详细说明

请告诉我您的决定，我将立即开始实施！
