# 🔍 扩展参数 - 影响分析报告

## 📅 文档版本：v1.0

## 📅 更新日期：2026-01-29

---

## 🎯 概述

本文档分析**产品静物模块扩展参数**对系统其他部分的影响，并提供相应的修改建议。

---

## 📊 影响概览

```
┌─────────────────────────────────────────────────────────────┐
│                   扩展参数影响的范围                         │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  1. 前端Web界面 ⭐⭐⭐⭐⭐                                │
│     → 需要更新表单选项和参数输入                             │
│                                                               │
│  2. 后端API接口 ⭐⭐⭐⭐⭐                                 │
│     → 需要更新请求参数和验证逻辑                             │
│                                                               │
│  3. 提示词模板系统 ⭐⭐⭐⭐⭐                              │
│     → 需要更新提示词构建函数                                 │
│                                                               │
│  4. N8N工作流 ⭐⭐⭐                                       │
│     → 基本无需修改（参数透传）                               │
│                                                               │
│  5. 飞书多维表格 ⭐⭐⭐⭐                                   │
│     → 需要新增可选字段（推荐）                               │
│                                                               │
│  6. 数据库Schema ⭐⭐⭐⭐                                    │
│     → 需要新增可选字段（推荐）                               │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 1️⃣ 前端Web界面影响

### 影响等级: ⭐⭐⭐⭐⭐ 必须修改

### 需要修改的文件

#### 1. 产品静物表单组件

**文件**: `src/components/prompts/ProductStillForm.tsx`

**修改内容**:

```typescript
// 之前：只有4个基础参数
interface ProductStillFormProps {
  productDescription: string;
  material: string;
  position: string;
  lightDirection: string;
}

// 之后：扩展到12个参数
interface ProductStillFormProps {
  // 核心参数（必填）
  productDescription: string;
  productCategory?: string; // NEW

  // 材质与表面
  material?: string; // 保留，但扩展选项
  surfaceFinish?: string; // NEW

  // 光线与摄影
  lightingType?: string; // NEW
  lightDirection?: string; // 保留

  // 背景与构图
  backgroundType?: string; // 替换原来的 position
  compositionAngle?: string; // NEW
  lensType?: string; // NEW
  depthOfField?: string; // NEW

  // 风格与色调
  photographyStyle?: string; // NEW
  colorScheme?: string; // NEW

  // 道具（可选）
  props?: string[]; // NEW
}
```

**表单UI更新**:

```tsx
// 之前：简单的4个选择框
<div>
  <label>材质</label>
  <select>
    <option>陶瓷</option>
    <option>金属</option>
    ...
  </select>
</div>

// 之后：分组折叠面板，12个参数
<div>
  {/* 基础信息 */}
  <CollapsibleSection title="基础信息">
    <Input label="产品描述" required />
    <Select label="产品类别" options={PRODUCT_CATEGORIES} />
  </CollapsibleSection>

  {/* 材质与表面 */}
  <CollapsibleSection title="材质与表面" defaultOpen>
    <Select label="材质类型" options={MATERIAL_TYPES} />
    <Select label="表面处理" options={SURFACE_FINISHES} />
  </CollapsibleSection>

  {/* 光线设置 */}
  <CollapsibleSection title="光线设置">
    <Select label="光线类型" options={LIGHTING_TYPES} />
    <Select label="光线方向" options={LIGHT_DIRECTIONS} />
  </CollapsibleSection>

  {/* 背景与构图 */}
  <CollapsibleSection title="背景与构图" defaultOpen>
    <Select label="背景类型" options={BACKGROUND_TYPES} />
    <Select label="构图视角" options={COMPOSITION_ANGLES} />
  </CollapsibleSection>

  {/* 摄影设置 */}
  <CollapsibleSection title="摄影设置">
    <Select label="镜头类型" options={LENS_TYPES} />
    <Select label="景深效果" options={DEPTH_OF_FIELD_OPTIONS} />
  </CollapsibleSection>

  {/* 风格与色调 */}
  <CollapsibleSection title="风格与色调">
    <Select label="拍摄风格" options={PHOTOGRAPHY_STYLES} />
    <Select label="色调方案" options={COLOR_SCHEMES} />
  </CollapsibleSection>

  {/* 道具装饰 */}
  <CollapsibleSection title="道具装饰">
    <MultiSelect label="道具" options={PROP_CATEGORIES} />
  </CollapsibleSection>
</div>
```

#### 2. 选项配置文件

**新文件**: `src/lib/prompts/config/product-still.config.ts`

**内容**:

```typescript
// 从 docs/产品静物模块-扩展参数定义.md 导入所有配置
import {
  PRODUCT_CATEGORIES,
  MATERIAL_TYPES,
  SURFACE_FINISHES,
  LIGHTING_TYPES,
  LIGHT_DIRECTIONS,
  BACKGROUND_TYPES,
  COMPOSITION_ANGLES,
  LENS_TYPES,
  DEPTH_OF_FIELD_OPTIONS,
  PHOTOGRAPHY_STYLES,
  COLOR_SCHEMES,
  PROP_CATEGORIES,
} from './product-raw.config';

// 转换为表单可用的格式
export const PRODUCT_STILL_OPTIONS = {
  productCategories: PRODUCT_CATEGORIES.map(cat => ({
    value: cat.id,
    label: cat.name,
    icon: cat.icon,
  })),

  materials: Object.entries(MATERIAL_TYPES).map(([key, val]) => ({
    value: key,
    label: val.name,
    description: val.characteristics,
    lightingHint: val.lightingHint,
  })),

  surfaceFinishes: Object.entries(SURFACE_FINISHES).map(([key, val]) => ({
    value: key,
    label: val.name,
    description: val.description,
  })),

  // ... 其他配置
};
```

#### 3. 参数预构建功能（新增）

**新文件**: `src/lib/prompts/helpers/parameter-builder.ts`

**功能**:

```typescript
/**
 * 根据产品类别自动推荐参数
 */
export function suggestParametersByCategory(category: string): Partial<ProductStillFormProps> {
  const suggestions: Record<string, Partial<ProductStillFormProps>> = {
    vase: {
      material: 'ceramic',
      surfaceFinish: 'glossy',
      lightingType: 'studio_softbox',
      lightDirection: 'side_45',
      backgroundType: 'minimalist_scene',
      compositionAngle: 'three_quarter',
      photographyStyle: 'minimalism',
      colorScheme: 'neutral',
    },
    glass_cup: {
      material: 'glass',
      surfaceFinish: 'glossy',
      lightingType: 'studio_softbox',
      lightDirection: 'back', // 逆光强调透明感
      backgroundType: 'black_velvet',
      compositionAngle: 'eye_level',
      photographyStyle: 'luxury',
      colorScheme: 'neutral',
    },
    // ... 更多类别的推荐
  };

  return suggestions[category] || {};
}

/**
 * 验证参数组合是否合理
 */
export function validateParameterCombination(params: ProductStillFormProps): {
  valid: boolean;
  warnings: string[];
} {
  const warnings: string[] = [];

  // 玻璃材质建议使用逆光
  if (params.material === 'glass' && params.lightDirection !== 'back') {
    warnings.push('玻璃材质使用逆光效果更好');
  }

  // 亮光表面需要柔光源
  if (
    params.surfaceFinish === 'glossy' &&
    !['studio_softbox', 'natural_window'].includes(params.lightingType || '')
  ) {
    warnings.push('亮光表面建议使用柔光源');
  }

  // ... 更多验证规则

  return {
    valid: true, // 警告不影响提交
    warnings,
  };
}
```

---

## 2️⃣ 后端API接口影响

### 影响等级: ⭐⭐⭐⭐⭐ 必须修改

### 需要修改的文件

#### 1. API路由

**文件**: `src/app/api/tasks/route.ts`

**修改内容**:

```typescript
// 之前：接收4个参数
interface CreateTaskRequest {
  templateType: 'product_still';
  productDescription: string;
  material?: string;
  position?: string;
  lightDirection?: string;
}

// 之后：接收12个参数
interface CreateTaskRequest {
  templateType: 'product_still';

  // 核心参数
  productDescription: string;
  productCategory?: string;

  // 材质与表面
  material?: string;
  surfaceFinish?: string;

  // 光线与摄影
  lightingType?: string;
  lightDirection?: string;

  // 背景与构图
  backgroundType?: string;
  compositionAngle?: string;
  lensType?: string;
  depthOfField?: string;

  // 风格与色调
  photographyStyle?: string;
  colorScheme?: string;

  // 道具
  props?: string[];

  // AI优化相关（保持不变）
  promptSource?: 'USER' | 'TEMPLATE' | 'AI_OPTIMIZED' | 'FEISHU';
  optimizedPrompt?: string;
}
```

#### 2. 提示词构建函数

**文件**: `src/lib/prompts/templates/product-still.template.ts`

**修改内容**:

```typescript
// 之前：简单拼接
export function buildProductStillPrompt(params: SimpleParams) {
  return `Product photography, ${params.material} ${params.productDescription}...`;
}

// 之后：分层构建，包含所有12个参数
export function buildProductStillPrompt(params: ProductStillParams): {
  prompt: string;
  metadata: PromptMetadata;
} {
  // 提取所有参数
  const {
    productDescription,
    productCategory,
    material,
    surfaceFinish,
    lightingType,
    lightDirection,
    backgroundType,
    compositionAngle,
    lensType,
    depthOfField,
    photographyStyle,
    colorScheme,
    props,
  } = params;

  // 构建物理层
  const physicsLayer = buildPhysicsLayer({
    material,
    surfaceFinish,
    productDescription,
  });

  // 构建空间层
  const spaceLayer = buildSpaceLayer({
    backgroundType,
    compositionAngle,
    props,
  });

  // 构建光影层
  const lightLayer = buildLightLayer({
    lightingType,
    lightDirection,
    colorScheme,
  });

  // 构建感知层
  const sensorLayer = buildSensorLayer({
    lensType,
    depthOfField,
  });

  // 组装完整提示词
  const prompt = `
# Product Still Life Photography

## Physics Layer
${physicsLayer}

## Space Layer
${spaceLayer}

## Light Layer
${lightLayer}

## Sensor Layer
${sensorLayer}

## Style & Mood
- Photography Style: ${photographyStyle || 'professional'}
- Color Scheme: ${colorScheme || 'neutral'}

---

**Complete Generation Prompt:**

Professional product photography, ${productDescription}${material ? `, ${material} material` : ''}${surfaceFinish ? `, ${surfaceFinish} finish` : ''}, ${lightingType || 'softbox'} lighting, ${lightDirection || 'side'} light, ${backgroundType || 'gradient'} background, ${compositionAngle || 'three-quarter'} angle, ${lensType || '85mm'} lens, ${depthOfField || 'shallow'} depth of field, ${photographyStyle || 'professional'} style, ${colorScheme || 'neutral'} color scheme${props && props.length > 0 ? `, with ${props.join(', ')}` : ''}, high quality, sharp details, realistic lighting, 8k resolution, commercial product shot.
  `.trim();

  return {
    prompt,
    metadata: {
      templateType: 'product_still',
      paramCount: Object.keys(params).filter(k => params[k]).length,
      hasAdvancedParams: true,
    },
  };
}
```

---

## 3️⃣ 提示词模板系统影响

### 影响等级: ⭐⭐⭐⭐⭐ 必须修改

### 需要修改的文件

#### 1. 模板配置更新

**文件**: `src/lib/prompts/templates/index.ts`

**修改内容**:

```typescript
// 更新模板定义
export const TEMPLATE_TYPES: TemplateConfig[] = [
  {
    id: 'product_still',
    name: '产品静物展示',
    description: '通过分层逻辑精准控制产品静物展示效果（扩展版）',
    icon: '🏺',
    useCases: ['家居', '器皿', '电子产品', '化妆品', '珠宝', '文具'],
    formComponent: 'ProductStillForm',
    buildFunction: 'buildProductStillPrompt',
    category: 'product',
    // NEW: 标记为扩展版本
    version: 'v2',
    paramCount: 12,
  },
  // ... 其他模板
];
```

#### 2. 参数默认值配置

**新文件**: `src/lib/prompts/config/default-params.ts`

**内容**:

```typescript
/**
 * 产品静物展示模板的默认参数
 */
export const PRODUCT_STILL_DEFAULTS = {
  // 如果用户不填写，使用这些默认值
  material: undefined, // 自动识别
  surfaceFinish: 'matte',
  lightingType: 'studio_softbox',
  lightDirection: 'side_45',
  backgroundType: 'gray_gradient',
  compositionAngle: 'three_quarter',
  lensType: '85mm',
  depthOfField: 'medium_shallow',
  photographyStyle: 'minimalism',
  colorScheme: 'neutral',
  props: [],
};
```

---

## 4️⃣ N8N工作流影响

### 影响等级: ⭐⭐⭐ 基本无需修改

### 分析

N8N工作流主要是**透传参数**，只要前端正确发送参数，N8N就不需要修改。

### 可选优化（非必须）

#### 1. 参数验证节点（可选）

**位置**: "解析前端参数"节点之后

**目的**: 验证接收到的参数是否完整

**代码**:

```javascript
// 在"解析前端参数"节点中添加
const params = $input.item.json;

// 验证产品静物模板的参数
if (params.templateType === 'product_still') {
  const required = ['productDescription'];
  const missing = required.filter(field => !params[field]);

  if (missing.length > 0) {
    throw new Error(`缺少必填参数: ${missing.join(', ')}`);
  }

  // 可选：记录参数使用情况
  const paramCount = Object.keys(params).filter(
    k => k !== 'productDescription' && params[k]
  ).length;

  return {
    ...params,
    _metadata: {
      paramCount,
      hasAdvancedParams: paramCount > 4,
    },
  };
}

return params;
```

#### 2. 提示词质量评分节点（可选）

**位置**: 在"AI图片生成"之前

**目的**: 根据参数数量和质量给出评分

**代码**:

```javascript
// 评估提示词质量
const params = $input.item.json;

let qualityScore = 50; // 基础分
let qualityTips = [];

// 材质指定 (+10分)
if (params.material) {
  qualityScore += 10;
} else {
  qualityTips.push('建议指定材质类型');
}

// 光线类型 (+10分)
if (params.lightingType) {
  qualityScore += 10;
} else {
  qualityTips.push('建议指定光线类型');
}

// 背景类型 (+10分)
if (params.backgroundType) {
  qualityScore += 10;
} else {
  qualityTips.push('建议指定背景类型');
}

// 构图视角 (+10分)
if (params.compositionAngle) {
  qualityScore += 10;
} else {
  qualityTips.push('建议指定构图视角');
}

// 拍摄风格 (+10分)
if (params.photographyStyle) {
  qualityScore += 10;
} else {
  qualityTips.push('建议指定拍摄风格');
}

return {
  ...params,
  _qualityScore: qualityScore,
  _qualityTips: qualityTips,
};
```

---

## 5️⃣ 飞书多维表格影响

### 影响等级: ⭐⭐⭐⭐ 推荐添加字段

### 需要新增的字段

**原字段列表**（13个基础字段）:

| 字段名称     | 字段类型 | 说明         |
| ------------ | -------- | ------------ |
| 记录ID       | 文本     | 唯一标识     |
| 任务状态     | 单选     | 处理状态     |
| 产品图片     | 附件     | 产品图片     |
| 提示词       | 多行文本 | 原始提示词   |
| 优化后提示词 | 多行文本 | AI优化版     |
| 提示词来源   | 单选     | 最终使用版本 |
| AI对话       | URL      | AI对话入口   |
| AI模型       | 单选     | AI模型选择   |
| 尺寸比例     | 单选     | 图片尺寸     |
| 生成数量     | 数字     | 生成数量     |
| 生成结果     | 附件     | 生成的图片   |
| 创建时间     | 日期     | 创建时间     |
| 完成时间     | 日期     | 完成时间     |

**新增字段**（8个可选字段）:

| 字段名称         | 字段类型 | 说明             | 必需 |
| ---------------- | -------- | ---------------- | ---- |
| **模板类型**     | 单选     | 提示词模板       | 推荐 |
| **产品类别**     | 单选     | 产品分类         | 可选 |
| **材质类型**     | 单选     | 材质             | 可选 |
| **表面处理**     | 单选     | 表面处理         | 可选 |
| **光线类型**     | 单选     | 光线类型         | 可选 |
| **背景类型**     | 单选     | 背景设置         | 可选 |
| **拍摄风格**     | 单选     | 摄影风格         | 可选 |
| **扩展参数JSON** | 多行文本 | 完整参数（JSON） | 可选 |

### 字段配置详解

#### 1. 模板类型（推荐）

**配置**:

- 字段类型: 单选
- 选项:
  - 服装模特展示
  - 产品静物展示
  - 分层逻辑控制
  - 自定义
- 默认值: 无

**用途**: 快速筛选不同模板的任务

#### 2. 产品类别（可选）

**配置**:

- 字段类型: 单选
- 选项: 花瓶、碗、杯具、电子产品、化妆品、珠宝...
- 默认值: 无

**用途**: 统计不同类别产品的生成情况

#### 3. 扩展参数JSON（可选）

**配置**:

- 字段类型: 多行文本
- 格式: JSON
- 示例:

```json
{
  "material": "ceramic",
  "surfaceFinish": "glossy",
  "lightingType": "studio_softbox",
  "backgroundType": "wood_grain",
  "compositionAngle": "three_quarter",
  "photographyStyle": "minimalism"
}
```

**用途**: 保存完整的扩展参数，便于后续分析和复现

---

## 6️⃣ 数据库Schema影响

### 影响等级: ⭐⭐⭐⭐ 推荐添加字段

### 需要修改的文件

**文件**: `prisma/schema.prisma`

### 修改内容

```prisma
// 之前：只有基础字段
model Task {
  id                String   @id @default(cuid())
  productImageUrl   String?
  prompt            String
  // ... 其他基础字段
}

// 之后：添加扩展参数字段（使用JSON）
model Task {
  id                String   @id @default(cuid())

  // 基础字段（保持不变）
  productImageUrl   String?
  prompt            String?
  optimizedPrompt   String?
  promptSource      PromptSource @default(USER)

  // NEW: 模板相关字段
  templateType      String?  // 'fashion_model', 'product_still', 'layered_logic', 'custom'

  // NEW: 扩展参数（JSON格式）
  extendedParams    Json?    // 存储所有扩展参数

  // 或者，如果需要查询特定参数，可以拆分为独立字段
  productCategory   String?
  material          String?
  surfaceFinish     String?
  lightingType      String?
  lightDirection    String?
  backgroundType    String?
  compositionAngle  String?
  lensType          String?
  depthOfField      String?
  photographyStyle  String?
  colorScheme       String?

  // ... 其他字段
}

enum PromptSource {
  USER
  TEMPLATE
  AI_OPTIMIZED
  FEISHU
}
```

### 推荐方案

**方案A**: 使用 `extendedParams` JSON字段（推荐）

- 优点: 灵活，易于扩展
- 缺点: 无法直接SQL查询特定参数

**方案B**: 拆分为独立字段

- 优点: 可以直接查询和统计
- 缺点: Schema较长，添加新参数需要迁移

**方案C**: 混合方案（最推荐）

- 常用参数作为独立字段（产品类别、材质、拍摄风格）
- 其他参数放在JSON中

```prisma
model Task {
  // ... 基础字段

  // 常用参数（独立字段，便于查询）
  templateType      String?
  productCategory   String?
  material          String?
  photographyStyle  String?

  // 其他参数（JSON，灵活存储）
  extendedParams    Json?

  // ... 其他字段
}
```

---

## 7️⃣ AI对话优化影响

### 影响等级: ⭐⭐⭐ 需要更新上下文

### 修改内容

**文件**: `src/lib/services/ai-conversation.service.ts`

**修改**: 更新AI对话的初始上下文，让它了解新的参数

```typescript
// 之前：只了解基础参数
const SYSTEM_PROMPT = `
你是一个专业的商业摄影提示词优化专家。
用户会使用模板生成基础提示词，你可以帮助优化...
`;

// 之后：了解所有扩展参数
const SYSTEM_PROMPT = `
你是一个专业的商业摄影提示词优化专家。

当前系统支持的提示词模板：
1. 服装模特展示
2. 产品静物展示（扩展版，支持12个参数）
3. 分层逻辑控制
4. 自定义

产品静物展示支持的参数：
- 材质类型: ceramic, glass, metal, wood, stone, plastic...
- 表面处理: glossy, matte, satin, textured, brushed...
- 光线类型: natural_window, studio_softbox, spot_light...
- 光线方向: front, side_45, side_90, back, top...
- 背景类型: white_infinity, wood_grain, marble_texture...
- 构图视角: eye_level, high_angle, birds_eye, three_quarter...
- 镜头类型: 85mm, 50mm, 35mm, macro_100mm...
- 景深效果: shallow, medium, deep...
- 拍摄风格: minimalism, luxury, rustic, industrial...
- 色调方案: neutral, warm, cool, pastel...

你可以建议用户调整这些参数来获得更好的生成效果。
`;
```

---

## 📊 修改优先级总结

### P0: 必须立即修改（核心功能）

| 文件                        | 修改内容           | 工作量 |
| --------------------------- | ------------------ | ------ |
| `ProductStillForm.tsx`      | 扩展表单参数到12个 | 4小时  |
| `product-still.template.ts` | 更新提示词构建函数 | 3小时  |
| `product-still.config.ts`   | 新建配置文件       | 2小时  |

**小计**: 9小时

### P1: 推荐修改（体验提升）

| 文件                   | 修改内容             | 工作量 |
| ---------------------- | -------------------- | ------ |
| `route.ts`             | 更新API接口参数      | 2小时  |
| `parameter-builder.ts` | 新建参数预构建和验证 | 2小时  |
| 飞书表格               | 添加8个新字段        | 1小时  |
| `schema.prisma`        | 添加扩展参数字段     | 1小时  |

**小计**: 6小时

### P2: 可选修改（锦上添花）

| 文件                         | 修改内容                 | 工作量 |
| ---------------------------- | ------------------------ | ------ |
| N8N工作流                    | 添加参数验证和质量评分   | 2小时  |
| `ai-conversation.service.ts` | 更新AI对话上下文         | 1小时  |
| 前端UI                       | 添加参数预构建和验证提示 | 2小时  |

**小计**: 5小时

---

## ✅ 实施建议

### 阶段1: 核心功能（必须）

1. 创建参数配置文件（2小时）
2. 更新表单组件（4小时）
3. 更新提示词构建函数（3小时）

### 阶段2: 集成完善（推荐）

4. 更新API接口（2小时）
5. 添加参数验证和预构建（2小时）
6. 更新飞书表格字段（1小时）
7. 更新数据库Schema（1小时）

### 阶段3: 优化提升（可选）

8. 优化N8N工作流（2小时）
9. 更新AI对话上下文（1小时）
10. 优化前端交互（2小时）

---

## 🎯 总结

**核心结论**:

1. ✅ **前端必须修改** - 表单参数从4个扩展到12个
2. ✅ **后端必须修改** - API接口和提示词构建函数需要更新
3. ✅ **N8N基本无需修改** - 参数透传机制仍然有效
4. ✅ **飞书推荐添加字段** - 便于筛选和统计
5. ✅ **数据库推荐添加字段** - 便于后续分析

**兼容性**:

- ✅ 向后兼容 - 旧参数仍然有效
- ✅ 渐进式迁移 - 可以先实现核心参数，逐步添加
- ✅ 默认值填充 - 新参数都是可选的，不影响现有功能

**风险控制**:

- ⚠️ 表单复杂度增加 - 需要良好的UI设计（分组、折叠）
- ⚠️ 参数组合验证 - 需要添加合理的验证规则
- ⚠️ 用户学习成本 - 需要提供清晰的说明和示例
