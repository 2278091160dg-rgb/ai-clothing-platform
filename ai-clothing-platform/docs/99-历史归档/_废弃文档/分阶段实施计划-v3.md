# 🚀 AI服装平台 - 分阶段实施计划 v3.0

## 📅 日期：2026-01-29

---

## 🎯 核心理解（重新梳理）

### 技术本质

```
┌─────────────────────────────────────────────────────────────┐
│                    核心技术架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  前端 → N8N → DeerAPI → Gemini 3.0 Pro → 生成的图片         │
│                                                               │
│  关键：不同的功能 = 不同的输入 + 不同的提示词                │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 4大功能对比（简化版）

| 功能         | 输入                       | 核心     | 难度       |
| ------------ | -------------------------- | -------- | ---------- |
| **场景生图** | 商品图 + 提示词            | 文本生图 | ⭐⭐       |
| **虚拟试衣** | 服装图 +（参考图）+ 提示词 | 图像融合 | ⭐⭐⭐⭐   |
| **智能穿戴** | 商品图 + 参考图 + 提示词   | 图像融合 | ⭐⭐⭐⭐   |
| **自由搭配** | 多张素材 + 提示词          | 批量生成 | ⭐⭐⭐⭐⭐ |

**本质**：都是**图像生成**，区别在于输入数量和提示词策略

---

## 📊 优先级评估

### 评估维度

| 维度           | 场景生图  | 虚拟试衣   | 智能穿戴  | 自由搭配   |
| -------------- | --------- | ---------- | --------- | ---------- |
| **用户需求**   | ⭐⭐⭐    | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐  | ⭐⭐⭐     |
| **技术难度**   | ⭐⭐      | ⭐⭐⭐⭐   | ⭐⭐⭐⭐  | ⭐⭐⭐⭐⭐ |
| **开发工作量** | ⭐⭐      | ⭐⭐⭐⭐   | ⭐⭐⭐⭐  | ⭐⭐⭐⭐⭐ |
| **当前状态**   | ✅ 已实现 | ❌ 未实现  | ❌ 未实现 | ❌ 未实现  |
| **依赖关系**   | 无        | 无         | 依赖试衣  | 依赖试衣   |
| **商业价值**   | ⭐⭐⭐    | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐  | ⭐⭐⭐⭐   |

### 优先级排序

| 优先级    | 功能         | 理由                       |
| --------- | ------------ | -------------------------- |
| **🥇 P0** | 场景生图优化 | 已实现，快速优化，立即见效 |
| **🥈 P1** | 虚拟试衣     | 用户需求最大，核心功能     |
| **🥉 P2** | 智能穿戴     | 基于试衣技术，工作量较小   |
| **P3**    | 自由搭配     | 复杂度高，可以最后实现     |

---

## 🎯 分阶段实施计划

### 第一阶段：基础优化（5小时）⭐⭐⭐⭐⭐

**目标**：优化现有功能，立即提升用户体验

#### 任务1.1：优化场景生图提示词（2小时）

**当前问题**：

- 提示词模板太简单
- 生成的图片质量不稳定

**解决方案**：

```typescript
// 优化前：简单提示词
'Product photography, red dress, on white background';

// 优化后：结构化提示词
buildSceneGenerationPrompt({
  productDescription: '红色连衣裙',
  sceneStyle: '温馨卧室',
  lightingType: '自然窗光',
  compositionAngle: '3/4视角',
  photographyStyle: '极简主义',
});
```

**交付物**：

- ✅ 优化的场景生图提示词模板
- ✅ 支持100+参数（之前定义的）

#### 任务1.2：添加AI对话优化（3小时）

**当前问题**：

- 用户无法优化提示词

**解决方案**：

- 在前端添加"AI对话优化"按钮
- 集成AI对话接口（使用Gemini 2.0 Flash）
- 用户可以选择模板版或AI优化版

**交付物**：

- ✅ AI对话界面
- ✅ 版本选择功能
- ✅ 前端集成

**第一阶段成果**：

- ✅ 场景生图质量大幅提升
- ✅ 支持AI对话优化
- ✅ 用户可以立即体验改进

---

### 第二阶段：核心功能（15小时）⭐⭐⭐⭐⭐

**目标**：实现虚拟试衣功能（用户最需要）

#### 任务2.1：前端界面重构（5小时）

**当前问题**：

- 只有场景生图一个模式
- 无法切换到其他功能

**解决方案**：

```tsx
// 添加模式选择器
<div className="mode-selector">
  <Button mode="scene">🏞️ 场景生图</Button>
  <Button mode="tryon">👔 虚拟试衣</Button>
  <Button mode="wear" disabled>
    👟 智能穿戴（开发中）
  </Button>
  <Button mode="combine" disabled>
    🎨 自由搭配（开发中）
  </Button>
</div>;

// 根据模式显示不同表单
{
  mode === 'scene' && <SceneForm />;
}
{
  mode === 'tryon' && <TryOnForm />;
}
```

**交付物**：

- ✅ 模式选择器
- ✅ 虚拟试衣表单
- ✅ 场景生图表单（重构）

#### 任务2.2：虚拟试衣提示词模板（4小时）

**当前问题**：

- 没有试衣提示词

**解决方案**：

```typescript
export function buildVirtualTryOnPrompt(params: {
  clothingImage: string;
  referenceImage?: string;
  modelDescription?: string;
  sceneDescription?: string;
}): string {
  return `# Virtual Try-On Task

## Product
Clothing image provided: ${params.clothingImage}

${
  params.referenceImage
    ? `## Reference Pose
Reference image provided: ${params.referenceImage}

Target: Adapt the clothing to match the reference pose exactly.`
    : ''
}

${
  params.modelDescription
    ? `## Model Description
${params.modelDescription}`
    : ''
}

${
  params.sceneDescription
    ? `## Scene Description
${params.sceneDescription}`
    : ''
}

## Instructions
1. **Maintain Design**: STRICTLY preserve all original design elements:
   - Color: Keep exact color
   - Pattern: Keep exact pattern
   - Logo/Print: Keep all logos and prints
   - Material: Maintain material appearance

2. **Natural Fit**:
   - Adapt clothing to body pose naturally
   - Realistic fabric draping and folds
   - Proper sizing and proportions

3. **Seamless Integration**:
   - Natural transition between clothing and body
   - Consistent lighting with reference
   - Matching shadows and highlights

## Quality Standards
- Photo-realistic quality
- No cartoon or illustrated effects
- Accurate body proportions
- Professional commercial photography standard

---

**Complete Generation Prompt:**

Professional virtual try-on photography, ${params.modelDescription || 'fashion model'}, wearing the provided clothing, ${params.referenceImage ? 'matching reference pose' : 'natural standing pose'}, ${params.sceneDescription || 'studio background'}, realistic fabric draping, natural fit, maintain original design and colors, photo-realistic, 8k quality, commercial fashion photography, professional lighting, sharp focus.`;
}
```

**交付物**：

- ✅ 虚拟试衣提示词模板
- ✅ 参数配置文件

#### 任务2.3：API接口扩展（3小时）

**当前问题**：

- API只支持场景生图

**解决方案**：

```typescript
interface CreateTaskRequest {
  // 模式标识
  mode: 'scene' | 'tryon' | 'wear' | 'combine';

  // === 场景生图参数 ===
  productImage?: string;
  sceneImage?: string;
  prompt?: string;

  // === 虚拟试衣参数 ===
  clothingImage?: string;
  tryonReferenceImage?: string;
  tryonPrompt?: string;

  // === 通用参数 ===
  aiModel: string;
  aspectRatio: string;
  imageCount: number;

  // === AI优化相关 ===
  promptSource?: 'USER' | 'TEMPLATE' | 'AI_OPTIMIZED';
  optimizedPrompt?: string;
}

export async function POST(request: Request) {
  const body: CreateTaskRequest = await request.json();

  // 根据mode选择处理逻辑
  switch (body.mode) {
    case 'scene':
      return await handleSceneGeneration(body);
    case 'tryon':
      return await handleVirtualTryOn(body);
    default:
      throw new Error(`Unknown mode: ${body.mode}`);
  }
}

async function handleVirtualTryOn(params: any) {
  // 构建试衣提示词
  const prompt = buildVirtualTryOnPrompt({
    clothingImage: 'CLOTHING_IMAGE_PLACEHOLDER',
    referenceImage: params.tryonReferenceImage,
    modelDescription: '年轻亚洲女性模特',
    sceneDescription: '温馨卧室场景',
  });

  // 发送到N8N
  const n8nResponse = await fetch(N8N_WEBHOOK_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ...params,
      finalPrompt: prompt,
      mode: 'tryon',
    }),
  });

  return n8nResponse;
}
```

**交付物**：

- ✅ 扩展的API接口
- ✅ 模式路由逻辑
- ✅ 参数验证

#### 任务2.4：N8N工作流更新（3小时）

**当前问题**：

- N8N只处理场景生图

**解决方案**：

```
前端Webhook → 解析参数 → 判断mode → 分发处理

如果是 scene:
  → 使用场景生图提示词 → DeerAPI生成

如果是 tryon:
  → 使用试衣提示词 → DeerAPI生成
```

**交付物**：

- ✅ 更新的N8N工作流JSON
- ✅ Mode分发节点
- ✅ 两个生成分支

**第二阶段成果**：

- ✅ 虚拟试衣功能可用
- ✅ 用户可以体验核心功能
- ✅ 前端支持模式切换

---

### 第三阶段：功能扩展（12小时）⭐⭐⭐⭐

**目标**：实现智能穿戴和自由搭配

#### 任务3.1：智能穿戴功能（6小时）

**前端**：

- 启用"智能穿戴"按钮
- 创建穿戴表单（商品图 + 参考图 + 商品类型）

**提示词**：

```typescript
export function buildSmartWearingPrompt(params: {
  productImage: string;
  referenceImage: string;
  productType: 'shoes' | 'bag' | 'watch' | 'jewelry';
}): string {
  const typeMap = {
    shoes: { position: 'feet', verb: 'wearing' },
    bag: { position: 'shoulder', verb: 'carrying' },
    watch: { position: 'wrist', verb: 'wearing' },
    jewelry: { position: 'body', verb: 'wearing' },
  };

  const target = typeMap[params.productType];

  return `# Smart Product Wearing

## Product
${params.productType} image provided

## Reference
Reference image with pose provided

## Instructions
1. Place the ${params.productType} on the ${target.position}
2. Natural size and position
3. Consistent lighting and shadows
4. Realistic integration

---

Professional product photography, model ${target.verb} ${params.productType}, natural fit, photo-realistic, 8k quality.`;
}
```

**API**：复用试衣逻辑，只是提示词不同

**交付物**：

- ✅ 智能穿戴表单
- ✅ 穿戴提示词模板
- ✅ API集成

#### 任务3.2：自由搭配功能（6小时）

**前端**：

- 启用"自由搭配"按钮
- 创建多文件上传组件（1-9张）

**提示词**：

```typescript
export function buildFreeCombinationPrompt(params: {
  materials: string[]; // 图片URLs
  combinationCount: number;
}): string {
  return `# Free Combination Generation

## Task
Generate ${params.combinationCount} unique outfit combinations from ${params.materials.length} material images.

## Materials
${params.materials.map((m, i) => `Item ${i + 1}: ${m}`).join('\n')}

## Instructions
1. Create ${params.combinationCount} distinct combinations
2. Each combination should be stylish and cohesive
3. Maximize variety across combinations
4. Professional model photography

---

Professional fashion photography, outfit combinations, ${params.combinationCount} different looks, mixing provided materials, stylish cohesive outfits, high quality, 8k resolution, commercial fashion shoot.`;
}
```

**API**：批量生成逻辑

**交付物**：

- ✅ 自由搭配表单
- ✅ 搭配提示词模板
- ✅ 批量生成逻辑

**第三阶段成果**：

- ✅ 4个功能全部可用
- ✅ 完整的用户体验

---

### 第四阶段：完善优化（8小时）⭐⭐⭐

**目标**：完善细节，提升体验

#### 任务4.1：飞书字段更新（2小时）

新增字段：

- 生成模式（scene/tryon/wear/combine）
- 服装图（试衣模式）
- 参考图（试衣/穿戴模式）
- 商品类型（穿戴模式）
- 素材数量（搭配模式）

#### 任务4.2：数据库Schema更新（2小时）

```prisma
model Task {
  // ... 现有字段

  mode GenerationMode @default(SCENE)

  // 试衣相关
  clothingImageUrl String?
  tryonReferenceImageUrl String?

  // 穿戴相关
  wearProductImageUrl String?
  wearReferenceImageUrl String?
  productType ProductType?

  // 搭配相关
  materialImageUrls String[]
  combinationCount Int?
}

enum GenerationMode {
  SCENE
  TRYON
  WEAR
  COMBINE
}
```

#### 任务4.3：用户体验优化（4小时）

- 添加模式切换动画
- 优化表单验证
- 添加错误提示
- 优化加载状态

**第四阶段成果**：

- ✅ 完整的数据记录
- ✅ 流畅的用户体验
- ✅ 系统稳定可靠

---

## 📊 工作量总结

| 阶段         | 任务                  | 工作量 | 累计       |
| ------------ | --------------------- | ------ | ---------- |
| **第一阶段** | 基础优化              | 5小时  | 5小时      |
| **第二阶段** | 核心功能（虚拟试衣）  | 15小时 | 20小时     |
| **第三阶段** | 功能扩展（穿戴+搭配） | 12小时 | 32小时     |
| **第四阶段** | 完善优化              | 8小时  | 40小时     |
| **总计**     |                       |        | **40小时** |

---

## 🎯 优先级建议

### 立即开始（第一阶段）

1. ✅ 优化场景生图提示词（2小时）
2. ✅ 添加AI对话优化（3小时）

**预期效果**：

- 场景生图质量提升50%
- 用户可以优化提示词
- 立即见效

### 第二周（第二阶段）

3. ✅ 前端界面重构（5小时）
4. ✅ 虚拟试衣提示词（4小时）
5. ✅ API接口扩展（3小时）
6. ✅ N8N工作流更新（3小时）

**预期效果**：

- 虚拟试衣功能可用
- 用户最需要的功能上线
- 核心竞争力建立

### 第三周（第三阶段）

7. ✅ 智能穿戴功能（6小时）
8. ✅ 自由搭配功能（6小时）

**预期效果**：

- 4个功能全部可用
- 完整的产品矩阵
- 市场竞争力完整

### 第四周（第四阶段）

9. ✅ 飞书和数据库更新（4小时）
10. ✅ 用户体验优化（4小时）

**预期效果**：

- 数据完整记录
- 体验流畅稳定
- 系统生产就绪

---

## ✅ 现在的行动

### 请您确认

1. **优先级顺序**是否合理？
   - P0: 场景生图优化
   - P1: 虚拟试衣
   - P2: 智能穿戴
   - P3: 自由搭配

2. **分阶段计划**是否可行？
   - 第一阶段：5小时（立即见效）
   - 第二阶段：15小时（核心功能）
   - 第三阶段：12小时（功能扩展）
   - 第四阶段：8小时（完善优化）

3. **是否开始第一阶段开发？**
   - 优化场景生图提示词
   - 添加AI对话优化

**收到您的确认后，我将立即开始第一阶段开发！**
