{
  "name": "AIæœè£…å¹³å°-å®Œæ•´å·¥ä½œæµ-åŒè§¦å‘å™¨-AIä¼˜åŒ–-å¤šæ¨¡æ¿",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ai-clothing-generation",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-frontend-trigger",
      "name": "Webhookè§¦å‘å™¨-å‰ç«¯",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-200, 300],
      "webhookId": "ai-clothing-frontend-complete"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "feishu-trigger",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-feishu-trigger",
      "name": "Webhookè§¦å‘å™¨-é£ä¹¦",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300],
      "webhookId": "feishu-trigger-complete"
    },
    {
      "parameters": {
        "resource": "auth",
        "operation": "auth:getAccessToken"
      },
      "id": "feishu-auth",
      "name": "é£ä¹¦é‰´æƒ",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [400, 300],
      "credentials": {
        "feishuCredentialsApi": {
          "id": "vMUT6XQ19LuBHj6G",
          "name": "Feishu Credentials account 3"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field-taskId",
              "name": "taskId",
              "value": "={{ $json.taskId }}",
              "type": "string"
            },
            {
              "id": "field-userId",
              "name": "userId",
              "value": "={{ $json.userId }}",
              "type": "string"
            },
            {
              "id": "field-prompt",
              "name": "prompt",
              "value": "={{ $json.prompt }}",
              "type": "string"
            },
            {
              "id": "field-optimizedPrompt",
              "name": "optimizedPrompt",
              "value": "={{ $json.optimizedPrompt }}",
              "type": "string"
            },
            {
              "id": "field-promptSource",
              "name": "promptSource",
              "value": "={{ $json.promptSource }}",
              "type": "string"
            },
            {
              "id": "field-templateType",
              "name": "templateType",
              "value": "={{ $json.templateType }}",
              "type": "string"
            },
            {
              "id": "field-productDescription",
              "name": "productDescription",
              "value": "={{ $json.productDescription }}",
              "type": "string"
            },
            {
              "id": "field-modelType",
              "name": "modelType",
              "value": "={{ $json.modelType }}",
              "type": "string"
            },
            {
              "id": "field-sceneStyle",
              "name": "sceneStyle",
              "value": "={{ $json.sceneStyle }}",
              "type": "string"
            },
            {
              "id": "field-productImageUrl",
              "name": "productImageUrl",
              "value": "={{ $json.productImageUrl }}",
              "type": "string"
            },
            {
              "id": "field-sceneImageUrl",
              "name": "sceneImageUrl",
              "value": "={{ $json.sceneImageUrl }}",
              "type": "string"
            },
            {
              "id": "field-aiModel",
              "name": "aiModel",
              "value": "={{ $json.aiModel }}",
              "type": "string"
            },
            {
              "id": "field-aspectRatio",
              "name": "aspectRatio",
              "value": "={{ $json.aspectRatio }}",
              "type": "string"
            },
            {
              "id": "field-imageCount",
              "name": "imageCount",
              "value": "={{ $json.imageCount }}",
              "type": "number"
            },
            {
              "id": "field-quality",
              "name": "quality",
              "value": "={{ $json.quality }}",
              "type": "string"
            },
            {
              "id": "field-callbackUrl",
              "name": "callbackUrl",
              "value": "={{ $json.callbackUrl }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "parse-frontend-params",
      "name": "è§£æå‰ç«¯å‚æ•°",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [0, 300]
    },
    {
      "parameters": {
        "jsCode": "// AIä¼˜åŒ–æç¤ºè¯èŠ‚ç‚¹\n// æ ¹æ®promptSourceå†³å®šæ˜¯å¦ä½¿ç”¨ä¼˜åŒ–åçš„æç¤ºè¯\nconst originalPrompt = $json.prompt;\nconst optimizedPrompt = $json.optimizedPrompt;\nconst promptSource = $json.promptSource || 'USER';\nconst templateType = $json.templateType || 'custom';\n\nlet finalPrompt;\nlet promptSourceDisplay;\nlet templateName;\n\n// æ¨¡æ¿ç±»å‹æ˜ å°„\nconst templateNames = {\n  'fashion_model': 'æœè£…æ¨¡ç‰¹å±•ç¤º',\n  'product_still': 'äº§å“é™ç‰©å±•ç¤º',\n  'layered_logic': 'åˆ†å±‚é€»è¾‘æ§åˆ¶',\n  'custom': 'è‡ªå®šä¹‰æç¤ºè¯'\n};\n\ntemplateName = templateNames[templateType] || 'è‡ªå®šä¹‰æç¤ºè¯';\n\n// å†³å®šä½¿ç”¨å“ªä¸ªæç¤ºè¯\nif (promptSource === 'AI_OPTIMIZED' && optimizedPrompt) {\n  finalPrompt = optimizedPrompt;\n  promptSourceDisplay = 'AIä¼˜åŒ–';\n} else if (promptSource === 'TEMPLATE' && originalPrompt) {\n  finalPrompt = originalPrompt; // æ¨¡æ¿å·²åœ¨åç«¯ç»„è£…\n  promptSourceDisplay = 'æ¨¡æ¿ç”Ÿæˆ';\n} else {\n  finalPrompt = originalPrompt;\n  promptSourceDisplay = 'ç”¨æˆ·è¾“å…¥';\n}\n\nreturn {\n  json: {\n    ...$json,\n    finalPrompt: finalPrompt,\n    promptSourceDisplay: promptSourceDisplay,\n    templateName: templateName,\n    promptLength: finalPrompt ? finalPrompt.length : 0\n  }\n};"
      },
      "id": "ai-optimize-prompt",
      "name": "AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [200, 300]
    },
    {
      "parameters": {
        "resource": "bitable",
        "operation": "bitable:table:record:create",
        "app_toke": "={{ $env.FEISHU_APP_TOKEN }}",
        "table_id": "={{ $env.FEISHU_TABLE_ID }}",
        "body": "={\n  \"fields\": {\n    \"æç¤ºè¯\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.prompt }}\",\n    \"ä¼˜åŒ–åæç¤ºè¯\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.optimizedPrompt || '' }}\",\n    \"æç¤ºè¯æ¥æº\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.promptSourceDisplay }}\",\n    \"æ¨¡æ¿ç±»å‹\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.templateName || 'è‡ªå®šä¹‰' }}\",\n    \"äº§å“æè¿°\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.productDescription || '' }}\",\n    \"æ¨¡ç‰¹ç±»å‹\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.modelType || '' }}\",\n    \"åœºæ™¯é£æ ¼\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.sceneStyle || '' }}\",\n    \"å•†å“å›¾\": [{\n      \"url\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.productImageUrl }}\"\n    }],\n    \"åœºæ™¯å›¾\": {{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.sceneImageUrl ? '[{\"url\": \"' + $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.sceneImageUrl + '\"}]' : '[]' }},\n    \"çŠ¶æ€\": \"å¾…å¤„ç†\",\n    \"æ•°æ®æ¥æº\": \"ğŸŒ å‰ç«¯ç”¨æˆ·\",\n    \"åŒæ­¥çŠ¶æ€\": \"âœ… å·²åŒæ­¥\",\n    \"å‰ç«¯ç”¨æˆ·ID\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.userId }}\",\n    \"AIæ¨¡å‹\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.aiModel }}\",\n    \"å°ºå¯¸æ¯”ä¾‹\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.aspectRatio }}\",\n    \"ç”Ÿæˆæ•°é‡\": {{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.imageCount }},\n    \"æç¤ºè¯é•¿åº¦\": {{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.promptLength || 0 }}\n  }\n}"
      },
      "id": "create-feishu-record",
      "name": "åˆ›å»ºé£ä¹¦è®°å½•",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [400, 300],
      "credentials": {
        "feishuCredentialsApi": {
          "id": "vMUT6XQ19LuBHj6G",
          "name": "Feishu Credentials account 3"
        }
      },
      "continueOnFail": true,
      "retryOnFail": true,
      "maxTries": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field-feishuRecordId",
              "name": "feishuRecordId",
              "value": "={{ $json.data ? $json.data.record_id : '' }}",
              "type": "string"
            },
            {
              "id": "field-feishuAppToken",
              "name": "feishuAppToken",
              "value": "={{ $env.FEISHU_APP_TOKEN }}",
              "type": "string"
            },
            {
              "id": "field-feishuTableId",
              "name": "feishuTableId",
              "value": "={{ $env.FEISHU_TABLE_ID }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "extract-feishu-record-id",
      "name": "æå–é£ä¹¦è®°å½•ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [600, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field-aspectRatio-clean",
              "name": "aspectRatioClean",
              "value": "={{ $json.aspectRatio.trim().replace(/ï¼š/g, ':').replace(/ï¼Œ/g, ',') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "clean-aspect-ratio",
      "name": "æ ‡å‡†åŒ–å°ºå¯¸å‚æ•°",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [800, 300]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.aspectRatioClean }}",
                    "rightValue": "\"3:4\"",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "check-3to4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "3to4"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "check-1to1",
                    "leftValue": "={{ $json.aspectRatioClean }}",
                    "rightValue": "\"1:1\"",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "1to1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "check-16to9",
                    "leftValue": "={{ $json.aspectRatioClean }}",
                    "rightValue": "\"16:9\"",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "16to9"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "check-9to16",
                    "leftValue": "={{ $json.aspectRatioClean }}",
                    "rightValue": "\"9:16\"",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "9to16"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [1000, 300],
      "id": "switch-aspect-ratio"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "width-1to1",
              "name": "width",
              "value": 1024,
              "type": "number"
            },
            {
              "id": "height-1to1",
              "name": "height",
              "value": 1024,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "size-1to1",
      "name": "1:1å°ºå¯¸",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1200, 450]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "width-3to4",
              "name": "width",
              "value": 768,
              "type": "number"
            },
            {
              "id": "height-3to4",
              "name": "height",
              "value": 1024,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "size-3to4",
      "name": "3:4å°ºå¯¸",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1200, 350]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "width-16to9",
              "name": "width",
              "value": 1344,
              "type": "number"
            },
            {
              "id": "height-16to9",
              "name": "height",
              "value": 768,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "size-16to9",
      "name": "16:9å°ºå¯¸",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1200, 550]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "width-9to16",
              "name": "width",
              "value": 768,
              "type": "number"
            },
            {
              "id": "height-9to16",
              "name": "height",
              "value": 1344,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "size-9to16",
      "name": "9:16å°ºå¯¸",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1200, 650]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "width-default",
              "name": "width",
              "value": 768,
              "type": "number"
            },
            {
              "id": "height-default",
              "name": "height",
              "value": 1024,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "size-default",
      "name": "é»˜è®¤å°ºå¯¸(3:4)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1200, 750]
    },
    {
      "parameters": {
        "url": "=https://api.deerapi.com/",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer sk-VudNMyMqsnsbSPAWoYUyxc6aJJgCVLXvLvHI97lkR3DlXmST"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.aiModel }}\",\n  \"prompt\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.finalPrompt }}\",\n  \"image\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.productImageUrl }}\",\n  \"width\": 768,\n  \"height\": 1024,\n  \"num_images\": 1\n}",
        "options": {}
      },
      "id": "ai-generation-frontend",
      "name": "AIå›¾ç‰‡ç”Ÿæˆ-å‰ç«¯",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1400, 350]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "result-images",
              "name": "resultImageUrls",
              "value": "={{ $json.data.images }}",
              "type": "array"
            },
            {
              "id": "status-completed",
              "name": "status",
              "value": "completed",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "format-result",
      "name": "æ ¼å¼åŒ–ç»“æœ",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1600, 350]
    },
    {
      "parameters": {
        "resource": "bitable",
        "operation": "bitable:table:record:update",
        "app_toke": "={{ $('æå–é£ä¹¦è®°å½•ID').item.json.feishuAppToken }}",
        "table_id": "={{ $('æå–é£ä¹¦è®°å½•ID').item.json.feishuTableId }}",
        "record_id": "={{ $('æå–é£ä¹¦è®°å½•ID').item.json.feishuRecordId }}",
        "body": "={\n  \"fields\": {\n    \"ç”Ÿæˆç»“æœ\": {{ $('æ ¼å¼åŒ–ç»“æœ').item.json.resultImageUrls.map(url => '{\"url\": \"' + url + '\"}').join(', ') ? '[' + $('æ ¼å¼åŒ–ç»“æœ').item.json.resultImageUrls.map(url => '{\"url\": \"' + url + '\"}').join(', ') + ']' : '[]' }},\n    \"çŠ¶æ€\": \"å·²å®Œæˆ\",\n    \"åŒæ­¥çŠ¶æ€\": \"âœ… å·²åŒæ­¥\",\n    \"è¿›åº¦\": 100\n  }\n}",
        "options": {}
      },
      "id": "update-feishu-record",
      "name": "æ›´æ–°é£ä¹¦è®°å½•",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [1800, 350],
      "credentials": {
        "feishuCredentialsApi": {
          "id": "vMUT6XQ19LuBHj6G",
          "name": "Feishu Credentials account 3"
        }
      },
      "continueOnFail": true,
      "retryOnFail": true,
      "maxTries": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Webhookè§¦å‘å™¨-å‰ç«¯').item.json.body.callbackUrl }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"taskId\": \"{{ $('è§£æå‰ç«¯å‚æ•°').item.json.taskId }}\",\n  \"status\": \"completed\",\n  \"resultImageUrls\": \"{{ $json.resultImageUrls }}\",\n  \"progress\": 100,\n  \"promptSource\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.promptSourceDisplay }}\",\n  \"templateType\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.templateName }}\"\n}",
        "options": {}
      },
      "id": "callback-frontend",
      "name": "å›è°ƒå‰ç«¯API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 350],
      "credentials": {
        "httpHeaderAuth": {
          "id": "LGhdLnHpPFKUSGuA",
          "name": "Header Auth account 2"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"taskId\": \"{{ $('è§£æå‰ç«¯å‚æ•°').item.json.taskId }}\",\n  \"message\": \"å›¾ç‰‡ç”ŸæˆæˆåŠŸ\",\n  \"promptSource\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.promptSourceDisplay }}\",\n  \"templateType\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯').item.json.templateName }}\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-frontend-success",
      "name": "è¿”å›å‰ç«¯æˆåŠŸå“åº”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2200, 350]
    },
    {
      "parameters": {
        "resource": "bitable",
        "operation": "bitable:table:record:get",
        "app_toke": "={{ $json.body.app_token }}",
        "table_id": "={{ $json.body.table_id }}",
        "record_id": "={{ $json.body.record_id }}"
      },
      "id": "get-feishu-record",
      "name": "è·å–é£ä¹¦è®°å½•",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [400, 300],
      "credentials": {
        "feishuCredentialsApi": {
          "id": "vMUT6XQ19LuBHj6G",
          "name": "Feishu Credentials account 3"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field-recordId",
              "name": "record_id",
              "value": "={{ $('Webhookè§¦å‘å™¨-é£ä¹¦').item.json.body.record_id }}",
              "type": "string"
            },
            {
              "id": "field-appToken",
              "name": "app_token",
              "value": "={{ $('Webhookè§¦å‘å™¨-é£ä¹¦').item.json.body.app_token }}",
              "type": "string"
            },
            {
              "id": "field-tableId",
              "name": "table_id",
              "value": "={{ $('Webhookè§¦å‘å™¨-é£ä¹¦').item.json.body.table_id }}",
              "type": "string"
            },
            {
              "id": "field-prompt-feishu",
              "name": "prompt",
              "value": "={{ $json.data.records[0].fields['æç¤ºè¯'][0].text }}",
              "type": "string"
            },
            {
              "id": "field-optimizedPrompt-feishu",
              "name": "optimizedPrompt",
              "value": "={{ $json.data.records[0].fields['ä¼˜åŒ–åæç¤ºè¯'] && $json.data.records[0].fields['ä¼˜åŒ–åæç¤ºè¯'][0].text || '' }}",
              "type": "string"
            },
            {
              "id": "field-promptSource-feishu",
              "name": "promptSource",
              "value": "={{ $json.data.records[0].fields['æç¤ºè¯æ¥æº'] || 'ç”¨æˆ·è¾“å…¥' }}",
              "type": "string"
            },
            {
              "id": "field-templateType-feishu",
              "name": "templateType",
              "value": "={{ $json.data.records[0].fields['æ¨¡æ¿ç±»å‹'] || 'è‡ªå®šä¹‰' }}",
              "type": "string"
            },
            {
              "id": "field-productImageUrl-feishu",
              "name": "productImageUrl",
              "value": "={{ $json.data.records[0].fields['å•†å“å›¾'][0].url }}",
              "type": "string"
            },
            {
              "id": "field-sceneImageUrl-feishu",
              "name": "sceneImageUrl",
              "value": "={{ $json.data.records[0].fields['åœºæ™¯å›¾'] && $json.data.records[0].fields['åœºæ™¯å›¾'][0].url || '' }}",
              "type": "string"
            },
            {
              "id": "field-aspectRatio-feishu",
              "name": "aspectRatio",
              "value": "={{ $json.data.records[0].fields['å°ºå¯¸æ¯”ä¾‹'] || '3:4' }}",
              "type": "string"
            },
            {
              "id": "field-aiModel-feishu",
              "name": "aiModel",
              "value": "={{ $json.data.records[0].fields['AIæ¨¡å‹'] || 'Gemini-3-Pro-Image' }}",
              "type": "string"
            },
            {
              "id": "field-imageCount-feishu",
              "name": "imageCount",
              "value": "={{ $json.data.records[0].fields['ç”Ÿæˆæ•°é‡'] || 4 }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "extract-feishu-params",
      "name": "æå–é£ä¹¦å‚æ•°",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [600, 300]
    },
    {
      "parameters": {
        "jsCode": "// AIä¼˜åŒ–æç¤ºè¯èŠ‚ç‚¹ï¼ˆé£ä¹¦è½¨é“ï¼‰\nconst originalPrompt = $json.prompt;\nconst optimizedPrompt = $json.optimizedPrompt;\nconst promptSource = $json.promptSource || 'ç”¨æˆ·è¾“å…¥';\nconst templateType = $json.templateType || 'è‡ªå®šä¹‰';\n\nlet finalPrompt;\n\n// æ¨¡æ¿ç±»å‹æ˜ å°„\nconst templateNames = {\n  'æœè£…æ¨¡ç‰¹å±•ç¤º': 'fashion_model',\n  'äº§å“é™ç‰©å±•ç¤º': 'product_still',\n  'åˆ†å±‚é€»è¾‘æ§åˆ¶': 'layered_logic',\n  'è‡ªå®šä¹‰': 'custom'\n};\n\n// å†³å®šä½¿ç”¨å“ªä¸ªæç¤ºè¯\nif (promptSource === 'AIä¼˜åŒ–' && optimizedPrompt) {\n  finalPrompt = optimizedPrompt;\n} else if (promptSource === 'æ¨¡æ¿ç”Ÿæˆ' && originalPrompt) {\n  finalPrompt = originalPrompt; // æ¨¡æ¿å·²åœ¨åç«¯ç»„è£…\n} else {\n  finalPrompt = originalPrompt;\n}\n\nreturn {\n  json: {\n    ...$json,\n    finalPrompt: finalPrompt,\n    templateType: templateNames[templateType] || 'custom',\n    promptLength: finalPrompt ? finalPrompt.length : 0\n  }\n};"
      },
      "id": "ai-optimize-prompt-feishu",
      "name": "AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯-é£ä¹¦",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 300]
    },
    {
      "parameters": {
        "resource": "bitable",
        "operation": "bitable:table:record:update",
        "app_toke": "={{ $('æå–é£ä¹¦å‚æ•°').item.json.app_token }}",
        "table_id": "={{ $('æå–é£ä¹¦å‚æ•°').item.json.table_id }}",
        "record_id": "={{ $('æå–é£ä¹¦å‚æ•°').item.json.record_id }}",
        "body": "={\n  \"fields\": {\n    \"çŠ¶æ€\": \"å¤„ç†ä¸­\",\n    \"åŒæ­¥çŠ¶æ€\": \"ğŸ”„ åŒæ­¥ä¸­\",\n    \"æç¤ºè¯é•¿åº¦\": {{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯-é£ä¹¦').item.json.promptLength || 0 }}\n  }\n}"
      },
      "id": "update-feishu-processing",
      "name": "æ›´æ–°é£ä¹¦çŠ¶æ€-å¤„ç†ä¸­",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [1000, 300],
      "credentials": {
        "feishuCredentialsApi": {
          "id": "vMUT6XQ19LuBHj6G",
          "name": "Feishu Credentials account 3"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.productImageUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('é£ä¹¦é‰´æƒ').item.json.accessToken }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "download-product-image",
      "name": "ä¸‹è½½å•†å“å›¾ç‰‡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [1200, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.sceneImageUrl }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              },
              "id": "check-scene-image"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-scene-image",
      "name": "åˆ¤æ–­æ˜¯å¦æœ‰åœºæ™¯å›¾",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [1400, 300]
    },
    {
      "parameters": {
        "url": "={{ $json.sceneImageUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('é£ä¹¦é‰´æƒ').item.json.accessToken }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "data2"
            }
          }
        }
      },
      "id": "download-scene-image",
      "name": "ä¸‹è½½åœºæ™¯å›¾",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [1200, 150]
    },
    {
      "parameters": {
        "mode": "image",
        "userPrompt": "={{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯-é£ä¹¦').item.json.finalPrompt }}æ³¨æ„ï¼šç¬¬ä¸€å¼ å›¾ç‰‡æ˜¯äº§å“å›¾ï¼Œç¬¬äºŒå¼ å›¾ç‰‡æ˜¯åœºæ™¯å›¾ã€‚è¯·ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡ï¼ˆäº§å“å›¾ï¼‰å’Œç¬¬äºŒå¼ å›¾ç‰‡ï¼ˆåœºæ™¯å›¾ï¼‰è¿›è¡Œç”Ÿæˆã€‚",
        "aspectRatio": "={{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯-é£ä¹¦').item.json.aspectRatio }}"
      },
      "id": "ai-generation",
      "name": "AIå›¾ç‰‡ç”Ÿæˆ",
      "type": "n8n-nodes-deerapi.deerApi",
      "typeVersion": 1,
      "position": [1600, 300],
      "credentials": {
        "deerApi": {
          "id": "LbaMt4eRjzXDjQva",
          "name": "DeerAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  if (item.binary && item.binary.data) {\n    const buffer = await this.helpers.getBinaryDataBuffer(i, 'data');\n    item.json.real_size = buffer.length;\n    item.json.file_name = 'final_product.png';\n  }\n}\nreturn items;"
      },
      "id": "process-result",
      "name": "å¤„ç†ç”Ÿæˆç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://open.feishu.cn/open-apis/drive/v1/medias/upload_all",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "={\n  \"Authorization\": \"Bearer {{ $('é£ä¹¦é‰´æƒ').item.json.accessToken }}\"\n}",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "parent_type",
              "value": "bitable_image"
            },
            {
              "name": "parent_node",
              "value": "={{ $('æå–é£ä¹¦å‚æ•°').item.json.app_token }}"
            },
            {
              "name": "file_name",
              "value": "={{ $json.file_name }}"
            },
            {
              "name": "size",
              "value": "={{ $json.real_size }}"
            },
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {}
      },
      "id": "upload-to-feishu",
      "name": "ä¸Šä¼ åˆ°é£ä¹¦",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "resource": "bitable",
        "operation": "bitable:table:record:update",
        "app_toke": "={{ $('æå–é£ä¹¦å‚æ•°').item.json.app_token }}",
        "table_id": "={{ $('æå–é£ä¹¦å‚æ•°').item.json.table_id }}",
        "record_id": "={{ $('æå–é£ä¹¦å‚æ•°').item.json.record_id }}",
        "body": "={\n  \"fields\": {\n    \"ç”Ÿæˆç»“æœ\": [\n      {\n        \"file_token\": \"{{ $json.data.file_token }}\"\n      }\n    ],\n    \"çŠ¶æ€\": \"å·²å®Œæˆ\",\n    \"åŒæ­¥çŠ¶æ€\": \"âœ… å·²åŒæ­¥\"\n  }\n}"
      },
      "id": "update-feishu-result",
      "name": "æ›´æ–°é£ä¹¦ç»“æœ",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [2200, 300],
      "credentials": {
        "feishuCredentialsApi": {
          "id": "vMUT6XQ19LuBHj6G",
          "name": "Feishu Credentials account 3"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"recordId\": \"{{ $('æå–é£ä¹¦å‚æ•°').item.json.record_id }}\",\n  \"message\": \"å›¾ç‰‡ç”ŸæˆæˆåŠŸ\",\n  \"promptSource\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯-é£ä¹¦').item.json.promptSource }}\",\n  \"templateType\": \"{{ $('AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯-é£ä¹¦').item.json.templateType }}\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-feishu-success",
      "name": "è¿”å›é£ä¹¦æˆåŠŸå“åº”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2400, 300]
    }
  ],
  "connections": {
    "Webhookè§¦å‘å™¨-å‰ç«¯": {
      "main": [
        [
          {
            "node": "è§£æå‰ç«¯å‚æ•°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhookè§¦å‘å™¨-é£ä¹¦": {
      "main": [
        [
          {
            "node": "é£ä¹¦é‰´æƒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é£ä¹¦é‰´æƒ": {
      "main": [
        [
          {
            "node": "è·å–é£ä¹¦è®°å½•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–é£ä¹¦è®°å½•": {
      "main": [
        [
          {
            "node": "æå–é£ä¹¦å‚æ•°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æå–é£ä¹¦å‚æ•°": {
      "main": [
        [
          {
            "node": "AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯-é£ä¹¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯-é£ä¹¦": {
      "main": [
        [
          {
            "node": "æ›´æ–°é£ä¹¦çŠ¶æ€-å¤„ç†ä¸­",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°é£ä¹¦çŠ¶æ€-å¤„ç†ä¸­": {
      "main": [
        [
          {
            "node": "ä¸‹è½½å•†å“å›¾ç‰‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸‹è½½å•†å“å›¾ç‰‡": {
      "main": [
        [
          {
            "node": "åˆ¤æ–­æ˜¯å¦æœ‰åœºæ™¯å›¾",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–­æ˜¯å¦æœ‰åœºæ™¯å›¾": {
      "main": [
        [
          {
            "node": "ä¸‹è½½åœºæ™¯å›¾",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AIå›¾ç‰‡ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸‹è½½åœºæ™¯å›¾": {
      "main": [
        [
          {
            "node": "AIå›¾ç‰‡ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIå›¾ç‰‡ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "å¤„ç†ç”Ÿæˆç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤„ç†ç”Ÿæˆç»“æœ": {
      "main": [
        [
          {
            "node": "ä¸Šä¼ åˆ°é£ä¹¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸Šä¼ åˆ°é£ä¹¦": {
      "main": [
        [
          {
            "node": "æ›´æ–°é£ä¹¦ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°é£ä¹¦ç»“æœ": {
      "main": [
        [
          {
            "node": "è¿”å›é£ä¹¦æˆåŠŸå“åº”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æå‰ç«¯å‚æ•°": {
      "main": [
        [
          {
            "node": "AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIä¼˜åŒ–-é€‰æ‹©æœ€ç»ˆæç¤ºè¯": {
      "main": [
        [
          {
            "node": "åˆ›å»ºé£ä¹¦è®°å½•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ›å»ºé£ä¹¦è®°å½•": {
      "main": [
        [
          {
            "node": "æå–é£ä¹¦è®°å½•ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æå–é£ä¹¦è®°å½•ID": {
      "main": [
        [
          {
            "node": "æ ‡å‡†åŒ–å°ºå¯¸å‚æ•°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ ‡å‡†åŒ–å°ºå¯¸å‚æ•°": {
      "main": [
        [
          {
            "node": "switch-aspect-ratio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "switch-aspect-ratio": {
      "main": [
        [
          {
            "node": "3:4å°ºå¯¸",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "1:1å°ºå¯¸",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "16:9å°ºå¯¸",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "9:16å°ºå¯¸",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "é»˜è®¤å°ºå¯¸(3:4)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1:1å°ºå¯¸": {
      "main": [
        [
          {
            "node": "AIå›¾ç‰‡ç”Ÿæˆ-å‰ç«¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3:4å°ºå¯¸": {
      "main": [
        [
          {
            "node": "AIå›¾ç‰‡ç”Ÿæˆ-å‰ç«¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "16:9å°ºå¯¸": {
      "main": [
        [
          {
            "node": "AIå›¾ç‰‡ç”Ÿæˆ-å‰ç«¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9:16å°ºå¯¸": {
      "main": [
        [
          {
            "node": "AIå›¾ç‰‡ç”Ÿæˆ-å‰ç«¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é»˜è®¤å°ºå¯¸(3:4)": {
      "main": [
        [
          {
            "node": "AIå›¾ç‰‡ç”Ÿæˆ-å‰ç«¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIå›¾ç‰‡ç”Ÿæˆ-å‰ç«¯": {
      "main": [
        [
          {
            "node": "æ ¼å¼åŒ–ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ ¼å¼åŒ–ç»“æœ": {
      "main": [
        [
          {
            "node": "æ›´æ–°é£ä¹¦è®°å½•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°é£ä¹¦è®°å½•": {
      "main": [
        [
          {
            "node": "å›è°ƒå‰ç«¯API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å›è°ƒå‰ç«¯API": {
      "main": [
        [
          {
            "node": "è¿”å›å‰ç«¯æˆåŠŸå“åº”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "id": "ai-clothing-platform-complete-workflow",
  "tags": [],
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "complete-workflow-v1"
  }
}
