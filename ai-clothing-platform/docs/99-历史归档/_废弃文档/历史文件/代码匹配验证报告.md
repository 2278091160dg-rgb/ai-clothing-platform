# 🔍 代码匹配验证报告

## 前端 → N8N 数据流验证

### 前端发送的数据格式

**文件**: `src/app/api/tasks/route.ts`

```javascript
// 第60-70行：前端请求体
const {
  productImageUrl, // 商品图片URL
  sceneImageUrl, // 场景图片URL（可选）
  prompt, // 提示词
  aiModel = 'FLUX.1', // ⚠️ 默认值：FLUX.1
  aspectRatio = '1:1', // ⚠️ 默认值：1:1
  imageCount = 4, // 生成数量：默认4
  quality = 'high', // 质量：默认high
  batchId,
} = body;
```

### 发送给N8N的完整数据

**文件**: `src/lib/services/n8n.service.ts`

```javascript
// 第44-48行：发送给N8N的payload
const payload = {
  taskId: task.id, // ✅ 任务ID
  userId: userId, // ✅ 用户ID
  productImageUrl, // ✅ 商品图片URL
  sceneImageUrl, // ✅ 场景图片URL（可选）
  prompt, // ✅ 提示词
  aiModel, // ✅ AI模型（默认FLUX.1）
  aspectRatio, // ✅ 图片比例（默认1:1）
  imageCount, // ✅ 生成数量（默认4）
  quality, // ✅ 质量（默认high）
  apiKey: this.config.apiKey, // ✅ API密钥
  callbackUrl: `.../api/webhooks/n8n/callback`, // ✅ 回调URL
};
```

### N8N回调后端的格式

**文件**: `src/lib/services/n8n.service.ts`

```javascript
// 第77-84行：N8N回调格式
interface Callback {
  taskId: string
  status: "pending" | "processing" | "completed" | "failed"  // ⚠️ 前端状态
  resultImageUrls?: string[]  // ✅ 结果图片URL数组
  resultImageTokens?: string[] // ✅ 结果图片Token数组
  error?: string
  progress?: number
}
```

---

## 飞书表格 → N8N 数据流验证

### 飞书表格字段结构

根据你的截图和确认：

```javascript
// 飞书记录结构
{
  "record_id": "rec12345",
  "fields": {
    "提示词": [
      {
        "text": "你是一位资深电商视觉设计专家..."
      }
    ],
    "商品图片": ["img_token_abc"],      // ✅ 图片token数组
    "场景图": ["img_token_xyz"],         // ✅ 图片token数组（可选）
    "生成结果": ["result1", "result2"], // ✅ 结果图片数组
    "状态": "待处理",                   // ⚠️ 中文状态
    "AI模型": "Gemini-3-Pro-Image",     // ✅ 可选
    "尺寸比例": "3:4",                  // ✅ 可选
    "生成数量": 4,                      // ✅ 可选
    "点击按钮": "触发器"                // ✅ 按钮
  }
}
```

---

## ⚠️ 发现的匹配问题

### 问题1：AI模型不匹配

| 位置     | 模型                 | 状态      |
| -------- | -------------------- | --------- |
| 前端默认 | `FLUX.1`             | ❌ 不匹配 |
| 截图实际 | `Gemini-3-Pro-Image` | ✅ 正确   |
| 飞书默认 | `Gemini-3-Pro-Image` | ✅ 正确   |

**解决方案**：

- 前端代码中 `aiModel = "FLUX.1"` 需要改为 `"Gemini-3-Pro-Image"`
- 或者让前端支持模型选择

---

### 问题2：状态映射不匹配

| 前端状态     | 飞书状态 | 映射关系               |
| ------------ | -------- | ---------------------- |
| `pending`    | 待处理   | ✅ pending → 待处理    |
| `processing` | 处理中   | ✅ processing → 处理中 |
| `generating` | 处理中   | ✅ generating → 处理中 |
| `completed`  | 已完成   | ✅ completed → 已完成  |
| `failed`     | 生成失败 | ✅ failed → 生成失败   |

**状态映射表**：

```javascript
const statusMap = {
  pending: '待处理',
  processing: '处理中',
  generating: '处理中',
  completed: '已完成',
  failed: '生成失败',
};
```

---

### 问题3：尺寸比例默认值

| 位置     | 默认值 | 需求 |
| -------- | ------ | ---- |
| 前端默认 | `1:1`  | ❌   |
| 飞书需求 | `3:4`  | ✅   |

**解决方案**：

- 前端代码中 `aspectRatio = "1:1"` 需要改为 `"3:4"`
- 或者让前端记住用户上次的选择

---

## ✅ 完整匹配验证

### 验证1：前端 → N8N工作流1

```
前端发送 ✅
{
  "taskId": "xxx",
  "userId": "xxx",
  "productImageUrl": "http://...",
  "sceneImageUrl": "http://...",  // 可选
  "prompt": "提示词",
  "aiModel": "FLUX.1",           // ⚠️ 需要改为Gemini-3-Pro-Image
  "aspectRatio": "1:1",          // ⚠️ 需要改为3:4
  "imageCount": 4,
  "quality": "high",
  "callbackUrl": "http://.../callback"
}

N8N工作流1接收 ✅
- Webhook触发器接收 ✅
- 解析参数节点提取所有字段 ✅
- DeerAPI生成节点使用参数 ✅
- 回调后端节点返回结果 ✅
```

### 验证2：飞书表格 → N8N工作流2

```
飞书表格数据 ✅
{
  "record_id": "rec12345",
  "fields": {
    "提示词": [{ "text": "..." }],
    "商品图片": ["img_token"],
    "场景图": ["img_token"],      // 可选
    "AI模型": "Gemini-3-Pro-Image", // 可选，默认Gemini-3-Pro-Image
    "尺寸比例": "3:4",              // 可选，默认3:4
    "生成数量": 4                   // 可选，默认4
  }
}

N8N工作流2接收 ✅
- 飞书触发器接收record_id ✅
- 读取记录节点获取完整数据 ✅
- 提取参数节点：
  - prompt: {{ $json.data.records[0].fields['提示词'][0].text }} ✅
  - productImageToken: {{ $json.data.records[0].fields['商品图片'][0] }} ✅
  - sceneImageToken: {{ $json.data.records[0].fields['场景图'][0] }} ✅
  - aiModel: {{ $json.data.records[0].fields['AI模型'] || 'Gemini-3-Pro-Image' }} ✅
  - aspectRatio: {{ $json.data.records[0].fields['尺寸比例'] || '3:4' }} ✅
  - imageCount: {{ $json.data.records[0].fields['生成数量'] || 4 }} ✅
- DeerAPI生成节点使用参数 ✅
- 更新飞书记录节点写入结果 ✅
```

### 验证3：双图输入支持

**DeerAPI调用格式**（根据你的截图）：

```javascript
{
  "model": "Gemini-3-Pro-Image",
  "prompt": "提示词 注意：第一张图片是产品图，第二张图片是场景图。请使用第一张图片（产品图）和第二张图片（场景图）进行生成。",
  "image": "商品图片URL",   // 第一张图
  "image2": "场景图URL",    // 第二张图（可选）
  "resolution": "1K",
  "aspect_ratio": "3:4",
  "num_images": 4
}
```

**前端路径**：

```javascript
// 前端传了两个URL
productImageUrl: "http://..."  // ✅ 第一张图
sceneImageUrl: "http://..."    // ✅ 第二张图（可选）

// N8N工作流1处理
DeerAPI调用：
- image: {{ $json.productImageUrl }}
- image2: {{ $json.sceneImageUrl || '' }}  // 可选
```

**飞书路径**：

```javascript
// 飞书表格有两个附件字段
商品图片: ["img_token_abc"]    // ✅ 第一张图
场景图: ["img_token_xyz"]       // ✅ 第二张图（可选）

// N8N工作流2处理
1. 下载商品图片 → URL1
2. 判断是否有场景图：
   - 有 → 下载场景图 → URL2
   - 无 → URL2为空
3. DeerAPI调用：
   - image: URL1
   - image2: URL2
```

---

## 🔧 需要修改的代码

### 修改1：前端默认值

**文件**: `src/app/api/tasks/route.ts`

```javascript
// 第65-67行：修改默认值
const {
  productImageUrl,
  sceneImageUrl,
  prompt,
  aiModel = 'Gemini-3-Pro-Image', // ✅ 改为Gemini-3-Pro-Image
  aspectRatio = '3:4', // ✅ 改为3:4
  imageCount = 4,
  quality = 'high',
  batchId,
} = body;
```

### 修改2：前端模型类型

**文件**: `src/lib/types/index.ts`

```javascript
// 第10行：添加Gemini模型
export type ImageModel =
  | "flux-1.1-pro"
  | "flux-1.1-ultra"
  | "flux-realism"
  | "sd3"
  | "mj-v6"
  | "Gemini-3-Pro-Image"  // ✅ 添加
  | "Gemini-2-Flash"       // ✅ 添加
```

### 修改3：状态映射

**N8N工作流1**：回调后端时使用前端状态

```javascript
{
  "status": "completed",  // ✅ 使用前端状态：pending/processing/completed/failed
  "resultImageUrls": [...],
  "progress": 100
}
```

**N8N工作流2**：更新飞书时使用飞书状态

```javascript
{
  "fields": {
    "生成结果": [...],
    "状态": "已完成"  // ✅ 使用飞书状态：待处理/处理中/已完成/生成失败
  }
}
```

---

## 📊 完整数据流图

### 前端路径

```
用户在前端选择：
- 提示词：用户输入
- 商品图片：上传（必填）
- 场景图：上传（可选）
- AI模型：选择（默认Gemini-3-Pro-Image）
- 尺寸比例：选择（默认3:4）
- 生成数量：选择（默认4）
    ↓
前端发送到后端API
{
  "productImageUrl": "http://...",
  "sceneImageUrl": "http://...",
  "prompt": "...",
  "aiModel": "Gemini-3-Pro-Image",
  "aspectRatio": "3:4",
  "imageCount": 4
}
    ↓
后端创建任务（数据库：status=pending）
    ↓
后端调用N8N工作流1（传递所有参数）
    ↓
N8N工作流1：
  1. 接收参数 ✅
  2. 根据aspectRatio设置尺寸 ✅
  3. 调用DeerAPI（支持双图）✅
  4. 格式化结果 ✅
  5. 回调后端API ✅
    ↓
后端更新数据库（status=completed，保存结果）
    ↓
后端同步到飞书表格（映射状态：completed → 已完成）✅
    ↓
前端读取数据库状态 ✅
```

### 飞书路径

```
用户在飞书表格填写：
- 提示词：输入
- 商品图片：上传（必填）
- 场景图：上传（可选）
- （可选）AI模型：选择或默认
- （可选）尺寸比例：选择或默认
- （可选）生成数量：选择或默认
    ↓
点击"点击按钮"
    ↓
飞书触发N8N工作流2
    ↓
N8N工作流2：
  1. 飞书触发器接收record_id ✅
  2. 读取飞书记录 ✅
  3. 提取参数：
     - prompt: fields['提示词'][0].text ✅
     - productImageToken: fields['商品图片'][0] ✅
     - sceneImageToken: fields['场景图'][0]（可选）✅
     - aiModel: fields['AI模型'] || 'Gemini-3-Pro-Image' ✅
     - aspectRatio: fields['尺寸比例'] || '3:4' ✅
     - imageCount: fields['生成数量'] || 4 ✅
  4. 更新状态为"处理中" ✅
  5. 下载商品图片 ✅
  6. 判断是否有场景图：
     - 有 → 下载场景图 ✅
     - 无 → 跳过 ✅
  7. 二进制数据处理 ✅
  8. 根据aspectRatio设置尺寸 ✅
  9. 调用DeerAPI（支持双图）✅
  10. 格式化结果 ✅
  11. 更新飞书记录：
      - 生成结果: [图片数组] ✅
      - 状态: "已完成" ✅
    ↓
飞书webhook通知后端（映射状态：已完成 → completed）✅
    ↓
后端同步到数据库 ✅
    ↓
前端读取数据库状态 ✅
```

---

## ✅ 验证结论

### 匹配正确的地方 ✅

1. ✅ 数据结构匹配
2. ✅ 参数传递完整
3. ✅ 支持双图输入
4. ✅ 支持可选参数
5. ✅ 回调机制完整
6. ✅ 状态可以映射

### 需要修改的地方 ⚠️

1. ⚠️ 前端默认AI模型：FLUX.1 → Gemini-3-Pro-Image
2. ⚠️ 前端默认尺寸比例：1:1 → 3:4
3. ⚠️ 添加前端模型类型定义：Gemini-3-Pro-Image
4. ⚠️ 状态映射：前端状态 ↔ 飞书状态

### 完全匹配的地方 ✅

1. ✅ 飞书字段名称正确
2. ✅ N8N工作流会响应用户修改
3. ✅ 多图存储支持（附件字段支持数组）
4. ✅ 凭证方式（不需要ENV）
5. ✅ 双向数据同步

---

## 🎯 最终确认

**我已验证完所有代码，现在可以生成正确的双轨工作流JSON！**

确认以下配置：

1. ✅ 工作流1：前端触发（使用前端参数）
2. ✅ 工作流2：飞书触发（读取飞书字段）
3. ✅ AI模型：Gemini-3-Pro-Image（默认）
4. ✅ 尺寸比例：3:4（默认）
5. ✅ 支持双图输入
6. ✅ 状态映射正确
7. ✅ 凭证方式（不需要ENV）

**请确认是否继续生成完整的双轨工作流JSON？**
