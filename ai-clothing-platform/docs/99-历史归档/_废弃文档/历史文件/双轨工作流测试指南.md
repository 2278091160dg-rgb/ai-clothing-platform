# 🧪 N8N双轨工作流测试指南

## 📅 测试时间

2025-01-27

---

## 🎯 测试前准备

### 准备工作清单

- [ ] N8N已启动并可以访问
- [ ] 两个工作流已导入并激活
- [ ] 凭证已配置（Feishu + DeerAPI）
- [ ] 飞书自动化已配置并启用
- [ ] 后端服务正在运行（前端测试需要）

### 需要准备的数据

**测试图片**:

- 商品图片URL：需要一张有效的图片URL
- 场景图片URL：可选，第二张图片URL

**测试提示词**:

```
时尚模特在繁华街头
```

---

## 📋 测试1：前端工作流

### 测试目标

验证前端触发工作流是否正常工作。

### 步骤1：检查N8N工作流状态（1分钟）

1. 打开N8N界面
2. 找到工作流：**AI场景图生成工作流-前端触发**
3. 检查右上角状态：
   - ✅ 显示为 **Active**（已激活）
   - ❌ 如果是 **Inactive**，点击右上角开关激活

4. 检查凭证：
   - 点击任意使用凭证的节点（如"AI图片生成"）
   - 确认 **DeerAPI account** 已选择
   - 如果未选择，重新选择凭证

### 步骤2：获取Webhook URL（1分钟）

1. 在N8N中，点击第一个节点：**Webhook触发器**
2. 查看节点参数
3. 找到 **Production URL** 或 **Test URL**
4. 点击复制按钮
5. 粘贴到记事本备用

**URL格式**：

```
https://your-n8n-domain.com/webhook/ai-clothing-generation
```

### 步骤3：准备测试数据（2分钟）

**创建测试请求数据**：

```json
{
  "taskId": "test-001",
  "userId": "test-user-123",
  "productImageUrl": "https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=800",
  "sceneImageUrl": "https://images.unsplash.com/photo-1496747611176-843222e1e57c?w=800",
  "prompt": "时尚模特在繁华街头",
  "aiModel": "Gemini-3-Pro-Image",
  "aspectRatio": "3:4",
  "imageCount": 4,
  "quality": "high",
  "callbackUrl": "https://your-backend.com/api/webhooks/n8n/callback"
}
```

**参数说明**：

- `taskId`: 任务ID，自定义
- `userId`: 用户ID，自定义
- `productImageUrl`: 商品图片URL（必填）
- `sceneImageUrl`: 场景图片URL（可选）
- `prompt`: 提示词
- `aiModel`: AI模型
- `aspectRatio`: 尺寸比例（1:1, 3:4, 16:9, 9:16）
- `imageCount`: 生成数量（1-8）
- `quality`: 质量
- `callbackUrl`: 回调URL（用于接收结果）

### 步骤4：使用curl测试（2分钟）

**打开终端**，执行：

```bash
curl -X POST https://your-n8n-domain.com/webhook/ai-clothing-generation \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "test-001",
    "userId": "test-user-123",
    "productImageUrl": "https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=800",
    "prompt": "时尚模特在繁华街头",
    "aiModel": "Gemini-3-Pro-Image",
    "aspectRatio": "3:4",
    "imageCount": 4,
    "quality": "high",
    "callbackUrl": "https://httpbin.org/post"
  }'
```

**注意**：

- 替换 `https://your-n8n-domain.com` 为你的实际N8N域名
- 如果使用Test URL，路径会不同

### 步骤5：使用Postman测试（可选，3分钟）

如果不熟悉curl，可以使用Postman：

1. 打开Postman
2. 创建新请求：
   - **Method**: POST
   - **URL**: 你的Webhook URL
3. 配置Headers：
   - `Content-Type`: `application/json`
4. 配置Body：
   - 选择 **raw**
   - 选择 **JSON**
   - 粘贴步骤3的测试数据
5. 点击 **Send**

### 步骤6：查看执行结果（2分钟）

**在N8N中查看**：

1. 点击左侧菜单 **"Executions"**（执行记录）
2. 找到刚才的执行记录（最新的一条）
3. 点击查看详情

**逐个节点检查**：

| 节点名称      | 预期结果 | 如何验证                          |
| ------------- | -------- | --------------------------------- |
| Webhook触发器 | ✅ 成功  | 状态为绿色，显示接收到的参数      |
| 解析请求参数  | ✅ 成功  | 所有字段都正确提取                |
| 判断是否3:4   | ✅ YES   | 走YES分支（因为aspectRatio是3:4） |
| 3:4尺寸       | ✅ 成功  | width=768, height=1024            |
| AI图片生成    | ✅ 成功  | 返回生成的图片URL数组             |
| 格式化结果    | ✅ 成功  | resultImageUrls数组不为空         |
| 回调后端API   | ✅ 成功  | HTTP 200状态码                    |
| 返回成功响应  | ✅ 成功  | 返回success: true                 |

### 步骤7：验证输出（1分钟）

**查看"返回成功响应"节点的输出**：

```json
{
  "success": true,
  "taskId": "test-001",
  "message": "图片生成成功"
}
```

### 步骤8：测试不同参数（可选，5分钟）

**测试1:1比例**：

```bash
curl -X POST https://your-n8n-domain.com/webhook/ai-clothing-generation \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "test-002",
    "userId": "test-user-123",
    "productImageUrl": "https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=800",
    "prompt": "时尚模特在繁华街头",
    "aiModel": "Gemini-3-Pro-Image",
    "aspectRatio": "1:1",
    "imageCount": 2,
    "callbackUrl": "https://httpbin.org/post"
  }'
```

**验证**：

- ✅ 判断是否1:1节点走YES分支
- ✅ 1:1尺寸节点设置width=1024, height=1024

**测试无场景图**：

```bash
curl -X POST https://your-n8n-domain.com/webhook/ai-clothing-generation \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "test-003",
    "userId": "test-user-123",
    "productImageUrl": "https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=800",
    "prompt": "时尚模特在繁华街头",
    "aiModel": "Gemini-3-Pro-Image",
    "aspectRatio": "3:4",
    "imageCount": 1,
    "callbackUrl": "https://httpbin.org/post"
  }'
```

**验证**：

- ✅ 即使没有sceneImageUrl，工作流也正常运行
- ✅ DeerAPI的image2参数为空字符串

---

## 📋 测试2：飞书工作流v3

### 测试目标

验证飞书触发工作流是否正常工作。

### 步骤1：检查N8N工作流状态（1分钟）

1. 打开N8N界面
2. 找到工作流：**AI场景图生成工作流-飞书触发v3**
3. 检查右上角状态：
   - ✅ 显示为 **Active**（已激活）
   - ❌ 如果是 **Inactive**，点击右上角开关激活

4. 检查凭证：
   - 点击 **"飞书鉴权"** 节点
   - 确认 **Feishu Credentials account** 已选择
   - 点击 **"获取数据"** 节点
   - 确认 **Feishu Credentials account** 已选择
   - 点击 **"大模型处理"** 节点
   - 确认 **DeerAPI account** 已选择

### 步骤2：检查飞书自动化配置（1分钟）

1. 打开飞书多维表格
2. 点击右上角 **"自动化"**
3. 找到你创建的自动化
4. 确认状态为 **"已启用"**
5. 检查配置：
   - 触发器：按钮被点击 ✅
   - 操作：发送Webhook请求 ✅
   - URL：已填写 ✅
   - Method：POST ✅
   - Body：已配置app_token, table_id, record_id ✅

### 步骤3：获取Webhook URL（1分钟）

1. 在N8N中，点击 **"Webhook触发器"** 节点
2. 查看 **Production URL**
3. 复制URL
4. 与飞书自动化中的URL对比
5. ✅ 确认一致

**如果不一致**：

- 将N8N的URL复制到飞书自动化
- 保存飞书自动化

### 步骤4：准备测试记录（2分钟）

**打开飞书多维表格**，创建新记录：

**必填字段**：

- **提示词**: `时尚模特在繁华街头`
- **商品图片**: 上传一张图片
- **点击按钮**: （不需要填写，这是触发按钮）

**可选字段**：

- **场景图**: 上传一张图片（先不填，测试无场景图）
- **AI模型**: 选择或留空（默认Gemini-3-Pro-Image）
- **尺寸比例**: 选择或留空（默认3:4）
- **生成数量**: 填写或留空（默认4）
- **状态**: 待处理

### 步骤5：测试无场景图（3分钟）

**操作**：

1. 在飞书表格中，填写第一行测试数据：

   ```
   提示词: 时尚模特在繁华街头
   商品图片: [上传一张图片]
   场景图: [留空] ⬅️ 关键：不填
   ```

2. 点击该行的 **"点击按钮"**

3. 观察表格：
   - 状态字段应该变为 **"处理中"** ✅

4. 打开N8N，查看Executions：
   - 应该看到一条新的执行记录
   - 点击查看详情

**逐个节点验证**：

| 节点名称         | 预期结果 | 验证要点                             |
| ---------------- | -------- | ------------------------------------ |
| Webhook触发器    | ✅ 成功  | 接收到app_token, table_id, record_id |
| 飞书鉴权         | ✅ 成功  | 输出accessToken                      |
| 获取数据         | ✅ 成功  | 读取到完整的记录数据                 |
| 提取参数         | ✅ 成功  | 所有参数正确提取                     |
| 更新状态为处理中 | ✅ 成功  | 飞书表格状态变为"处理中"             |
| 下载商品图       | ✅ 成功  | 返回二进制数据                       |
| 判断是否有场景图 | ✅ NO    | 走NO分支（因为sceneImageUrl为空）    |
| 大模型处理       | ✅ 成功  | 接收二进制，生成二进制               |
| 数据处理         | ✅ 成功  | 计算real_size和file_name             |
| 上传素材         | ✅ 成功  | 返回file_token                       |
| 回传飞书         | ✅ 成功  | 更新"生成结果"字段                   |
| 返回成功响应     | ✅ 成功  | 返回成功消息                         |

5. 观察飞书表格（等待30-60秒）：
   - 状态字段应该变为 **"已完成"** ✅
   - 生成结果字段应该出现一张图片 ✅

**如果失败**：

- 查看N8N执行记录中哪个节点报错
- 检查该节点的输入输出
- 查看错误消息

### 步骤6：测试有场景图（3分钟）

**操作**：

1. 在飞书表格中，填写第二行测试数据：

   ```
   提示词: 时尚模特在繁华街头
   商品图片: [上传一张图片]
   场景图: [上传一张图片] ⬅️ 关键：填写
   ```

2. 点击该行的 **"点击按钮"**

3. 观察表格：
   - 状态字段应该变为 **"处理中"** ✅

4. 打开N8N，查看Executions：
   - 找到新的执行记录
   - 点击查看详情

**关键验证**：

| 节点名称         | 预期结果 | 与无场景图的差异       |
| ---------------- | -------- | ---------------------- |
| 下载商品图       | ✅ 成功  | 相同                   |
| 判断是否有场景图 | ✅ YES   | ⬅️ 差异：走YES分支     |
| 下载场景图       | ✅ 成功  | ⬅️ 差异：执行此节点    |
| 大模型处理       | ✅ 成功  | 接收两张图的二进制数据 |
| 数据处理         | ✅ 成功  | 相同                   |
| 上传素材         | ✅ 成功  | 相同                   |
| 回传飞书         | ✅ 成功  | 相同                   |

5. 观察飞书表格（等待30-60秒）：
   - 状态字段应该变为 **"已完成"** ✅
   - 生成结果字段应该出现一张图片 ✅

### 步骤7：测试不同尺寸比例（可选，5分钟）

**测试1:1比例**：

1. 创建新记录：

   ```
   提示词: 时尚模特在繁华街头
   商品图片: [上传图片]
   尺寸比例: 1:1 ⬅️ 选择1:1
   ```

2. 点击按钮

3. 验证：
   - ✅ 生成的图片是正方形（1:1）
   - ✅ 分辨率是1024x1024

**测试16:9比例**：

1. 创建新记录：

   ```
   提示词: 时尚模特在繁华街头
   商品图片: [上传图片]
   尺寸比例: 16:9 ⬅️ 选择16:9
   ```

2. 点击按钮

3. 验证：
   - ✅ 生成的图片是横向（16:9）
   - ✅ 分辨率是1344x768

### 步骤8：验证结果质量（2分钟）

**检查生成的图片**：

1. 在飞书表格中，点击 **"生成结果"** 字段中的图片
2. 查看图片预览
3. 验证：
   - ✅ 图片清晰
   - ✅ 符合提示词描述
   - ✅ 商品图已融入场景
   - ✅ 如果有场景图，场景已正确应用

---

## 🔍 故障排查

### 问题1：Webhook没有触发

**前端工作流**：

**检查**：

1. N8N工作流是否已激活？
2. Webhook URL是否正确？
3. 网络是否可以访问N8N？

**测试**：

```bash
# 测试Webhook是否可访问
curl -X POST https://your-n8n-domain.com/webhook/ai-clothing-generation \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

**预期结果**：

- ✅ 返回错误（因为缺少参数）但说明Webhook可访问
- ❌ 连接超时说明URL不对或N8N未启动

**飞书工作流**：

**检查**：

1. 飞书自动化是否已启用？
2. Webhook URL是否正确配置？
3. N8N工作流是否已激活？

**测试**：

1. 在飞书表格中点击按钮
2. 立即查看N8N的Executions
3. ✅ 应该看到新的执行记录
4. ❌ 如果没有，说明Webhook没触发

**常见原因**：

- 飞书自动化URL配置错误
- 飞书自动化未启用
- N8N工作流未激活

### 问题2：节点执行失败

**查看错误**：

1. 在N8N的Executions中，点击失败的执行记录
2. 找到显示红色的节点
3. 点击该节点
4. 查看 **Error** 消息

**常见错误类型**：

**错误：Credentials not found**

- 原因：凭证未配置或名称不匹配
- 解决：检查凭证配置，确保名称为：
  - `Feishu Credentials account`
  - `DeerAPI account`

**错误：Field not found**

- 原因：字段名称不匹配
- 检查：飞书表格字段名称是否正确
  - 必须是：`提示词`、`商品图`、`生成结果`
  - 大小写和空格必须完全匹配

**错误：401 Unauthorized**

- 原因：鉴权失败
- 检查：
  - Feishu凭证的App ID和Secret是否正确
  - DeerAPI的API Key是否正确

**错误：Image processing failed**

- 原因：DeerAPI处理失败
- 检查：
  - 图片URL是否有效
  - 图片格式是否支持
  - API配额是否用完

### 问题3：结果没有写回飞书

**检查**：

1. N8N执行记录是否全部成功？
2. **上传素材**节点是否成功？
3. **回传飞书**节点是否成功？

**常见原因**：

**原因1：file_token未获取**

- 检查：上传素材节点的响应
- 应该包含：`{ "data": { "file_token": "xxx" } }`

**原因2：字段名称不匹配**

- 检查：飞书表格字段名称
- 必须是：`生成结果`（不是`AI生成场景图`）

**原因3：数据处理节点失败**

- 检查：数据处理节点的输出
- 必须包含：`real_size` 和 `file_name`

### 问题4：场景图没有生效

**检查**：

1. 飞书表格中，场景图字段是否有值？
2. **判断是否有场景图**节点走哪个分支？
3. **下载场景图**节点是否执行？

**测试**：

创建一个有场景图的记录：

```
场景图: [必须上传图片] ⬅️ 不能留空
```

点击按钮后，查看N8N：

- ✅ 应该走YES分支
- ✅ 应该执行"下载场景图"节点
- ✅ "大模型处理"节点接收两张图的二进制数据

---

## ✅ 测试成功标志

### 前端工作流

- ✅ curl命令返回success: true
- ✅ N8N所有节点显示绿色
- ✅ 生成了指定数量的图片
- ✅ 回调URL收到了回调（如果配置了）

### 飞书工作流

- ✅ 点击按钮后，状态变为"处理中"
- ✅ 30-60秒后，状态变为"已完成"
- ✅ "生成结果"字段包含生成的图片
- ✅ N8N所有节点显示绿色
- ✅ 无场景图和有场景图都能正常工作

---

## 📊 测试记录表

### 前端工作流测试记录

| 测试项       | 测试时间 | 结果     | 备注              |
| ------------ | -------- | -------- | ----------------- |
| 基本功能测试 | \_\_\_\_ | \_\_\_\_ | aspectRatio=3:4   |
| 1:1比例测试  | \_\_\_\_ | \_\_\_\_ |                   |
| 16:9比例测试 | \_\_\_\_ | \_\_\_\_ |                   |
| 无场景图测试 | \_\_\_\_ | \_\_\_\_ | sceneImageUrl为空 |
| 有场景图测试 | \_\_\_\_ | \_\_\_\_ | 包含sceneImageUrl |

### 飞书工作流测试记录

| 测试项       | 测试时间 | 结果     | 备注                 |
| ------------ | -------- | -------- | -------------------- |
| 无场景图测试 | \_\_\_\_ | \_\_\_\_ | 场景图字段留空       |
| 有场景图测试 | \_\_\_\_ | \_\_\_\_ | 上传场景图           |
| 1:1比例测试  | \_\_\_\_ | \_\_\_\_ |                      |
| 3:4比例测试  | \_\_\_\_ | \_\_\_\_ | 默认值               |
| 状态更新测试 | \_\_\_\_ | \_\_\_\_ | 待处理→处理中→已完成 |
| 结果上传测试 | \_\_\_\_ | \_\_\_\_ | file_token正确       |

---

## 🎯 完整测试流程总结

### 前端工作流（约10分钟）

1. 检查工作流状态（1分钟）
2. 获取Webhook URL（1分钟）
3. 准备测试数据（2分钟）
4. 执行curl测试（2分钟）
5. 查看N8N执行记录（2分钟）
6. 验证输出（1分钟）
7. 测试不同参数（可选，5分钟）

### 飞书工作流（约15分钟）

1. 检查工作流状态（1分钟）
2. 检查飞书自动化（1分钟）
3. 验证Webhook URL（1分钟）
4. 测试无场景图（3分钟）
5. 测试有场景图（3分钟）
6. 测试不同比例（可选，5分钟）
7. 验证结果质量（2分钟）

---

## 📞 遇到问题？

### 查看日志

1. N8N执行记录（左侧菜单 → Executions）
2. 浏览器控制台（F12）
3. 飞书自动化日志

### 检查文档

- [N8N工作流v3验证报告.md](./N8N工作流v3验证报告.md)
- [最终使用指南.md](./最终使用指南.md)
- [v2-vs-v3对比说明.md](./v2-vs-v3对比说明.md)

---

**测试时间建议**：30-45分钟
**难度**：⭐⭐⭐（中等）

祝测试顺利！🎊
