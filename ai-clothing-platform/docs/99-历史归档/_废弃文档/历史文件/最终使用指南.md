# 🚀 N8N工作流最终使用指南

## 📅 更新时间

2025-01-27

---

## ✅ 最终推荐

根据你提供的实际配置（广州场 copy.json），我已经重新优化了工作流。

### 📦 使用这些文件

| 文件名                        | 用途     | 状态    | 说明                         |
| ----------------------------- | -------- | ------- | ---------------------------- |
| `n8n-workflow-frontend.json`  | 前端触发 | ✅ 使用 | 无需修改                     |
| `n8n-workflow-feishu-v3.json` | 飞书触发 | ✅ 使用 | **新版本**，符合你的实际配置 |
| `n8n-workflow-feishu-v2.json` | 飞书触发 | ❌ 弃用 | 节点类型不匹配               |
| `n8n-workflow-feishu.json`    | 飞书触发 | ❌ 弃用 | v1版本，有问题               |

---

## 🔑 核心差异

### v3版本的改进

**你的实际配置**（广州场 copy.json）:

- ✅ 使用 `n8n-nodes-feishu-lite.feishuNode` 插件
- ✅ 使用 `n8n-nodes-deerapi.deerApi` 插件
- ✅ 处理二进制数据流
- ✅ 上传到飞书API

**v3版本已匹配**:

- ✅ 使用feishu-lite插件
- ✅ 使用DeerAPI专用插件
- ✅ 完整的二进制数据处理
- ✅ 完整的飞书上传流程

---

## 📋 快速开始

### 步骤1：导入工作流（2分钟）

1. 打开N8N界面
2. 导入 `n8n-workflow-frontend.json`
3. 导入 `n8n-workflow-feishu-v3.json` ⚠️ 注意v3

### 步骤2：配置凭证（2分钟）

**Feishu Credentials**:

```
Name: Feishu Credentials account
App ID: 你的飞书App ID
App Secret: 你的飞书App Secret
```

**DeerAPI**:

```
Name: DeerAPI account
API Key: 你的DeerAPI Key
```

### 步骤3：配置飞书自动化（3分钟）

**触发器**:

```
条件：按钮被点击
字段：点击按钮
```

**操作**:

```
类型：发送Webhook请求
URL：从N8N的Webhook触发器节点复制
方法：POST
Body：
{
  "app_token": 触发记录.app_token,
  "table_id": 触发记录.table_id,
  "record_id": 触发记录.record_id
}
```

### 步骤4：测试验证（3分钟）

**测试1：前端路径**

```bash
curl -X POST https://your-n8n.com/webhook/ai-clothing-generation \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "test-001",
    "userId": "test-user",
    "productImageUrl": "https://example.com/product.jpg",
    "prompt": "时尚模特在繁华街头",
    "aiModel": "Gemini-3-Pro-Image",
    "aspectRatio": "3:4",
    "imageCount": 4,
    "callbackUrl": "https://your-backend.com/callback"
  }'
```

**测试2：飞书路径（有场景图）**

1. 在飞书表格中新建记录
2. 填写：提示词、商品图、场景图
3. 点击"点击按钮"
4. 观察结果 ✅

**测试3：飞书路径（无场景图）** ⚠️ 重要

1. 在飞书表格中新建记录
2. 填写：提示词、商品图（场景图留空）
3. 点击"点击按钮"
4. 观察结果 ✅

---

## 📊 v3工作流结构

### 节点列表（14个）

```
1. Webhook触发器 (n8n-nodes-base.webhook)
2. 飞书鉴权 (n8n-nodes-feishu-lite.feishuNode) ✅
3. 获取数据 (n8n-nodes-feishu-lite.feishuNode) ✅
4. 提取参数 (n8n-nodes-base.set)
5. 更新状态为处理中 (n8n-nodes-feishu-lite.feishuNode) ✅
6. 下载商品图 (n8n-nodes-base.httpRequest)
7. 判断是否有场景图 (n8n-nodes-base.if)
8. 下载场景图 (n8n-nodes-base.httpRequest)
9. 大模型处理 (n8n-nodes-deerapi.deerApi) ✅
10. 数据处理 (n8n-nodes-base.code)
11. 上传素材 (n8n-nodes-base.httpRequest)
12. 回传飞书 (n8n-nodes-feishu-lite.feishuNode) ✅
13. 返回成功响应 (n8n-nodes-base.respondToWebhook)
```

✅ = 符合你的实际配置

### 数据流

```
Webhook接收
  ↓
飞书鉴权（获取accessToken）
  ↓
获取数据（读取记录）
  ↓
提取参数（app_token, table_id, record_id, 提示词, URLs）
  ↓
更新状态为处理中
  ↓
下载商品图（二进制）
  ↓
判断场景图
  ├─ 有 → 下载场景图（二进制） ┐
  └─ 无 →──────────────────────┤
                                ↓
                        大模型处理（DeerAPI插件）
                          接收二进制 → 返回二进制
                                ↓
                          数据处理（计算大小）
                                ↓
                          上传素材（到飞书API）
                                ↓
                          回传飞书（更新记录）
                                ↓
                          返回成功响应
```

---

## ⚠️ 重要注意事项

### 1. app_toke拼写

feishu-lite插件的参数是 `app_toke`（不是appToken）:

```javascript
{
  "app_toke": "app_xxx"  // ✅ 正确
}
```

### 2. 二进制数据处理

**数据处理节点必须保留**:

```javascript
const buffer = await this.helpers.getBinaryDataBuffer(i, 'data');
item.json.real_size = buffer.length;
item.json.file_name = 'final_product.png';
```

飞书上传需要真实的文件大小！

### 3. 飞书鉴权token

所有访问飞书API的请求都需要：

```javascript
{
  "Authorization": "Bearer {{ $('飞书鉴权').item.json.accessToken }}"
}
```

### 4. DeerAPI插件参数

```javascript
{
  "mode": "image",
  "userPrompt": "提示词 注意：...",
  "aspectRatio": "3:4"
}
```

**输入**: 二进制数据（自动从下载节点传递）
**输出**: 二进制数据（生成的图片）

---

## 🔧 配置检查清单

### 凭证

- [ ] Feishu Credentials account已创建
- [ ] DeerAPI account已创建
- [ ] 所有节点已选择正确的凭证

### 节点

- [ ] 飞书鉴权节点已激活
- [ ] 获取数据节点已激活
- [ ] 大模型处理节点已激活
- [ ] Webhook触发器已激活

### 飞书

- [ ] 飞书自动化已创建
- [ ] Webhook URL已配置
- [ ] app_token, table_id, record_id已正确传递
- [ ] 自动化已启用

### 测试

- [ ] 前端路径测试成功
- [ ] 飞书路径测试成功（有场景图）
- [ ] 飞书路径测试成功（无场景图）
- [ ] 状态更新正常
- [ ] 结果上传正常

---

## 📚 参考文档

| 文档                                                   | 说明         |
| ------------------------------------------------------ | ------------ |
| [N8N工作流v3验证报告.md](./N8N工作流v3验证报告.md)     | 详细验证报告 |
| [v2-vs-v3对比说明.md](./v2-vs-v3对比说明.md)           | v2 vs v3对比 |
| [N8N工作流手动连线指南.md](./N8N工作流手动连线指南.md) | 连线指南     |
| [N8N快速导入指南.md](./N8N快速导入指南.md)             | 快速导入     |

---

## ❓ 常见问题

### Q1: v3版本为什么比v2少节点？

**A**:

- v3使用专用插件，简化了操作
- v3移除了4个并行分支（多尺寸比例）
- v3更符合你的实际使用场景

### Q2: 我需要多尺寸功能怎么办？

**A**:

- 方案1：在飞书中为每种尺寸创建记录，逐个生成
- 方案2：告诉我，我可以扩展v3版本支持循环

### Q3: 前端工作流需要更新吗？

**A**:

- ✅ 不需要，前端工作流保持不变
- ✅ 继续使用 `n8n-workflow-frontend.json`

### Q4: 如何确认我使用的是v3版本？

**A**:

- 文件名：`n8n-workflow-feishu-v3.json`
- 节点数：14个
- 使用feishu-lite插件

### Q5: 导入后节点散落怎么办？

**A**:

- 如果有连线：只是位置问题，拖拽调整即可
- 如果没有连线：参考 [N8N工作流手动连线指南.md](./N8N工作流手动连线指南.md)

---

## 🎯 完成标志

### 前端工作流

- ✅ 14个节点
- ✅ 所有节点已连接
- ✅ DeerAPI凭证已配置
- ✅ Webhook已激活
- ✅ 测试成功

### 飞书工作流v3

- ✅ 14个节点
- ✅ 所有节点已连接
- ✅ Feishu凭证已配置
- ✅ DeerAPI凭证已配置
- ✅ Webhook已激活
- ✅ 飞书自动化已配置
- ✅ 测试成功（有场景图）
- ✅ 测试成功（无场景图）

---

## 📞 需要帮助？

### 检查文档

1. [N8N工作流v3验证报告.md](./N8N工作流v3验证报告.md) - 详细验证说明
2. [v2-vs-v3对比说明.md](./v2-vs-v3对比说明.md) - 版本对比
3. [N8N工作流手动连线指南.md](./N8N工作流手动连线指南.md) - 连线说明

### 检查日志

1. N8N执行日志（Executions）
2. 飞书自动化日志
3. 浏览器控制台

---

**最终版本**: v3
**验证状态**: ✅ 全部通过
**推荐使用**: ✅ v3版本

祝使用顺利！🎊
