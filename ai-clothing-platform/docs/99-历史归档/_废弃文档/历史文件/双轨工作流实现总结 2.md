# AI服装平台 - 双轨工作流实现总结

## 实现日期

2026-01-29

## 概述

本次实现完成了AI服装平台的双轨工作流架构，实现了前端系统和飞书多维表格之间的数据互通。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         双轨工作流架构                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        轨道A (前端 → 飞书)                         │  │
│  │  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐       │  │
│  │  │ Web页面 │ → │ API接口 │ → │ N8N工作流│ → │ 飞书记录 │       │  │
│  │  └─────────┘    └─────────┘    └─────────┘    └─────────┘       │  │
│  │       │              │              │              │              │  │
│  │       │              ▼              ▼              ▼              │  │
│  │       │         ┌─────────┐    ┌─────────┐    ┌─────────┐       │  │
│  │       └─────────│事件系统 │←──│N8N回调  │←──│状态更新  │       │  │
│  │                 └─────────┘    └─────────┘    └─────────┘       │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        轨道B (飞书 → 飞书)                         │  │
│  │  ┌─────────┐    ┌─────────┐    ┌─────────┐                       │  │
│  │  │飞书表格 │ → │ N8N工作流│ → │飞书更新  │                       │  │
│  │  └─────────┘    └─────────┘    └─────────┘                       │  │
│  │                                                                  │  │
│  │  通过 feishuRecordId 实现与轨道A的关联                            │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 实现的功能模块

### 1. 事件系统恢复 ([src/lib/events/](src/lib/events/))

#### [handlers.ts](src/lib/events/handlers.ts)

- 恢复了完整的事件发布器
- 支持异步事件发布（`emitAsync`）
- 定义了4种任务事件：
  - `task.created` - 任务创建时触发
  - `task.completed` - 任务完成时触发
  - `task.failed` - 任务失败时触发
  - `task.progress` - 进度更新时触发

#### [event-bus.ts](src/lib/events/event-bus.ts)

- 完整的EventBus实现
- 支持事件订阅/取消订阅
- 支持同步/异步事件发布
- 内置错误处理机制

### 2. 飞书事件监听器 ([src/lib/events/feishu-listeners.ts](src/lib/events/feishu-listeners.ts))

- **任务创建监听器**：自动在飞书创建记录并关联 `feishuRecordId`
- **任务完成监听器**：同步结果到飞书
- **任务失败监听器**：同步错误信息到飞书
- **进度更新监听器**：实时同步进度到飞书
- **断路器保护**：防止飞书服务故障影响主流程

### 3. 应用初始化模块 ([src/lib/app-initialization.ts](src/lib/app-initialization.ts))

- 统一的应用初始化入口
- 自动注册飞书事件监听器
- 确保监听器只初始化一次

### 4. 双向数据关联查询API ([src/app/api/tasks/link/route.ts](src/app/api/tasks/link/route.ts))

#### GET /api/tasks/link

通过 `taskId` 或 `feishuRecordId` 查询关联关系

```bash
# 通过 taskId 查询飞书记录
GET /api/tasks/link?taskId=xxx

# 通过 feishuRecordId 查询本地任务
GET /api/tasks/link?feishuRecordId=xxx
```

#### POST /api/tasks/link

手动关联本地任务与飞书记录

```bash
POST /api/tasks/link
{
  "taskId": "xxx",
  "feishuRecordId": "xxx"
}
```

### 5. 弹性和容错机制 ([src/lib/utils/resilience.ts](src/lib/utils/resilience.ts))

#### 重试机制

```typescript
withRetry(() => feishuService.createTaskRecord(...), {
  maxAttempts: 3,
  initialDelayMs: 1000,
  backoffMultiplier: 2
})
```

#### 断路器模式

- 5次失败后打开断路器
- 60秒后尝试恢复
- 防止雪崩效应

#### 降级策略

- 飞书服务不可用时自动降级
- 不阻塞主业务流程
- 记录失败日志用于监控

### 6. 监控API ([src/app/api/monitoring/circuit-breaker/route.ts](src/app/api/monitoring/circuit-breaker/route.ts))

#### GET /api/monitoring/circuit-breaker

获取断路器当前状态

```json
{
  "service": "feishu-sync",
  "state": "closed",
  "failureCount": 0,
  "timestamp": "2026-01-29T..."
}
```

## 数据流说明

### 轨道A完整流程

```
1. 用户在Web页面提交任务
   ↓
2. POST /api/tasks
   ↓
3. createTask() - 创建数据库记录
   ↓
4. eventPublisher.taskCreated()
   ↓
5. EventBus 触发 'task.created' 事件
   ↓
6. FeishuListener 监听事件
   ↓
7. feishuService.createTaskRecord() - 创建飞书记录
   ↓
8. taskRepo.update() - 保存 feishuRecordId
   ↓
9. n8nService.triggerGeneration() - 触发N8N工作流
   ↓
10. N8N处理完成后回调
    ↓
11. POST /api/webhooks/n8n/callback
    ↓
12. eventPublisher.taskCompleted/Failed()
    ↓
13. FeishuListener 同步结果到飞书
```

### 轨道B流程

```
1. 用户在飞书表格填写
   ↓
2. 飞书Webhook触发N8N
   ↓
3. N8N工作流处理
   ↓
4. 结果写回飞书记录
   ↓
5. (可选) 通过 feishuRecordId 查询本地任务
```

## 关键文件清单

| 文件                                                                                               | 说明                 |
| -------------------------------------------------------------------------------------------------- | -------------------- |
| [src/lib/events/handlers.ts](src/lib/events/handlers.ts)                                           | 事件发布器           |
| [src/lib/events/event-bus.ts](src/lib/events/event-bus.ts)                                         | 事件总线实现         |
| [src/lib/events/feishu-listeners.ts](src/lib/events/feishu-listeners.ts)                           | 飞书事件监听器       |
| [src/lib/app-initialization.ts](src/lib/app-initialization.ts)                                     | 应用初始化           |
| [src/lib/utils/resilience.ts](src/lib/utils/resilience.ts)                                         | 弹性和容错工具       |
| [src/app/api/tasks/link/route.ts](src/app/api/tasks/link/route.ts)                                 | 双向关联查询API      |
| [src/app/api/monitoring/circuit-breaker/route.ts](src/app/api/monitoring/circuit-breaker/route.ts) | 监控API              |
| [src/lib/repositories/task.repository.types.ts](src/lib/repositories/task.repository.types.ts)     | 类型定义（新增字段） |

## 测试建议

### 1. 单元测试

```bash
# 测试事件发布
npm run test events

# 测试飞书服务
npm run test feishu

# 测试断路器
npm run test resilience
```

### 2. 集成测试

#### 测试轨道A完整流程

```bash
# 1. 创建任务
curl -X POST http://localhost:3000/api/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "productImageUrl": "...",
    "prompt": "test",
    "aiModel": "FLUX.1"
  }'

# 2. 查询关联关系
curl http://localhost:3000/api/tasks/link?taskId=<返回的taskId>

# 3. 检查断路器状态
curl http://localhost:3000/api/monitoring/circuit-breaker
```

#### 测试降级策略

```bash
# 停止飞书服务后创建任务
# 验证任务仍然创建成功，但 feishuRecordId 为空

# 恢复飞书服务后手动关联
curl -X POST http://localhost:3000/api/tasks/link \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "xxx",
    "feishuRecordId": "xxx"
  }'
```

### 3. 端到端测试

1. 在Web页面创建任务
2. 观察飞书表格是否同步创建记录
3. 等待N8N处理完成
4. 验证结果是否同步到飞书

## 环境变量配置

确保以下环境变量已正确配置：

```bash
# 飞书配置
FEISHU_APP_ID=xxx
FEISHU_APP_SECRET=xxx
FEISHU_BITABLE_APP_TOKEN=xxx
FEISHU_BITABLE_TABLE_ID=xxx

# N8N配置
N8N_WEBHOOK_URL=https://n8n.denggui.top/webhook/ai-clothing-generation
N8N_API_KEY=n8n-callback-secret-key-2024

# 应用配置
NEXT_PUBLIC_APP_URL=https://your-app.vercel.app
```

## 注意事项

1. **图片Token提取**：当前假设图片URL包含飞书file_token格式，如果使用其他存储，需要修改 [feishu-listeners.ts:47-50](src/lib/events/feishu-listeners.ts#L47-L50)

2. **断路器配置**：可根据实际情况调整 [resilience.ts:255-260](src/lib/utils/resilience.ts#L255-L260) 的配置

3. **错误监控**：可集成 Sentry 或 DataDog 到 [feishu-listeners.ts:204-211](src/lib/events/feishu-listeners.ts#L204-L211) 的 `recordSyncFailure` 函数

## 后续优化建议

1. **添加图片Token提取逻辑**：支持从飞书URL或其他云存储URL提取token
2. **实现补偿机制**：对于失败的任务，提供手动重试功能
3. **添加更多监控指标**：如同步延迟、成功率等
4. **实现批量同步**：支持将历史数据批量同步到飞书
