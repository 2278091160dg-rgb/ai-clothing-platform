# 🚀 结构化提示词模板方案 - 完整实施指南

## 📅 文档版本：v1.0

## 📅 更新日期：2026-01-29

---

## 🎯 方案概述

基于实际业务场景的优秀提示词设计，提出**"后端组装提示词，前端只收核心信息"**的方案：

```
用户简单输入 → 后端模板组装 → 生成高质量提示词 → N8N生成图片
```

### 核心优势：

| 优势            | 说明                                             |
| --------------- | ------------------------------------------------ |
| ✅ **改动最小** | 只改动前端表单 + 后端模板，N8N和飞书表格基本不变 |
| ✅ **效果提升** | 使用结构化专业提示词，大幅提升生成质量           |
| ✅ **交互友好** | 用户只需输入产品描述，其他都是可选               |
| ✅ **页面整洁** | 只增加3个简洁的表单项                            |
| ✅ **易于维护** | 提示词模板集中管理，便于优化和更新               |

---

## 📊 方案对比

| 方案                  | 改动量      | 效果提升   | 交互友好度 | 页面整洁度 | 推荐度     |
| --------------------- | ----------- | ---------- | ---------- | ---------- | ---------- |
| **方案一**（模板）    | ⭐ 最小     | ⭐⭐⭐⭐   | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **方案二**（模板+AI） | ⭐⭐ 中等   | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐   | ⭐⭐⭐⭐   | ⭐⭐⭐⭐   |
| **方案三**（完整）    | ⭐⭐⭐ 较大 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐     | ⭐⭐⭐     | ⭐⭐⭐     |

---

## 🎯 方案一：最简化模板方案（推荐）

### 改动概览

```
前端：新增3个表单项
后端：新增1个模板文件 + 修改API
N8N：无需改动
飞书表格：可选新增3个字段
```

### 1. 前端改动（新增3个表单项）

**文件**：`src/components/workspace/ParamsPanel.tsx`

**新增代码**：

```tsx
import { useState } from 'react';
import { MODEL_TYPES, SCENE_STYLES } from '@/lib/prompts/image-generation.template';

export function ParamsPanel() {
  // 新增状态
  const [productDescription, setProductDescription] = useState('');
  const [modelType, setModelType] = useState<string>('');
  const [sceneStyle, setSceneStyle] = useState<string>('');

  return (
    <div className="space-y-4">
      {/* ========== 新增：产品描述（必填）========== */}
      <div className="space-y-2">
        <label className="text-sm font-medium">
          产品描述 <span className="text-red-500">*</span>
        </label>
        <Input
          placeholder="例如：红色连衣裙、蓝色西装、白色衬衫..."
          value={productDescription}
          onChange={e => setProductDescription(e.target.value)}
          className="w-full"
        />
        <p className="text-xs text-muted-foreground">
          简单描述你的产品，系统会自动生成专业的商业摄影提示词
        </p>
      </div>

      {/* ========== 新增：模特类型（可选）========== */}
      <div className="space-y-2">
        <label className="text-sm font-medium">
          模特类型 <span className="text-muted-foreground">(可选)</span>
        </label>
        <Select value={modelType} onValueChange={setModelType}>
          <SelectTrigger>
            <SelectValue placeholder="默认（亚洲模特）" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">默认（亚洲模特）</SelectItem>
            <SelectItem value="young_asian_female">年轻亚洲女性</SelectItem>
            <SelectItem value="young_asian_male">年轻亚洲男性</SelectItem>
            <SelectItem value="western_female">欧美女性</SelectItem>
            <SelectItem value="western_male">欧美男性</SelectItem>
            <SelectItem value="diverse">多元化模特</SelectItem>
            <SelectItem value="professional_female">职业女性</SelectItem>
            <SelectItem value="professional_male">职业男性</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* ========== 新增：场景风格（可选）========== */}
      <div className="space-y-2">
        <label className="text-sm font-medium">
          场景风格 <span className="text-muted-foreground">(可选)</span>
        </label>
        <Select value={sceneStyle} onValueChange={setSceneStyle}>
          <SelectTrigger>
            <SelectValue placeholder="默认（极简高级环境）" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">默认（极简高级环境）</SelectItem>
            <SelectItem value="cozy_bedroom">温馨卧室</SelectItem>
            <SelectItem value="modern_living">现代客厅</SelectItem>
            <SelectItem value="urban_street">城市街头</SelectItem>
            <SelectItem value="minimal_studio">极简摄影棚</SelectItem>
            <SelectItem value="nature_outdoor">自然户外</SelectItem>
            <SelectItem value="luxury_interior">奢华室内</SelectItem>
            <SelectItem value="cafe_restaurant">咖啡馆</SelectItem>
            <SelectItem value="office_workspace">办公空间</SelectItem>
            <SelectItem value="beach_resort">海滩度假</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* 原有的图片上传、AI模型、尺寸等保持不变 */}
      {/* ... */}
    </div>
  );
}
```

### 2. 后端改动（新增模板文件）

**文件**：`src/lib/prompts/image-generation.template.ts`（已创建）

**包含内容**：

- ✅ 结构化提示词模板（基于实际业务场景）
- ✅ 模特类型选项
- ✅ 场景风格选项
- ✅ `buildImageGenerationPrompt()` 函数
- ✅ `buildSimplePrompt()` 函数（简化版）
- ✅ `buildPromptFromTemplate()` 函数（预设模板）

### 3. 后端API改动（使用模板）

**文件**：`src/app/api/tasks/route.ts`

**修改代码**：

```typescript
import { buildImageGenerationPrompt } from '@/lib/prompts/image-generation.template';

interface CreateTaskRequest {
  // ========== 新增字段 ==========
  productDescription: string; // 必填：产品描述
  modelType?: string; // 可选：模特类型
  sceneStyle?: string; // 可选：场景风格
  // ===========================

  productImageUrl: string;
  sceneImageUrl?: string;
  aiModel?: string;
  aspectRatio?: string;
  imageCount?: number;
  quality?: string;
}

export async function POST(request: Request) {
  try {
    const body: CreateTaskRequest = await request.json();

    // ========== 验证必填字段 ==========
    if (!body.productDescription) {
      return NextResponse.json({ error: '产品描述不能为空' }, { status: 400 });
    }
    // ===================================

    // 🔥 关键改动：使用模板生成最终提示词
    const finalPrompt = buildImageGenerationPrompt({
      productDescription: body.productDescription,
      modelType: body.modelType,
      sceneStyle: body.sceneStyle,
    });

    console.log('[API] 使用结构化提示词模板生成最终提示词');
    console.log('[API] 产品描述:', body.productDescription);
    console.log('[API] 模特类型:', body.modelType || '默认');
    console.log('[API] 场景风格:', body.sceneStyle || '默认');
    console.log('[API] 最终提示词长度:', finalPrompt.length);

    // 提交到N8N（保持原有逻辑）
    const n8nResponse = await fetch(process.env.N8N_WEBHOOK_URL!, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        taskId: task.id,
        userId: body.userId || 'anonymous',
        prompt: finalPrompt, // 🔥 使用组装后的完整提示词
        originalPrompt: body.productDescription, // 🔥 保存原始输入（可选）
        promptSource: 'TEMPLATE', // 🔥 标识来源
        productImageUrl: body.productImageUrl,
        sceneImageUrl: body.sceneImageUrl,
        aiModel: body.aiModel || 'Gemini-3-Pro-Image',
        aspectRatio: body.aspectRatio || '3:4',
        imageCount: body.imageCount || 4,
        quality: body.quality || 'high',
        callbackUrl: `${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/n8n/callback`,
      }),
    });

    // ... 其他逻辑保持不变
  } catch (error) {
    console.error('[API] 任务创建失败:', error);
    return NextResponse.json({ error: '任务创建失败' }, { status: 500 });
  }
}
```

### 4. N8N工作流（无需改动）

**说明**：

- ✅ N8N继续接收 `prompt` 字段（现在是完整的结构化提示词）
- ✅ N8N继续使用 `prompt` 调用AI生成
- ✅ 无需修改任何节点

**验证点**：

```
前端输入："红色连衣裙"
    ↓
后端组装：完整的结构化提示词（1000+字符）
    ↓
N8N接收：prompt = 完整的结构化提示词
    ↓
AI生成：使用高质量提示词生成图片
```

### 5. 飞书表格改动（可选，最小化）

**如果需要查看用户原始输入**，新增3个字段：

| 字段名称 | 字段类型 | 说明               | 是否必需 |
| -------- | -------- | ------------------ | -------- |
| 产品描述 | 文本     | 用户输入的产品描述 | 可选     |
| 模特类型 | 单选     | 用户选择的模特类型 | 可选     |
| 场景风格 | 单选     | 用户选择的场景风格 | 可选     |

**注意**：

- 飞书表格的"提示词"字段保存的是**后端组装后的完整提示词**
- 新增的3个字段用于**追溯用户原始输入**

**如果不需要追溯用户输入**，飞书表格可以**完全不改**。

---

## 🚀 方案二：模板 + AI优化（中等改动）

在方案一的基础上，增加AI对话优化功能。

### 1. 前端改动（新增AI对话按钮）

```tsx
// 新增：AI对话优化按钮
<Button
  variant="outline"
  onClick={() => openAIChatDialog(productDescription)}
  className="w-full"
>
  💬 AI对话优化
</Button>

// AI对话侧边栏
<AIConversationSidebar
  initialPrompt={productDescription}
  onConfirm={(optimizedPrompt) => {
    setProductDescription(optimizedPrompt);
  }}
/>
```

### 2. 后端改动（增加AI优化逻辑）

```typescript
// 1. 先用模板生成基础提示词
const templatePrompt = buildImageGenerationPrompt({
  productDescription: body.productDescription,
  modelType: body.modelType,
  sceneStyle: body.sceneStyle,
});

// 2. 如果用户选择AI优化
let finalPrompt: string;

if (body.enableAIOptimization) {
  // 使用AI优化模板提示词
  const optimizedPrompt = await aiConversationService.quickOptimize(templatePrompt);
  finalPrompt = optimizedPrompt;

  console.log('[API] 使用AI优化后的提示词');
} else {
  // 直接使用模板提示词
  finalPrompt = templatePrompt;

  console.log('[API] 使用模板提示词');
}
```

---

## 📊 数据流对比

### 之前的流程：

```
用户输入复杂提示词 → N8N生成 → 结果（质量不稳定）
```

### 现在的流程（方案一）：

```
用户输入："红色连衣裙"
    ↓
后端组装：结构化专业提示词（1000+字符）
    ↓
N8N生成 → 结果（质量稳定且专业）
```

### 现在的流程（方案二）：

```
用户输入："红色连衣裙"
    ↓
后端组装：结构化专业提示词（1000+字符）
    ↓
[可选] AI优化 → 进一步优化
    ↓
N8N生成 → 结果（质量最优）
```

---

## ✅ 验证测试

### 测试用例1：基础使用

**输入**：

```
产品描述：红色连衣裙
模特类型：（不选择，使用默认）
场景风格：（不选择，使用默认）
```

**验证点**：

- ✅ 后端生成完整的结构化提示词
- ✅ 提示词包含用户输入的"红色连衣裙"
- ✅ 提示词使用默认的"亚洲模特"
- ✅ 提示词使用默认的"极简高级环境"
- ✅ N8N接收完整的提示词
- ✅ 生成的图片质量专业

### 测试用例2：自定义选择

**输入**：

```
产品描述：蓝色西装
模特类型：职业男性
场景风格：办公空间
```

**验证点**：

- ✅ 提示词包含"职业男性"
- ✅ 提示词包含"办公空间"
- ✅ 生成的图片符合商业场景

### 测试用例3：AI优化（方案二）

**输入**：

```
产品描述：白色衬衫
点击："💬 AI对话优化"
AI优化：添加更多细节描述
选择：使用AI优化版
```

**验证点**：

- ✅ 后端先生成模板提示词
- ✅ AI进一步优化提示词
- ✅ 使用优化后的提示词生成

---

## 📝 实施清单

### 第一步：创建提示词模板（30分钟）

- [ ] 创建 `src/lib/prompts/image-generation.template.ts`
- [ ] 复制模板代码
- [ ] 测试模板生成函数

### 第二步：修改前端表单（1小时）

- [ ] 打开 `src/components/workspace/ParamsPanel.tsx`
- [ ] 新增"产品描述"输入框
- [ ] 新增"模特类型"选择器
- [ ] 新增"场景风格"选择器
- [ ] 测试前端表单

### 第三步：修改后端API（30分钟）

- [ ] 打开 `src/app/api/tasks/route.ts`
- [ ] 导入模板函数
- [ ] 使用模板生成最终提示词
- [ ] 添加日志输出
- [ ] 测试API接口

### 第四步：测试验证（1小时）

- [ ] 前端输入测试数据
- [ ] 检查后端日志
- [ ] 验证N8N接收的提示词
- [ ] 验证生成的图片质量

### 第五步（可选）：飞书表格（30分钟）

- [ ] 新增"产品描述"字段
- [ ] 新增"模特类型"字段
- [ ] 新增"场景风格"字段
- [ ] 测试飞书记录同步

---

## 🎯 总结

### 方案一（推荐）：

| 项目         | 说明                                            |
| ------------ | ----------------------------------------------- |
| **工作量**   | 约3小时                                         |
| **改动文件** | 2个（前端组件 + 后端API） + 1个新增（模板文件） |
| **效果提升** | ⭐⭐⭐⭐（大幅提升）                            |
| **用户友好** | ⭐⭐⭐⭐⭐（只需输入产品描述）                  |
| **页面整洁** | ⭐⭐⭐⭐⭐（只增加3个表单项）                   |
| **维护成本** | ⭐（模板集中管理）                              |

### 核心优势：

1. ✅ **用户友好**：只需输入产品描述，其他都是可选
2. ✅ **效果专业**：使用结构化商业摄影提示词
3. ✅ **页面整洁**：只增加3个简洁的表单项
4. ✅ **改动最小**：N8N和飞书表格基本不用改
5. ✅ **易于维护**：提示词模板集中管理

### 下一步：

如果您同意这个方案，我可以：

1. 创建完整的前端组件代码
2. 创建完整的后端API代码
3. 创建N8N工作流验证文档
4. 创建用户使用指南

请告诉我是否需要继续实施，或者您有任何调整建议？
