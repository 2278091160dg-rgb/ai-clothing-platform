# N8N 工作流结构说明

## 📊 完整工作流图

```
┌─────────────────────────────────────────────────────────────────┐
│                     前端用户界面                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 上传商品图   │  │ 输入提示词   │  │ 选择参数     │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                │                │                  │
│         └────────────────┴────────────────┴────────┐         │
│                                                     │         │
│                                               点击"生成"按钮  │
└─────────────────────────────────────────────────────┼─────────┘
                                                      │
                                                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      后端 API (Next.js)                           │
│                                                                 │
│  POST /api/tasks                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. 接收请求参数                                          │   │
│  │ 2. 上传图片到本地 /api/upload                            │   │
│  │ 3. 创建任务记录 (SQLite)                                 │   │
│  │ 4. 发布事件 → 触发飞书同步                              │   │
│  │ 5. 调用 N8N Webhook                                     │   │
│  │ 6. 返回任务ID给前端                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                          │                                     │
│                          │ POST                               │
└──────────────────────────┼─────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      N8N 工作流                                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 节点1: Webhook触发器                                     │   │
│  │ 接收后端发送的请求                                        │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                          │                                     │
│                          ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 节点2: 解析请求参数 (Set节点)                           │   │
│  │ 提取所有JSON字段为独立变量                              │   │
│  │                                                        │   │
│  │ 输出:                                                 │   │
│  │   taskId = {{ $json.taskId }}                          │   │
│  │   prompt = {{ $json.prompt }}                           │   │
│  │   aiModel = {{ $json.aiModel }}    ← 从前端传来!        │   │
│  │   aspectRatio = {{ $json.aspectRatio }}                 │   │
│  │   imageCount = {{ $json.imageCount }}                   │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                          │                                     │
│                          ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 节点3: 检查图片比例 (IF节点)                            │   │
│  │ 根据 aspectRatio 参数决定尺寸                            │   │
│  └────┬────────────┬────────────┬────────────┬────────────┘   │
│       │            │            │            │                 │
│       1:1          3:4          16:9         9:16              │
│       │            │            │            │                 │
│       ▼            ▼            ▼            ▼                 │
│  ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐         │
│  │1024x1024│   │768x1024│   │1344x768│   │768x1344│         │
│  └───┬────┘   └───┬────┘   └───┬────┘   └───┬────┘         │
│      └────────────┴────────────┴────────────┘                 │
│                        │                                     │
│                        ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 节点4: AI图片生成 (HTTP Request)                        │   │
│  │ 调用 DeerAPI                                             │   │
│  │                                                        │   │
│  │ Body: {                                               │   │
│  │   "model": "{{ aiModel }}",        ← 动态参数!           │   │
│  │   "prompt": "{{ prompt }}",                            │   │
│  │   "image": "{{ productImageUrl }}",                     │   │
│  │   "width": {{ width }},              ← 根据比例动态设置  │   │
│  │   "height": {{ height }},                            │   │
│  │   "num_images": {{ imageCount }}      ← 动态参数!         │   │
│  │ }                                                      │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                          │                                     │
│                          ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 节点5: 格式化结果 (Set节点)                              │   │
│  │ 提取AI返回的图片数组                                      │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                          │                                     │
│                          ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 节点6: 回调后端API (HTTP Request)                        │   │
│  │ POST {{ callbackUrl }}                                  │   │
│  │                                                        │   │
│  │ Headers: {                                             │   │
│  │   "x-n8n-api-key": process.env.N8N_API_KEY             │   │
│  │ }                                                      │   │
│  │ Body: {                                               │   │
│  │   "taskId": "{{ taskId }}",                            │   │
│  │   "status": "completed",                               │   │
│  │   "resultImageUrls": [图片数组]                        │   │
│  │ }                                                      │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                          │                                     │
│                          ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 节点7: 返回响应 (Respond to Webhook)                     │   │
│  │ 返回 {"success": true} 给后端                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                          │
                          │ POST (回调)
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                  后端回调处理器                                    │
│                                                                 │
│  POST /api/webhooks/n8n/callback                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. 验证API Key                                           │   │
│  │ 2. 更新任务状态 → SQLite                                │   │
│  │ 3. 发布完成事件 → 更新飞书记录                           │   │
│  │ 4. 返回成功响应                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                          │
                          │ 轮询 (每2秒)
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      前端轮询更新                                 │
│                                                                 │
│  GET /api/tasks/{id} (每2秒)                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 获取最新任务状态                                          │   │
│  │ 更新前端UI:                                              │   │
│  │   - 进度条 0% → 100%                                    │   │
│  │   - 状态文字: "生成中..." → "完成"                       │   │
│  │   - 显示结果图片                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🔑 关键概念

### 1. 动态参数传递

```javascript
// ❌ 错误做法：在N8N中写死
"model": "flux-1.1-pro"    // 这样前端的设置就不起作用了！
"num_images": 4           // 这样前端选择的数量被忽略了！

// ✅ 正确做法：使用前端传来的参数
"model": "{{ $json.aiModel }}"         // 前端选什么就用什么
"num_images": {{ $json.imageCount }}   // 前端选几个就生成几个
```

### 2. 条件分支处理

```
aspectRatio参数 → IF节点 → 不同输出 → 不同尺寸

"1:1"  → 分支1 → 1024x1024
"16:9" → 分支2 → 1344x768
"9:16" → 分支3 → 768x1344
```

### 3. 错误处理

```javascript
// 即使某个环节失败，也要通知后端
try {
  // 调用AI生成
} catch (error) {
  // 回调后端，标记任务失败
  callback({
    taskId: xxx,
    status: 'failed',
    error: error.message,
  });
}
```

## 🎯 参数流转示例

### 示例1: 用户选择 16:9 比例

```
前端选择:
  - 模型: flux-realism
  - 比例: 16:9
  - 数量: 8张

↓ 传递到N8N

N8N接收:
  {
    "aiModel": "flux-realism",
    "aspectRatio": "16:9",
    "imageCount": 8
  }

↓ IF节点判断

进入 "16:9" 分支

↓ 设置尺寸

width = 1344, height = 768

↓ 调用AI

DeerAPI收到:
  {
    "model": "flux-realism",  ← 使用前端的选择
    "width": 1344,             ← 根据比例计算
    "height": 768,
    "num_images": 8            ← 使用前端的选择
  }
```

### 示例2: 用户选择不同模型

```
用户A选择 flux-realism
  → N8N使用 flux-realism 生成

用户B选择 flux-1.1-pro
  → N8N使用 flux-1.1-pro 生成

同一个工作流，不同的结果！
```

## 📝 数据格式对照表

### 前端 → N8N

| 前端UI       | 参数名      | N8N接收                       | 传递到AI               |
| ------------ | ----------- | ----------------------------- | ---------------------- |
| 模型选择器   | aiModel     | `{{ $json.aiModel }}`         | `model`                |
| 比例选择器   | aspectRatio | `{{ $json.aspectRatio }}`     | (用于计算width/height) |
| 数量选择器   | imageCount  | `{{ $json.imageCount }}`      | `num_images`           |
| 质量选择器   | quality     | `{{ $json.quality }}`         | (可选参数)             |
| 提示词输入框 | prompt      | `{{ $json.prompt }}`          | `prompt`               |
| 商品图片上传 | -           | `{{ $json.productImageUrl }}` | `image`                |

### N8N → 后端回调

| 数据            | 来源             | 后端接收                    |
| --------------- | ---------------- | --------------------------- |
| taskId          | 前端原始值       | `taskId`                    |
| status          | N8N固定值        | `"completed"` 或 `"failed"` |
| resultImageUrls | AI返回的数组     | `resultImageUrls`           |
| error           | 失败时的错误信息 | `errorMessage`              |

## 🔧 如何自定义工作流

### 添加新的图片比例

1. 在 **IF节点** 添加新条件
2. 添加新的 **Set节点** 设置尺寸
3. 连接到 **AI生成节点**

示例: 添加 `4:3` 比例

```javascript
// IF节点条件
aspectRatio == '4:3';

// 新Set节点
width: 1024;
height: 768;
```

### 添加新的AI模型

**不需要修改N8N！**

直接在前端添加模型选项即可：

```typescript
// src/lib/types/index.ts
export type ImageModel =
  | 'flux-1.1-pro'
  | 'flux-1.1-ultra'
  | 'flux-realism'
  | 'sd3'
  | 'mj-v6'
  | 'your-custom-model'; // ← 新增
```

### 添加进度更新

在生成过程中多次回调：

```
开始 → 回调(progress: 25)
处理中 → 回调(progress: 50)
生成中 → 回调(progress: 75)
完成 → 回调(progress: 100)
```

---

**总结**: N8N工作流的关键是**动态参数**，不要写死任何值，让前端的设置真正生效！
