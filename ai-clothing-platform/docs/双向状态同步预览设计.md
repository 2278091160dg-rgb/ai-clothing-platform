# åŒå‘çŠ¶æ€åŒæ­¥é¢„è§ˆè®¾è®¡

## å‰ç«¯ â†” é£ä¹¦è¡¨æ ¼ å®æ—¶çŠ¶æ€åŒæ­¥

### åœºæ™¯1ï¼šå‰ç«¯ç”¨æˆ·æ“ä½œæ—¶ï¼Œé£ä¹¦è¡¨æ ¼æ˜¾ç¤ºçŠ¶æ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é£ä¹¦å¤šç»´è¡¨æ ¼ç•Œé¢                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®°å½•ID  â”‚ æç¤ºè¯       â”‚ çŠ¶æ€    â”‚ æœ€åä¿®æ”¹è€…  â”‚ åŒæ­¥çŠ¶æ€            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rec001  â”‚ ä¸€ä»¶æ¼‚äº®çš„è£™å­ â”‚ å¤„ç†ä¸­ â”‚ ğŸŒ Webç”¨æˆ·  â”‚ ğŸ”„ åŒæ­¥ä¸­...        â”‚
â”‚          â”‚               â”‚         â”‚ 2ç§’å‰ç¼–è¾‘   â”‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rec002  â”‚ å•†åŠ¡è¥¿è£…      â”‚ å·²å®Œæˆ â”‚ ğŸ“Š é£ä¹¦ç”¨æˆ·  â”‚ âœ… å·²åŒæ­¥          â”‚
â”‚          â”‚               â”‚         â”‚ 5åˆ†é’Ÿå‰     â”‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rec003  â”‚ ä¼‘é—²Tæ¤      â”‚ å¾…å¤„ç† â”‚ ğŸ¤– APIè‡ªåŠ¨   â”‚ âš ï¸ å†²çª            â”‚
â”‚          â”‚               â”‚         â”‚             â”‚ éœ€è¦æ‰‹åŠ¨è§£å†³        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

"æœ€åä¿®æ”¹è€…"å­—æ®µçš„å›¾æ ‡è¯´æ˜ï¼š
ğŸŒ = Webå‰ç«¯ç”¨æˆ·
ğŸ“Š = é£ä¹¦è¡¨æ ¼ç”¨æˆ·
ğŸ¤– = ç³»ç»Ÿè‡ªåŠ¨ï¼ˆAPI/N8Nï¼‰
```

### åœºæ™¯2ï¼šé£ä¹¦ç”¨æˆ·æ“ä½œæ—¶ï¼Œå‰ç«¯æ˜¾ç¤ºçŠ¶æ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Webå‰ç«¯ç•Œé¢                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä»»åŠ¡å¡ç‰‡                                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ä¸€ä»¶æ¼‚äº®çš„è£™å­                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ ğŸ”„ å®æ—¶åä½œæç¤º                                     â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚                                                   â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ ğŸ‘¤ é£ä¹¦ç”¨æˆ·"å¼ ä¸‰" æ­£åœ¨ç¼–è¾‘æ­¤ä»»åŠ¡                   â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ ğŸ• 3ç§’å‰ä¿®æ”¹äº†"æç¤ºè¯"å­—æ®µ                         â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚                                                   â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ [æŸ¥çœ‹è¯¦æƒ…] [åˆ·æ–°]                                 â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ çŠ¶æ€ï¼šå¤„ç†ä¸­  â”‚  è¿›åº¦ï¼š45%                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ æœ€åä¿®æ”¹ï¼šé£ä¹¦ç”¨æˆ·  â”‚  3ç§’å‰                           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å³ä¸‹è§’æµ®åŠ¨æç¤º                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ‘¥ 2 ä¸ªä»»åŠ¡æ­£åœ¨è¢«å…¶ä»–ç”¨æˆ·ç¼–è¾‘                        â”‚      â”‚  â”‚
â”‚  â”‚  â”‚    ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…                                      â”‚      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®ç°æ–¹æ¡ˆ

### 1. å‰ç«¯å®æ—¶åä½œæŒ‡ç¤ºå™¨ç»„ä»¶

```typescript
// src/components/RealTimeCollaborationIndicator.tsx

interface CollaborationStatus {
  taskId: string;
  modifier: string;
  modifierType: 'web' | 'feishu' | 'api';
  modifiedAt: Date;
  modifiedField: string;
}

export function RealTimeCollaborationIndicator({ taskId }: { taskId: string }) {
  const [status, setStatus] = useState<CollaborationStatus | null>(null);
  const [showDetails, setShowDetails] = useState(false);

  useEffect(() => {
    // è®¢é˜…ä»»åŠ¡æ›´æ–°äº‹ä»¶
    const eventBus = getEventBus();

    const unsubscribe = eventBus.on('task.external_update', (data) => {
      if (data.taskId === taskId && data.modifier !== 'web') {
        setStatus({
          taskId: data.taskId,
          modifier: data.modifierName,
          modifierType: data.modifierType,
          modifiedAt: new Date(data.modifiedAt),
          modifiedField: data.modifiedField,
        });

        // 5ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => setStatus(null), 5000);
      }
    });

    return unsubscribe;
  }, [taskId]);

  if (!status) return null;

  return (
    <Alert className="relative overflow-hidden">
      <div className="absolute inset-0 bg-blue-500/10 animate-pulse" />

      <div className="relative flex items-center gap-3">
        <Avatar className="h-8 w-8">
          <AvatarFallback className={cn(
            "bg-blue-500 text-white",
            status.modifierType === 'feishu' && "bg-green-500",
            status.modifierType === 'api' && "bg-gray-500"
          )}>
            {status.modifierType === 'web' && <Globe className="h-4 w-4" />}
            {status.modifierType === 'feishu' && <Grid3x3 className="h-4 w-4" />}
            {status.modifierType === 'api' && <Bot className="h-4 w-4" />}
          </AvatarFallback>
        </Avatar>

        <div className="flex-1">
          <p className="text-sm font-medium">
            {status.modifierType === 'feishu' && 'é£ä¹¦ç”¨æˆ·'}
            {status.modifierType === 'web' && 'Webç”¨æˆ·'}
            {status.modifierType === 'api' && 'ç³»ç»Ÿ'}
            "{status.modifier}" æ­£åœ¨ç¼–è¾‘æ­¤ä»»åŠ¡
          </p>
          <p className="text-xs text-muted-foreground">
            {formatDistanceToNow(status.modifiedAt, { addSuffix: true })}
            ä¿®æ”¹äº† <span className="font-medium">{status.modifiedField}</span>
          </p>
        </div>

        <div className="flex gap-2">
          <Button
            size="sm"
            variant="outline"
            onClick={() => setShowDetails(true)}
          >
            æŸ¥çœ‹è¯¦æƒ…
          </Button>
          <Button
            size="sm"
            onClick={() => window.location.reload()}
          >
            åˆ·æ–°
          </Button>
        </div>
      </div>
    </Alert>
  );
}
```

### 2. å¤šç”¨æˆ·ç¼–è¾‘æ´»åŠ¨æŒ‡ç¤ºå™¨

```typescript
// src/components/ActiveUsersPanel.tsx

interface ActiveUser {
  id: string;
  name: string;
  type: 'web' | 'feishu';
  avatar?: string;
  currentTask: string;
  activity: string;
}

export function ActiveUsersPanel() {
  const [activeUsers, setActiveUsers] = useState<ActiveUser[]>([]);

  useEffect(() => {
    // è®¢é˜…æ´»è·ƒç”¨æˆ·åˆ—è¡¨
    const syncService = getSyncService();

    const unsubscribe = syncService.subscribeToActiveUsers((users) => {
      // è¿‡æ»¤æ‰å½“å‰ç”¨æˆ·
      setActiveUsers(users.filter(u => u.type !== 'web'));
    });

    return unsubscribe;
  }, []);

  if (activeUsers.length === 0) return null;

  return (
    <div className="fixed bottom-4 right-4 z-50">
      <Popover>
        <PopoverTrigger asChild>
          <Button variant="secondary" className="shadow-lg">
            <Users className="h-4 w-4 mr-2" />
            {activeUsers.length} ä¸ªå…¶ä»–ç”¨æˆ·æ­£åœ¨ç¼–è¾‘
          </Button>
        </PopoverTrigger>

        <PopoverContent className="w-80" align="end">
          <div className="space-y-3">
            <h4 className="font-medium">æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·</h4>

            <div className="space-y-2">
              {activeUsers.map(user => (
                <div
                  key={user.id}
                  className="flex items-center gap-3 p-2 rounded-lg bg-muted/50"
                >
                  <Avatar className="h-8 w-8">
                    <AvatarImage src={user.avatar} />
                    <AvatarFallback className={cn(
                      "bg-blue-500 text-white",
                      user.type === 'feishu' && "bg-green-500"
                    )}>
                      {user.name[0]}
                    </AvatarFallback>
                  </Avatar>

                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium truncate">{user.name}</p>
                    <p className="text-xs text-muted-foreground truncate">
                      {user.activity}
                    </p>
                  </div>

                  <Badge variant="outline" className="text-xs">
                    {user.type === 'feishu' && 'ğŸ“Š é£ä¹¦'}
                    {user.type === 'web' && 'ğŸŒ Web'}
                  </Badge>
                </div>
              ))}
            </div>
          </div>
        </PopoverContent>
      </Popover>
    </div>
  );
}
```

### 3. ä»»åŠ¡å¡ç‰‡ä¸Šçš„åä½œçŠ¶æ€

```typescript
// src/components/TaskCard.tsx - å¢å¼ºç‰ˆ

export function TaskCard({ task }: { task: Task }) {
  const [collaborationStatus, setCollaborationStatus] = useState<{
    isBeingEdited: boolean;
    modifier?: string;
  }>({ isBeingEdited: false });

  return (
    <Card className={cn(
      "transition-all",
      collaborationStatus.isBeingEdited && "ring-2 ring-blue-500"
    )}>
      <CardHeader>
        <div className="flex items-start justify-between">
          <div className="flex-1">
            <CardTitle className="text-base">
              {task.prompt?.slice(0, 50)}...
            </CardTitle>
          </div>

          {/* åä½œçŠ¶æ€å¾½ç«  */}
          <div className="flex items-center gap-2">
            {task.lastModifiedBy !== 'web' && (
              <Badge variant="secondary" className="text-xs">
                {task.lastModifiedBy === 'feishu' && 'ğŸ“Š é£ä¹¦ç”¨æˆ·ç¼–è¾‘'}
                {task.lastModifiedBy === 'api' && 'ğŸ¤– ç³»ç»Ÿæ›´æ–°'}
              </Badge>
            )}

            <SyncStatusIndicator
              taskId={task.id}
              lastModifiedAt={task.lastModifiedAt}
            />
          </div>
        </div>

        {/* æœ€åä¿®æ”¹ä¿¡æ¯ */}
        <div className="flex items-center gap-2 text-xs text-muted-foreground">
          <User className="h-3 w-3" />
          <span>
            {task.lastModifiedBy === 'web' && 'ä½ '}
            {task.lastModifiedBy === 'feishu' && 'é£ä¹¦ç”¨æˆ·'}
            {task.lastModifiedBy === 'api' && 'ç³»ç»Ÿ'}
          </span>
          <span>Â·</span>
          <Clock className="h-3 w-3" />
          <span>{formatDistanceToNow(task.lastModifiedAt, { addSuffix: true })}</span>
        </div>
      </CardHeader>

      <CardContent>
        {/* å®æ—¶åä½œæç¤º */}
        {collaborationStatus.isBeingEdited && (
          <RealTimeCollaborationIndicator taskId={task.id} />
        )}

        {/* ä»»åŠ¡å†…å®¹ */}
        <div className="space-y-2">
          <div className="flex justify-between text-sm">
            <span>çŠ¶æ€ï¼š</span>
            <Badge>{task.status}</Badge>
          </div>
          {task.progress > 0 && task.progress < 100 && (
            <div className="space-y-1">
              <div className="flex justify-between text-xs">
                <span>è¿›åº¦</span>
                <span>{task.progress}%</span>
              </div>
              <Progress value={task.progress} />
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
```

### 4. é£ä¹¦è¡¨æ ¼çŠ¶æ€åŒæ­¥

#### é£ä¹¦è¡¨æ ¼å­—æ®µé…ç½®

```javascript
// é£ä¹¦å¤šç»´è¡¨æ ¼å­—æ®µå®šä¹‰

const feishuTableFields = {
  // åŸºç¡€å­—æ®µ
  "è®°å½•ID": "record_id",
  "æç¤ºè¯": "text",
  "çŠ¶æ€": "select",
  "åˆ›å»ºæ—¶é—´": "created_time",

  // æ–°å¢ï¼šåä½œçŠ¶æ€å­—æ®µ
  "æœ€åä¿®æ”¹è€…": {
    type: "text",
    readonly: true,
    formula: `
      SWITCH(
        lastModifiedBy,
        "web", "ğŸŒ Webç”¨æˆ·",
        "feishu", "ğŸ“Š é£ä¹¦ç”¨æˆ·",
        "api", "ğŸ¤– ç³»ç»Ÿè‡ªåŠ¨",
        "æœªçŸ¥"
      )
    `
  },

  "æœ€åä¿®æ”¹æ—¶é—´": {
    type: "datetime",
    readonly: true,
    field: "lastModifiedAt"
  },

  "åŒæ­¥çŠ¶æ€": {
    type: "select",
    readonly: true,
    options: ["âœ… å·²åŒæ­¥", "ğŸ”„ åŒæ­¥ä¸­", "âš ï¸ å†²çª", "âŒ åŒæ­¥å¤±è´¥"]
  },

  "å½“å‰ç¼–è¾‘è€…": {
    type: "text",
    readonly: true,
    description: "æ­£åœ¨ç¼–è¾‘æ­¤è®°å½•çš„ç”¨æˆ·"
  }
};
```

#### é£ä¹¦è¡¨æ ¼æ¡ä»¶æ ¼å¼ï¼ˆé«˜äº®æ­£åœ¨ç¼–è¾‘çš„è®°å½•ï¼‰

```javascript
// é£ä¹¦è¡¨æ ¼è‡ªåŠ¨åŒ–è§„åˆ™

const activeEditingHighlight = {
  name: "é«˜äº®æ­£åœ¨ç¼–è¾‘çš„è®°å½•",
  condition: {
    field: "åŒæ­¥çŠ¶æ€",
    operator: "is",
    value: ["ğŸ”„ åŒæ­¥ä¸­"]
  },
  format: {
    background_color: "#DBEAFE", // è“è‰²èƒŒæ™¯
    border_color: "#3B82F6",
    border_width: 2
  }
};

const conflictHighlight = {
  name: "é«˜äº®å†²çªè®°å½•",
  condition: {
    field: "åŒæ­¥çŠ¶æ€",
    operator: "is",
    value: ["âš ï¸ å†²çª"]
  },
  format: {
    background_color: "#FEE2E2", // çº¢è‰²èƒŒæ™¯
    border_color: "#EF4444",
    border_width: 2
  }
};
```

### 5. WebSocketå®æ—¶åŒæ­¥æœåŠ¡

```typescript
// src/lib/services/realtime-sync.service.ts

export class RealTimeSyncService {
  private ws: WebSocket | null = null;
  private subscribers: Map<string, Set<Function>> = new Map();

  /**
   * è¿æ¥WebSocket
   */
  connect() {
    const wsUrl = process.env.NEXT_PUBLIC_WS_URL;
    this.ws = new WebSocket(wsUrl);

    this.ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      this.handleMessage(data);
    };
  }

  /**
   * è®¢é˜…ä»»åŠ¡æ›´æ–°
   */
  subscribeToTask(taskId: string, callback: Function) {
    if (!this.subscribers.has(taskId)) {
      this.subscribers.set(taskId, new Set());
    }
    this.subscribers.get(taskId)!.add(callback);

    // å‘é€è®¢é˜…æ¶ˆæ¯
    this.send({
      type: 'subscribe',
      taskId,
    });

    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      this.subscribers.get(taskId)?.delete(callback);
      this.send({
        type: 'unsubscribe',
        taskId,
      });
    };
  }

  /**
   * è®¢é˜…æ´»è·ƒç”¨æˆ·åˆ—è¡¨
   */
  subscribeToActiveUsers(callback: (users: ActiveUser[]) => void) {
    this.ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'active_users') {
        callback(data.users);
      }
    };
  }

  /**
   * å¹¿æ’­ä»»åŠ¡æ›´æ–°
   */
  broadcastTaskUpdate(task: Task, modifiedBy: string) {
    this.send({
      type: 'task_update',
      taskId: task.id,
      task,
      modifiedBy,
      timestamp: new Date().toISOString(),
    });
  }

  /**
   * å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
   */
  private handleMessage(data: any) {
    switch (data.type) {
      case 'task_update':
        // é€šçŸ¥è®¢é˜…è€…
        const subscribers = this.subscribers.get(data.taskId);
        if (subscribers) {
          subscribers.forEach(callback => callback(data));
        }

        // å‘é€åˆ°äº‹ä»¶æ€»çº¿
        const eventBus = getEventBus();
        eventBus.emit('task.external_update', {
          taskId: data.taskId,
          modifierName: data.modifiedBy,
          modifierType: data.task.lastModifiedBy,
          modifiedAt: data.timestamp,
          modifiedField: data.changedField,
        });
        break;
    }
  }

  /**
   * å‘é€æ¶ˆæ¯
   */
  private send(data: any) {
    if (this.ws?.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify(data));
    }
  }
}
```

### 6. APIç«¯ç‚¹ï¼šæ´»è·ƒç”¨æˆ·æŸ¥è¯¢

```typescript
// src/app/api/active-users/route.ts

export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const taskId = searchParams.get('taskId');

  // æŸ¥è¯¢æ´»è·ƒç”¨æˆ·
  const activeUsers = await getActiveUsers(taskId);

  return NextResponse.json({
    users: activeUsers.map(user => ({
      id: user.id,
      name: user.name,
      type: user.lastModifiedBy === 'web' ? 'web' : 'feishu',
      currentTask: user.currentTaskId,
      activity: `${user.action} "${user.modifiedField}"`,
    })),
  });
}
```

---

## æ€»ç»“

### å‰ç«¯æ˜¾ç¤ºé£ä¹¦æ“ä½œçŠ¶æ€
- âœ… ä»»åŠ¡å¡ç‰‡ä¸Šçš„"æœ€åä¿®æ”¹è€…"å¾½ç« 
- âœ… å®æ—¶åä½œæç¤ºï¼ˆAlertç»„ä»¶ï¼‰
- âœ… å³ä¸‹è§’æ´»è·ƒç”¨æˆ·æŒ‡ç¤ºå™¨
- âœ… WebSocketå®æ—¶æ›´æ–°

### é£ä¹¦æ˜¾ç¤ºå‰ç«¯æ“ä½œçŠ¶æ€
- âœ… "æœ€åä¿®æ”¹è€…"å­—æ®µï¼ˆå¸¦å›¾æ ‡ï¼‰
- âœ… "åŒæ­¥çŠ¶æ€"å­—æ®µï¼ˆå·²åŒæ­¥/åŒæ­¥ä¸­/å†²çªï¼‰
- âœ… æ¡ä»¶æ ¼å¼é«˜äº®æ­£åœ¨ç¼–è¾‘çš„è®°å½•
- âœ… "å½“å‰ç¼–è¾‘è€…"å­—æ®µ

### ç”¨æˆ·ä½“éªŒ
- Webç”¨æˆ·å¯ä»¥çœ‹åˆ°é£ä¹¦ç”¨æˆ·æ­£åœ¨ç¼–è¾‘çš„ä»»åŠ¡
- é£ä¹¦ç”¨æˆ·å¯ä»¥çœ‹åˆ°Webç”¨æˆ·æ­£åœ¨ç¼–è¾‘çš„è®°å½•
- åŒå‘å®æ—¶åŒæ­¥ï¼Œå»¶è¿Ÿ < 1ç§’
- å†²çªæ—¶æä¾›æ˜ç¡®çš„è§†è§‰æç¤º
