# 📊 v2 vs v3 版本对比

## 🎯 核心差异

### 为什么需要v3版本？

v2版本基于假设的配置，v3版本根据你提供的实际配置（广州场 copy.json）重新优化。

---

## 📋 节点类型对比

### 飞书节点

| 操作     | v2版本                         | v3版本（实际）                        | 是否兼容 |
| -------- | ------------------------------ | ------------------------------------- | -------- |
| 飞书鉴权 | ❌ 未单独使用                  | ✅ feishu-lite                        | ❌       |
| 读取数据 | `n8n-nodes-base.feishuBitable` | ✅ `n8n-nodes-feishu-lite.feishuNode` | ❌       |
| 更新数据 | `n8n-nodes-base.feishuBitable` | ✅ `n8n-nodes-feishu-lite.feishuNode` | ❌       |

**结论**: v2使用的标准节点在你的N8N环境中可能不存在，v3使用的是你实际安装的feishu-lite插件。

### DeerAPI节点

| 操作   | v2版本       | v3版本（实际）                 | 是否兼容 |
| ------ | ------------ | ------------------------------ | -------- |
| AI生成 | HTTP Request | ✅ `n8n-nodes-deerapi.deerApi` | ❌       |

**结论**:

- v2使用通用HTTP Request调用DeerAPI API
- v3使用DeerAPI专用插件（更简单，直接处理二进制数据）

---

## 🔄 数据流对比

### v2版本数据流

```
前端请求 → N8N → DeerAPI API → 返回URL数组 → 回调前端
                              ↓
                        返回URL（字符串）
```

### v3版本数据流（实际）

```
飞书触发 → N8N → DeerAPI插件 → 返回二进制数据 → 上传飞书 → 回传
                          ↓
                    二进制数据（图片）
```

**关键差异**:

- v2: DeerAPI返回URL数组，前端使用URL
- v3: DeerAPI返回二进制数据，需要上传到飞书获取file_token

---

## ⚠️ 主要问题修复

### 问题1：飞书节点不存在 ✅ 已修复

**v2版本**:

```json
{
  "type": "n8n-nodes-base.feishuBitable"
}
```

❌ 你的N8N可能没有这个节点

**v3版本**:

```json
{
  "type": "n8n-nodes-feishu-lite.feishuNode"
}
```

✅ 使用你实际安装的feishu-lite插件

### 问题2：DeerAPI调用方式 ✅ 已修复

**v2版本**:

```json
{
  "type": "n8n-nodes-base.httpRequest",
  "url": "https://api.deerapi.com/v1/ai/generate",
  "body": {
    "model": "Gemini-3-Pro-Image",
    "image": "{{ $json.productImageUrl }}"
  }
}
```

❌ 需要手动构造API请求

**v3版本**:

```json
{
  "type": "n8n-nodes-deerapi.deerApi",
  "mode": "image",
  "userPrompt": "提示词...",
  "aspectRatio": "3:4"
}
```

✅ 使用专用插件，自动处理二进制数据

### 问题3：缺少上传步骤 ✅ 已修复

**v2版本**:

```
DeerAPI → 返回URL → 直接使用URL
```

❌ 没有上传到飞书

**v3版本**:

```
DeerAPI → 二进制数据 → 数据处理 → 上传飞书 → 获取file_token → 更新记录
```

✅ 完整的上传流程

---

## 📊 详细功能对比

### 功能支持

| 功能               | v2版本 | v3版本 |
| ------------------ | ------ | ------ |
| 飞书鉴权           | ❌     | ✅     |
| 读取飞书记录       | ✅     | ✅     |
| 更新飞书记录       | ✅     | ✅     |
| 下载图片（带鉴权） | ❌     | ✅     |
| 场景图可选         | ✅     | ✅     |
| DeerAPI生成        | ✅     | ✅     |
| 二进制数据处理     | ✅     | ✅     |
| 上传到飞书         | ❌     | ✅     |
| 多尺寸比例         | ✅     | ❌     |
| 多数量生成         | ✅     | ❌     |

**说明**:

- v3版本移除了多尺寸比例和多数量生成，因为DeerAPI插件一次只生成一张图
- 如果你需要多尺寸或多数量，需要修改v3版本，添加循环处理

---

## 🎯 推荐使用

### 场景1：仅前端使用

**推荐**: v2版本前端工作流

**文件**: `n8n-workflow-frontend.json`

**原因**:

- ✅ 前端不需要处理飞书鉴权
- ✅ 前端不需要上传到飞书
- ✅ HTTP Request调用DeerAPI API更灵活

### 场景2：飞书使用

**推荐**: v3版本飞书工作流

**文件**: `n8n-workflow-feishu-v3.json`

**原因**:

- ✅ 使用你实际安装的插件
- ✅ 完整的数据流处理
- ✅ 符合你的实际配置

---

## 🔧 v3版本的限制

### 当前限制

1. **单次生成**: DeerAPI插件一次只生成一张图
2. **固定尺寸**: 每次执行只能生成一种尺寸
3. **单一结果**: 只能上传一张结果图片到飞书

### 如果需要多尺寸/多数量

**方案1：多次执行**

- 在飞书中创建多条记录
- 每条记录选择不同的尺寸
- 逐个点击按钮生成

**方案2：扩展v3版本**

- 在v3版本中添加循环处理
- 根据尺寸数量循环调用DeerAPI
- 收集所有结果后批量上传

**需要吗？**
如果你需要多尺寸/多数量功能，请告诉我，我可以扩展v3版本。

---

## 📝 迁移指南

### 从v2迁移到v3

**步骤1**: 导入v3版本

```
1. 打开N8N
2. 导入 n8n-workflow-feishu-v3.json
3. 检查节点是否正确导入
```

**步骤2**: 配置凭证

```
1. Feishu Credentials account
2. DeerAPI account
```

**步骤3**: 检查飞书字段

```
1. 提示词：多行文本 ✅
2. 商品图：附件 ✅
3. 场景图：附件（可选）✅
4. 尺寸比例：单选（可选）✅
5. 状态：单选 ✅
6. 生成结果：附件 ✅
```

**步骤4**: 配置飞书自动化

```
触发器：按钮被点击
操作：发送Webhook请求
URL：从Webhook触发器节点复制
Body：{
  "app_token": xxx,
  "table_id": xxx,
  "record_id": xxx
}
```

**步骤5**: 测试

```
1. 测试有场景图
2. 测试无场景图
3. 验证状态更新
4. 验证结果上传
```

---

## ❓ 常见问题

### Q1: v2版本还能用吗？

**A**:

- 前端工作流：✅ 可以用
- 飞书工作流：❌ 不能用（节点类型不匹配）

### Q2: v3版本为什么更短？

**A**:

- v3版本使用专用插件，简化了操作
- v3版本移除了多尺寸比例的4个并行分支
- v3版本更符合你的实际使用场景

### Q3: 我需要多尺寸功能怎么办？

**A**:

1. 在飞书中为每种尺寸创建一条记录
2. 分别点击按钮生成
3. 或者告诉我，我可以扩展v3版本支持循环

### Q4: v3版本支持前端调用吗？

**A**:

- 前端调用请使用 `n8n-workflow-frontend.json`
- 飞书调用请使用 `n8n-workflow-feishu-v3.json`
- 两者是独立的，不能混用

### Q5: 如何确认我使用的是哪个版本？

**A**:

- 文件名包含版本号：v2 或 v3
- v3有14个节点，v2有20个节点
- v3使用feishu-lite插件，v2使用标准节点

---

## 📊 总结

| 项目       | v2版本        | v3版本      | 推荐             |
| ---------- | ------------- | ----------- | ---------------- |
| 前端工作流 | ✅ 可用       | -           | ✅ v2            |
| 飞书工作流 | ❌ 节点不匹配 | ✅ 符合实际 | ✅ v3            |
| 节点数量   | 20个          | 14个        | v3更简洁         |
| 数据流     | URL           | 二进制      | 各有优势         |
| 上传飞书   | ❌ 缺少       | ✅ 完整     | v3               |
| 多尺寸支持 | ✅            | ❌          | v2（飞书不建议） |

**最终建议**:

- ✅ 前端：使用 `n8n-workflow-frontend.json`
- ✅ 飞书：使用 `n8n-workflow-feishu-v3.json`

---

**更新时间**: 2025-01-27
**版本**: v3
**状态**: ✅ 已验证
