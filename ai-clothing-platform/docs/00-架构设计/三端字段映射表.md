# 📊 三端字段映射表

## 概述

本文档详细说明了前端Web、N8N工作流、飞书多维表格三者之间的字段映射关系，确保三端联动不脱节。

---

## 1. 字段映射总表

### 1.1 输入字段映射

| 功能             | 前端字段名        | N8N接收参数名     | 飞书字段名       | 类型   | 说明                         |
| ---------------- | ----------------- | ----------------- | ---------------- | ------ | ---------------------------- |
| 任务ID           | `taskId`          | `taskId`          | -                | string | 前端生成，存储在数据库       |
| 用户ID           | `userId`          | `userId`          | 用户ID           | string | 标识用户身份                 |
| **原始提示词**   | `prompt`          | `prompt`          | 提示词           | string | 用户输入的原始提示词         |
| **AI优化提示词** | `optimizedPrompt` | `optimizedPrompt` | **优化后提示词** | string | AI优化后的提示词（可选）     |
| **提示词来源**   | `promptSource`    | `promptSource`    | **提示词来源**   | enum   | USER/AI_OPTIMIZED/FEISHU     |
| 商品图片         | `productImageUrl` | `productImageUrl` | 商品图           | string | 第一张图片：产品图           |
| 场景图片         | `sceneImageUrl`   | `sceneImageUrl`   | 场景图           | string | 第二张图片：参考场景（可选） |
| AI模型           | `aiModel`         | `aiModel`         | AI模型           | string | 默认：Gemini-3-Pro-Image     |
| 尺寸比例         | `aspectRatio`     | `aspectRatio`     | 尺寸比例         | string | 默认：3:4                    |
| 生成数量         | `imageCount`      | `imageCount`      | 生成数量         | number | 默认：4                      |
| 清晰度           | `quality`         | `quality`         | -                | string | 默认：high                   |
| 回调URL          | `callbackUrl`     | `callbackUrl`     | -                | string | N8N完成后回调的URL           |

### 1.2 输出字段映射

| 功能      | 前端字段名          | N8N返回参数名       | 飞书字段名 | 类型     | 说明                                |
| --------- | ------------------- | ------------------- | ---------- | -------- | ----------------------------------- |
| 任务状态  | `status`            | `status`            | 状态       | string   | pending/processing/completed/failed |
| 结果图片  | `resultImageUrls`   | `resultImageUrls`   | 生成结果   | string[] | AI生成的图片URL数组                 |
| 结果Token | `resultImageTokens` | `resultImageTokens` | -          | string[] | 飞书的file_token（内部使用）        |
| 进度      | `progress`          | `progress`          | 进度       | number   | 0-100                               |
| 错误信息  | `error`             | `error`             | 错误信息   | string   | 失败时的错误描述                    |

### 1.3 飞书特有字段

| 字段名称         | 字段ID            | 类型     | 值来源   | 说明                                      |
| ---------------- | ----------------- | -------- | -------- | ----------------------------------------- |
| **优化后提示词** | `optimizedPrompt` | 多行文本 | 系统写入 | AI优化后的提示词                          |
| **AI对话**       | `aiChatUrl`       | URL      | 系统写入 | 点击跳转到AI对话界面                      |
| **提示词来源**   | `promptSource`    | 单选     | 系统写入 | 用户输入/AI优化                           |
| 数据来源         | `dataSource`      | 单选     | 系统写入 | 标识数据来源（前端/飞书/API）             |
| 同步状态         | `syncStatus`      | 单选     | 系统写入 | 标识同步状态（已同步/同步中/冲突/失败）   |
| 前端用户ID       | `frontendUserId`  | 文本     | 系统写入 | 前端用户的标识                            |
| 状态             | `status`          | 单选     | 系统更新 | 任务状态（待处理/处理中/已完成/生成失败） |

---

## 2. 数据流验证

### 2.1 前端 → N8N → 前端

**完整数据流（包含AI优化）：**

```
前端POST /api/tasks
    ↓
Body: {
  "taskId": "uuid-123",
  "userId": "user-abc",
  "prompt": "红色连衣裙",                           // 原始提示词
  "optimizedPrompt": "An elegant red silk evening gown...", // AI优化后（可选）
  "promptSource": "AI_OPTIMIZED",                   // 最终使用哪个
  "productImageUrl": "data:image/png;base64,...",
  "sceneImageUrl": "data:image/png;base64,...",
  "aiModel": "Gemini-3-Pro-Image",
  "aspectRatio": "3:4",
  "imageCount": 4,
  "quality": "high",
  "callbackUrl": "https://你的网站.com/api/webhooks/n8n/callback"
}
    ↓
N8N接收
    ↓
【新增】选择最终提示词节点：
  if (promptSource === 'AI_OPTIMIZED' && optimizedPrompt) {
    finalPrompt = optimizedPrompt;  // 使用AI优化版
  } else {
    finalPrompt = prompt;           // 使用原始版
  }
    ↓
处理：AI图片生成（使用 finalPrompt）
    ↓
N8N回调 /api/webhooks/n8n/callback
    ↓
Body: {
  "taskId": "uuid-123",
  "status": "completed",
  "resultImageUrls": ["https://..."],
  "progress": 100
}
    ↓
前端更新数据库
    ↓
前端显示结果
```

**字段对应验证（包含AI优化）：**

| 步骤 | 前端发送          | N8N接收 | N8N处理 | N8N返回 | 前端接收 |
| ---- | ----------------- | ------- | ------- | ------- | -------- |
| 1    | `taskId`          | ✅      | -       | ✅      | ✅       |
| 2    | `prompt`          | ✅      | -       | -       | -        |
| 3    | `optimizedPrompt` | ✅      | ✅ 选择 | -       | -        |
| 4    | `promptSource`    | ✅      | ✅ 选择 | -       | -        |
| 5    | `finalPrompt`     | -       | ✅ 生成 | ✅      | -        |
| 6    | `productImageUrl` | ✅      | -       | -       | -        |
| 7    | `callbackUrl`     | ✅      | -       | -       | ✅       |

### 2.2 飞书 → N8N → 飞书

**完整数据流：**

```
飞书自动化触发
    ↓
Body: {
  "app_token": "app_abc123",
  "table_id": "tbl_xyz456",
  "record_id": "rec_789"
}
    ↓
N8N接收
    ↓
飞书API读取记录
    ↓
获取: {
  "提示词": "时尚模特在繁华街头",
  "商品图": [{"url": "https://..."}],
  "场景图": [{"url": "https://..."}],
  "AI模型": "Gemini-3-Pro-Image",
  "尺寸比例": "3:4",
  "生成数量": 4
}
    ↓
N8N处理：AI图片生成
    ↓
N8N上传结果到飞书
    ↓
飞书记录更新
    ↓
字段更新: {
  "生成结果": [{"file_token": "vbox_abc"}],
  "状态": "已完成"
}
```

**字段对应验证：**

| 步骤 | 飞书字段           | N8N读取 | N8N写入             | 验证 |
| ---- | ------------------ | ------- | ------------------- | ---- |
| 1    | `提示词`           | ✅      | -                   | ✅   |
| 2    | **`优化后提示词`** | ✅      | -                   | ✅   |
| 3    | **`提示词来源`**   | ✅      | -                   | ✅   |
| 4    | `商品图`           | ✅      | -                   | ✅   |
| 5    | `场景图`           | ✅      | -                   | ✅   |
| 6    | `AI模型`           | ✅      | -                   | ✅   |
| 7    | `尺寸比例`         | ✅      | -                   | ✅   |
| 8    | `生成数量`         | ✅      | -                   | ✅   |
| 9    | `状态`             | ✅      | ✅（处理中→已完成） | ✅   |

### 2.3 前端 ↔ 飞书 双向同步

**通过事件系统的数据流：**

```
前端创建任务
    ↓
事件系统：task.created
    ↓
飞书创建记录
    ↓
保存 feishuRecordId 到数据库
    ↓
N8N完成生成
    ↓
事件系统：task.completed
    ↓
飞书更新记录
```

**字段对应验证：**

| 步骤 | 数据库字段        | 飞书字段           | 同步方式 |
| ---- | ----------------- | ------------------ | -------- |
| 1    | `feishuRecordId`  | `record_id`        | 自动关联 |
| 2    | `prompt`          | `提示词`           | 事件同步 |
| 3    | `optimizedPrompt` | **`优化后提示词`** | 事件同步 |
| 4    | `promptSource`    | **`提示词来源`**   | 事件同步 |
| 5    | `status`          | `状态`             | 事件同步 |
| 6    | `resultImageUrls` | `生成结果`         | 事件同步 |

---

## 3. 枚举值映射

### 3.1 状态映射

| 前端/数据库  | 飞书显示 | N8N | 说明        |
| ------------ | -------- | --- | ----------- |
| `pending`    | 待处理   | -   | 初始状态    |
| `processing` | 处理中   | -   | N8N正在处理 |
| `completed`  | 已完成   | -   | 生成成功    |
| `failed`     | 生成失败 | -   | 生成失败    |

### 3.2 数据来源映射

| 前端值         | 飞书显示    | 来源        |
| -------------- | ----------- | ----------- |
| `USER`         | 🌐 前端用户 | 前端Web界面 |
| `AI_OPTIMIZED` | 🌐 前端用户 | 前端AI优化  |
| `FEISHU`       | 📊 飞书用户 | 飞书表格    |

### 3.4 提示词来源映射

| 前端值         | 飞书显示 | 说明                     |
| -------------- | -------- | ------------------------ |
| `USER`         | 用户输入 | 最终使用用户原始提示词   |
| `AI_OPTIMIZED` | AI优化   | 最终使用AI优化后的提示词 |
| `FEISHU`       | 用户输入 | 飞书表格输入（默认）     |

### 3.3 同步状态映射

| 前端值    | 飞书显示  | 说明     |
| --------- | --------- | -------- |
| `PENDING` | 🔄 同步中 | 等待同步 |
| `SYNCING` | 🔄 同步中 | 正在同步 |
| `SYNCED`  | ✅ 已同步 | 同步成功 |
| `FAILED`  | ❌ 失败   | 同步失败 |

---

## 4. 字段类型映射

### 4.1 图片字段

| 前端存储       | N8N处理        | 飞书存储   | 转换方式         |
| -------------- | -------------- | ---------- | ---------------- |
| Base64 dataUrl | URL            | file_token | 上传到飞书云空间 |
| Base64 dataUrl | URL（DeerAPI） | file_token | 上传到飞书云空间 |
| file_token     | -              | file_token | 直接使用         |

### 4.2 文本字段

| 前端类型 | N8N类型 | 飞书类型 | 说明       |
| -------- | ------- | -------- | ---------- |
| string   | string  | 多行文本 | 提示词等   |
| string   | string  | 文本     | 用户ID等   |
| number   | number  | 数字     | 生成数量等 |

### 4.3 枚举字段

| 前端类型      | N8N类型 | 飞书类型 | 说明         |
| ------------- | ------- | -------- | ------------ |
| enum (string) | string  | 单选     | 状态、模型等 |
| enum (string) | string  | 单选     | 数据来源等   |

---

## 5. 特殊处理逻辑

### 5.1 场景图可选处理

**前端 → N8N：**

```json
{
  "sceneImageUrl": "https://..."  // 有场景图
}
// 或者
{
  "sceneImageUrl": ""  // 无场景图（空字符串）
}
```

**N8N处理：**

```
IF sceneImageUrl 不为空
  THEN: 下载场景图 → 双图生成
  ELSE: 单图生成
```

**飞书读取：**

```
$json.data.records[0].fields['场景图'] &&
  $json.data.records[0].fields['场景图'][0].url || ''
```

### 5.2 尺寸比例标准化

**前端输入：**

```
支持格式：
- "3:4"（标准）
- "3：4"（中文冒号）
- "3，4"（中文逗号）
```

**N8N标准化：**

```
$json.aspectRatio.trim()
  .replace(/：/g, ':')
  .replace(/，/g, ',')
```

**飞书存储：**

```
直接存储标准化后的值
```

### 5.3 回调URL处理

**前端配置：**

```typescript
// 默认回调URL
const finalCallbackUrl =
  callbackUrl || `${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/n8n/callback`;
```

**N8N回调：**

```
POST {{ callbackUrl }}
Headers: {
  "x-n8n-api-key": "n8n-callback-secret-key-2024"
}
Body: {
  "taskId": "...",
  "status": "completed",
  "resultImageUrls": [...],
  "progress": 100
}
```

---

## 6. 反向验证表

### 6.1 前端轨道验证

| 检查项         | 验证方法        | 期望结果                            |
| -------------- | --------------- | ----------------------------------- |
| 前端能创建任务 | 在Web端提交任务 | ✅ 返回success                      |
| 飞书有记录     | 查看飞书表格    | ✅ 新建记录，数据来源="🌐 前端用户" |
| N8N正常处理    | 查看N8N执行日志 | ✅ 全部节点绿色                     |
| 前端能显示结果 | 查看Web端       | ✅ 显示生成图片                     |
| 飞书能更新结果 | 查看飞书表格    | ✅ 生成结果有图片                   |

### 6.2 飞书轨道验证

| 检查项         | 验证方法       | 期望结果            |
| -------------- | -------------- | ------------------- |
| 能触发N8N      | 点击"点击按钮" | ✅ N8N收到请求      |
| 飞书记录更新   | 查看飞书表格   | ✅ 状态变为"处理中" |
| N8N能读取数据  | 查看N8N日志    | ✅ 成功读取所有字段 |
| N8N能生成图片  | 查看N8N日志    | ✅ AI生成成功       |
| 飞书能显示结果 | 查看飞书表格   | ✅ 生成结果有图片   |

### 6.3 同步验证

| 检查项                 | 验证方法               | 期望结果             |
| ---------------------- | ---------------------- | -------------------- |
| 前端创建后飞书有记录   | 前端创建任务后查看飞书 | ✅ 飞书有新记录      |
| 飞书记录有数据来源标识 | 查看飞书记录           | ✅ 显示"🌐 前端用户" |
| 完成后飞书更新结果     | 等待生成完成           | ✅ 生成结果有图片    |
| 状态正确更新           | 查看飞书记录状态       | ✅ "已完成"          |

---

## 7. 常见错误和解决方案

### 7.1 字段名称错误

**错误：** `Field not found: 提示词`

**原因：** 飞书字段名称不匹配

**解决：**

1. 检查飞书表格字段名称是否完全是"提示词"（不是"提示 "或"提示词："）
2. 检查N8N中的字段引用是否正确

### 7.2 类型不匹配

**错误：** `Cannot read property '0' of undefined`

**原因：** 飞书字段类型不对

**解决：**

1. 确保"提示词"是"多行文本"类型
2. 确保"商品图"是"附件"类型
3. 确保"状态"是"单选"类型

### 7.3 凭证ID错误

**错误：** `Credentials not found`

**原因：** N8N凭证ID不匹配

**解决：**

1. 在N8N中检查凭证配置
2. 确保凭证ID与工作流中的ID一致
3. 重新关联凭证到节点

### 7.4 环境变量未设置

**错误：** `FEISHU_APP_TOKEN is not defined`

**原因：** N8N环境变量未配置

**解决：**

1. 在N8N的.env文件中添加环境变量
2. 重启N8N服务
3. 验证环境变量加载成功

---

## 8. 测试用例

### 8.1 前端轨道测试

**测试1：基本流程**

```json
{
  "productImageUrl": "data:image/png;base64,iVBORw0KG...",
  "prompt": "测试提示词",
  "aspectRatio": "3:4"
}
```

**验证点：**

- ✅ 任务创建成功
- ✅ 飞书有记录
- ✅ 生成结果正确

### 8.2 飞书轨道测试

**测试2：有场景图**

```
提示词：测试提示词
商品图：上传图片
场景图：上传图片
```

**验证点：**

- ✅ N8N读取两个字段
- ✅ AI生成使用两张图
- ✅ 结果正确

**测试3：无场景图**

```
提示词：测试提示词
商品图：上传图片
场景图：（留空）
```

**验证点：**

- ✅ N8N只读取一个字段
- ✅ AI生成使用一张图
- ✅ 不会报错

---

## 9. 字段配置检查清单

### 9.1 前端检查

- [ ] `.env.local` 文件已配置
- [ ] 飞书环境变量已设置
- [ ] N8N环境变量已设置
- [ ] 数据库连接正常

### 9.2 N8N检查

- [ ] 环境变量已配置
- [ ] 3个凭证已创建
- [ ] 工作流已导入
- [ ] Webhook已激活
- [ ] 凭证已关联

### 9.3 飞书检查

- [ ] 11个字段已创建
- [ ] 字段名称完全匹配
- [ ] 自动化已配置
- [ ] 自动化已启用

---

## 10. 总结

本文档提供了完整的字段映射表，确保三端联动不脱节：

1. ✅ **前端 → N8N → 前端**：完整闭环
2. ✅ **飞书 → N8N → 飞书**：完整闭环
3. ✅ **前端 ↔ 飞书**：双向同步
4. ✅ **字段映射正确**：所有字段都经过验证
5. ✅ **类型匹配**：所有类型都经过验证

按照这个映射表配置，可以避免字段不匹配、类型错误等问题。
