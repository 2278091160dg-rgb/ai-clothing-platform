# 🔍 三端联动验证指南

## 📅 文档版本：v1.0

## 📅 更新日期：2026-01-29

---

## 🎯 快速验证三端联动

本文档提供完整的验证步骤，帮助您快速验证前端Web、N8N工作流、飞书多维表格三者是否正确联动。

---

## 1. 前置条件

在开始验证之前，确保：

### 1.1 飞书多维表格

- [ ] 11个必需字段已创建
- [ ] 飞书自动化已配置并启用
- [ ] 记录了 App Token 和 Table ID

### 1.2 N8N工作流

- [ ] 工作流已导入（`ai-clothing-platform-n8n-workflow-complete.json`）
- [ ] 环境变量已配置
- [ ] 3个凭证已创建并关联
- [ ] 两个Webhook已激活

### 1.3 前端Web

- [ ] 环境变量已配置
- [ ] 应用已部署（本地或Vercel）

---

## 2. 验证1：飞书轨道

### 2.1 飞书自动化触发验证

**步骤1：准备测试数据**

在飞书多维表格中新建记录，填写：

```
提示词：时尚模特在繁华街头，日落时分，背景虚化
商品图片：上传任意商品图片
场景图：（可选）上传场景参考图
AI模型：（可选）保持默认
尺寸比例：（可选）保持默认
生成数量：（可选）保持默认
```

**步骤2：触发工作流**

点击"点击按钮"

**步骤3：验证结果**

检查以下验证点：

| 验证点       | 检查位置         | 期望结果             |
| ------------ | ---------------- | -------------------- |
| N8N接收请求  | N8N → Executions | 新增一条执行记录     |
| 飞书状态更新 | 飞书表格         | 状态字段变为"处理中" |
| 图片下载成功 | N8N执行日志      | 下载商品图片节点绿色 |
| AI生成成功   | N8N执行日志      | AI图片生成节点绿色   |
| 飞书结果更新 | 飞书表格         | 生成结果字段出现图片 |
| 飞书最终状态 | 飞书表格         | 状态字段变为"已完成" |

**如果验证失败：**

| 现象            | 可能原因               | 解决方法         |
| --------------- | ---------------------- | ---------------- |
| N8N没有收到请求 | 飞书自动化URL错误      | 检查URL配置      |
| N8N读取失败     | App Token/Table ID错误 | 检查N8N环境变量  |
| 图片下载失败    | 飞书鉴权失败           | 检查飞书凭证配置 |
| AI生成失败      | DeerAPI凭证错误        | 检查DeerAPI凭证  |
| 飞书更新失败    | 飞书API权限不足        | 检查飞书应用权限 |

### 2.2 飞书轨道日志验证

**查看N8N执行日志：**

1. 打开N8N界面
2. 点击左侧菜单"Executions"
3. 找到最新的执行记录
4. 检查每个节点的状态

**期望看到的节点流程：**

```
✅ Webhook触发器-飞书
✅ 飞书鉴权
✅ 获取飞书记录
✅ 提取飞书参数
✅ 更新飞书状态-处理中
✅ 下载商品图片
✅ 判断是否有场景图
✅ [下载场景图] (如果有)
✅ AI图片生成
✅ 处理生成结果
✅ 上传到飞书
✅ 更新飞书结果
✅ 返回飞书成功响应
```

**如果某个节点失败：**

点击失败节点，查看错误信息：

| 节点         | 常见错误               | 解决方法                |
| ------------ | ---------------------- | ----------------------- |
| 飞书鉴权     | `invalid credentials`  | 检查飞书App ID和Secret  |
| 获取飞书记录 | `record not found`     | 检查Table ID和Record ID |
| 提取飞书参数 | `cannot read property` | 检查字段名称是否匹配    |
| 下载商品图片 | `404 Not Found`        | 检查图片URL是否有效     |
| AI图片生成   | `API key error`        | 检查DeerAPI凭证         |
| 上传到飞书   | `upload failed`        | 检查图片大小格式        |
| 更新飞书结果 | `update failed`        | 检查飞书应用权限        |

---

## 3. 验证2：前端轨道

### 3.1 前端创建任务验证

**步骤1：打开Web前端**

访问：`https://你的应用地址`

**步骤2：填写表单**

```
提示词：时尚模特在繁华街头
商品图片：上传图片
场景图：（可选）上传场景图
AI模型：保持默认
尺寸比例：3:4
生成数量：1
```

**步骤3：提交任务**

点击"生成"按钮

**步骤4：验证结果**

检查以下验证点：

| 验证点       | 检查位置  | 期望结果               |
| ------------ | --------- | ---------------------- |
| 前端创建成功 | Web端响应 | 显示"任务创建成功"     |
| 飞书有记录   | 飞书表格  | 新增一条记录           |
| 飞书记录标识 | 飞书表格  | 数据来源="🌐 前端用户" |
| N8N执行成功  | N8N日志   | 所有节点绿色           |
| 前端显示结果 | Web端     | 显示生成的图片         |
| 飞书有结果   | 飞书表格  | 生成结果字段有图片     |

**如果验证失败：**

| 现象         | 可能原因            | 解决方法        |
| ------------ | ------------------- | --------------- |
| 飞书没有记录 | 事件系统未初始化    | 检查后端日志    |
| 飞书没有记录 | 飞书服务未配置      | 检查环境变量    |
| N8N没有执行  | N8N Webhook URL错误 | 检查N8N环境变量 |
| 前端没有结果 | N8N回调失败         | 检查回调URL配置 |

### 3.2 前端轨道日志验证

**查看后端日志：**

```bash
# 本地开发
npm run dev

# 或查看部署日志（Vercel）
vercel logs
```

**期望看到的日志：**

```
=== [API] 收到任务创建请求 ===
[API] 解析请求体...
[API] ✅ 请求验证通过
[API] 创建数据库记录...
[API] ✅ 任务创建成功: { id: 'xxx', status: 'pending' }
[API] ✅ 事件发布成功
[API] N8N 服务初始化成功
[API] ✅ N8N 工作流触发成功
[N8N] Triggering workflow...
```

**如果看到错误：**

| 错误信息                            | 可能原因       | 解决方法         |
| ----------------------------------- | -------------- | ---------------- |
| `Feishu credentials not configured` | 飞书凭证未配置 | 检查环境变量     |
| `n8n webhook failed`                | N8N服务不可达  | 检查N8N服务状态  |
| `Failed to sync task creation`      | 飞书同步失败   | 检查飞书服务状态 |

---

## 4. 验证3：双向同步

### 4.1 前端 → 飞书同步验证

**步骤1：从前端创建任务**

在Web端创建一个任务

**步骤2：查看飞书表格**

期望：飞书表格出现新记录，数据来源="🌐 前端用户"

**步骤3：等待生成完成**

期望：飞书记录的生成结果字段出现图片

### 4.2 飞书 → 前端同步验证

**步骤1：在飞书表格创建记录**

在飞书表格中填写信息并点击"点击按钮"

**步骤2：等待生成完成**

**步骤3：在前端查看任务列表**

期望：能看到飞书创建的任务（如果实现了双向查询）

### 4.3 状态同步验证

**测试场景：**

1. 前端创建任务 → 飞书记录状态="待处理" → N8N处理 → 状态="处理中" → 状态="已完成"
2. 检查每一步状态是否正确更新

---

## 5. 完整的端到端测试

### 5.1 测试用例1：前端基本流程

**输入：**

```json
{
  "productImageUrl": "data:image/png;base64,iVBORw0KG...",
  "prompt": "红色连衣裙，夏季时尚",
  "aspectRatio": "3:4",
  "imageCount": 1
}
```

**期望输出：**

- ✅ 前端显示创建成功
- ✅ 飞书有新记录
- ✅ 数据来源="🌌 前端用户"
- ✅ 30-60秒后生成结果
- ✅ 前端显示结果
- ✅ 飞书记录有生成结果

### 5.2 测试用例2：飞书基本流程

**输入：**

```
提示词：蓝色连衣裙，优雅知性
商品图：[上传图片]
场景图：[上传图片]
AI模型：Gemini-3-Pro-Image
```

**期望输出：**

- ✅ 飞书记录状态="处理中"
- ✅ 30-60秒后状态="已完成"
- ✅ 生成结果字段有图片

### 5.3 测试用例3：场景图可选

**输入A：有场景图**

```
提示词：测试
商品图：[上传图片]
场景图：[上传图片]
```

**输入B：无场景图**

```
提示词：测试
商品图：[上传图片]
场景图：（留空）
```

**期望输出：**

- ✅ 两种情况都能成功
- ✅ 无场景图时不报错

---

## 6. 问题排查流程

### 6.1 问题定位

**第1步：确定问题在哪一端**

```
前端有问题？
  ├─→ 打开浏览器控制台查看错误
  ├─→ 检查网络请求是否成功
  └─→ 查看后端日志

N8N有问题？
  ├─→ 打开N8N查看执行日志
  ├─→ 检查节点状态
  └─→ 查看节点输出

飞书有问题？
  ├─→ 检查飞书表格字段
  ├─→ 检查飞书自动化配置
  └─→ 检查飞书应用权限
```

### 6.2 常见问题速查表

| 问题现象       | 可能原因         | 快速检查        |
| -------------- | ---------------- | --------------- |
| 前端创建失败   | 后端未启动       | 检查后端进程    |
| 飞书没有记录   | 事件系统未初始化 | 检查后端日志    |
| N8N没有触发    | Webhook URL错误  | 检查N8N环境变量 |
| 飞书状态未更新 | N8N读取失败      | 检查N8N凭证     |
| 生成结果为空   | AI生成失败       | 检查DeerAPI凭证 |
| 前端显示超时   | N8N处理太慢      | 检查AI生成速度  |

### 6.3 错误日志查看

**前端日志：**

```bash
# 本地开发
npm run dev

# Vercel部署
vercel logs --follow
```

**N8N日志：**

```
N8N界面 → Executions → 选择执行记录 → 查看每个节点的输入输出
```

**飞书自动化日志：**

```
飞书多维表格 → 自动化 → 选择自动化 → 查看执行记录
```

---

## 7. 验证成功标志

### 7.1 飞书轨道成功标志

- ✅ 点击"点击按钮"后，状态立即变为"处理中"
- ✅ 30-60秒后，状态变为"已完成"
- ✅ 生成结果字段出现图片
- ✅ N8N所有节点显示绿色（成功）

### 7.2 前端轨道成功标志

- ✅ 前端显示"任务创建成功"
- ✅ 飞书表格出现新记录
- ✅ 飞书记录的"数据来源"显示"🌐 前端用户"
- ✅ 30-60秒后，前端显示生成结果
- ✅ 飞书记录的"生成结果"字段出现图片

### 7.3 双向同步成功标志

- ✅ 前端创建的任务能在飞书看到
- ✅ 飞书创建的任务（如果有前端接口）能查询到
- ✅ 所有任务的状态保持同步
- ✅ 生成结果在两端都能看到

---

## 8. 下一步

验证全部通过后，您的系统已经完全配置好了！

**下一步可以做：**

1. **添加更多功能**：参考《实施计划.md》
2. **优化用户体验**：参考《双端并发遗漏分析与交互完善方案.md》
3. **配置监控**：添加Sentry或DataDog监控
4. **性能优化**：优化图片处理速度

---

## 9. 联系支持

如果遇到无法解决的问题：

1. **检查文档**：先查看`docs/`目录下的相关文档
2. **查看日志**：收集前端、N8N、飞书的错误日志
3. **记录问题**：记下问题现象、操作步骤、错误信息

**收集信息清单：**

- [ ] 前端错误日志（浏览器控制台）
- [ ] 后端错误日志（后端日志）
- [ ] N8N执行日志（截图）
- [ ] 飞书自动化日志（截图）
- [ ] 环境变量配置（隐藏敏感信息）
