# 架构决策记录（Architecture Decision Records）

> **作用**：记录项目的重要架构决策和设计选择
> **格式**：ADR (Architecture Decision Record)
> **维护**：每次重大架构变更时更新

---

## ADR-001: 双轨并行架构

**日期**：2026-01-29
**状态**：✅ 已采纳
**决策者**：项目团队

### 上下文

用户需要在两个地方操作AI服装生成功能：

1. Web前端（Next.js应用）
2. 飞书多维表格（企业协作平台）

### 决策

采用**双轨并行架构**，创建2个完全独立的N8N工作流：

- **工作流1**：`AI服装平台-前端触发-同步飞书.json`
  - 触发源：Web前端
  - 流程：接收请求 → AI生成 → 创建飞书记录

- **工作流2**：`AI服装平台-飞书触发-独立流程.json`
  - 触发源：飞书按钮
  - 流程：读取记录 → AI生成 → 更新飞书记录

### 理由

- ✅ **独立维护**：两个轨道互不影响，便于独立调试和升级
- ✅ **清晰职责**：前端负责C端用户，飞书负责B端运营
- ✅ **故障隔离**：一个轨道故障不影响另一个
- ✅ **灵活扩展**：未来可针对不同轨道优化功能

### 后果

- 需要维护2个工作流配置
- 凭证管理策略明确（DeerAPI仅N8N，Feishu双重用途）
- 飞书表格固定为10个字段

---

## ADR-002: 飞书表格字段结构

**日期**：2026-01-29
**状态**：✅ 已采纳
**决策者**：项目团队

### 上下文

需要在飞书多维表格中存储AI生成任务的数据。

### 决策

采用**10个固定字段**的结构：

| 字段     | 类型     | 必填 | 说明               |
| -------- | -------- | ---- | ------------------ |
| 序号     | 数字     | -    | 自动编号           |
| 提示词   | 多行文本 | ✅   | AI生成提示词       |
| 商品图片 | 附件     | ✅   | 产品图片           |
| 场景图   | 附件     | ❌   | 场景参考图（可选） |
| 点击按钮 | 按钮     | -    | 触发生成           |
| 生成结果 | 附件     | -    | AI生成的图片       |
| 状态     | 单选     | -    | 任务状态           |
| 生成数量 | 数字     | ❌   | 生成几张图         |
| 尺寸比例 | 单选     | ❌   | 图片比例           |
| AI模型   | 单选     | ❌   | AI模型             |

**默认值**：

- AI模型：Gemini-3-Pro-Image
- 尺寸比例：3:4
- 生成数量：4

### 理由

- ✅ **简洁实用**：仅保留核心字段，避免冗余
- ✅ **用户友好**：字段名称直观，易于理解
- ✅ **扩展灵活**：可通过单选字段配置参数

### 后果

- 前端和N8N必须严格按照10个字段对接
- 字段名称和类型不能随意变更
- 字段映射关系固化在 `.clauderules` 中

---

## ADR-003: 凭证管理策略

**日期**：2026-01-29
**状态**：✅ 已采纳
**决策者**：项目团队

### 上下文

项目涉及多个外部服务（DeerAPI、Feishu、N8N），需要明确凭证配置位置。

### 决策

**N8N凭证（两个工作流共用）**：

- DeerAPI account：AI图片生成
- Feishu Credentials account：读取/更新飞书记录

**前端环境变量**：

```env
FEISHU_APP_ID=cli_xxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxx
N8N_WEBHOOK_URL=https://n8n.your-domain.com/webhook/ai-clothing-frontend
```

**前端不配置**：

- ❌ DeerAPI密钥（安全风险）
- ❌ N8N回调密钥（不需要）

### 理由

- ✅ **安全第一**：敏感密钥仅保存在N8N服务端
- ✅ **职责分离**：前端通过后端API调用，不直接访问敏感服务
- ✅ **双重用途**：前端Feishu凭证用于创建记录，N8N Feishu凭证用于更新记录，不冲突

### 后果

- 部署时必须配置前端环境变量
- N8N必须配置两个凭证
- 前端不能绕过后端直接调用DeerAPI

---

## 模板

```markdown
## ADR-XXX: [决策标题]

**日期**：YYYY-MM-DD
**状态**：🏋️ 提议中 / ✅ 已采纳 / ❌ 已废弃
**决策者**：XXX

### 上下文

[描述当前情况和问题]

### 决策

[描述做出的决策]

### 理由

[解释为什么做出这个决策]

### 后果

[描述这个决策带来的影响]
```

---

_最后更新：2026-01-29_
_维护者：项目团队_
