# 🚀 N8N 双轨工作流完整操作指南

## 📋 目录

1. [准备工作](#准备工作)
2. [飞书多维表格配置](#飞书多维表格配置)
3. [N8N 工作流1：前端触发](#n8n-工作流1前端触发)
4. [N8N 工作流2：飞书触发](#n8n-工作流2飞书触发)
5. [凭证配置](#凭证配置)
6. [测试验证](#测试验证)
7. [常见问题](#常见问题)

---

## 准备工作

### ✅ 前端代码已修改

以下3处代码已经修改完成：

1. ✅ `src/app/api/tasks/route.ts` - AI模型默认值改为 `Gemini-3-Pro-Image`
2. ✅ `src/app/api/tasks/route.ts` - 尺寸比例默认值改为 `3:4`
3. ✅ `src/lib/types/index.ts` - 添加了 Gemini 模型类型

### ✅ 需要准备的信息

在开始之前，请准备好：

- [ ] 飞书多维表格的 App Token（`app_xxxxxxxxx`）
- [ ] 飞书多维表格的 Table ID（`tblxxxxxxxxx`）
- [ ] DeerAPI 的 API Key
- [ ] 飞书应用的 App Access Token

---

## 飞书多维表格配置

### 步骤1：创建飞书多维表格

1. 打开飞书多维表格
2. 创建新表格或使用现有表格
3. 添加以下字段：

### 步骤2：配置表格字段

#### 必填字段（4个）

**字段1：提示词**

```
字段类型：多行文本
字段名：提示词
必填：是
说明：AI生成的提示词描述
```

**字段2：商品图片**

```
字段类型：附件
字段名：商品图片
必填：是
限制：仅图片
说明：第一张图：产品图
```

**字段3：点击按钮**

```
字段类型：按钮
字段名：点击按钮
按钮文本：点击按钮
触发：自动化（后续配置）
```

**字段4：生成结果**

```
字段类型：附件
字段名：生成结果
必填：否（自动写入）
说明：AI生成的结果图片，支持多张
```

#### 可选字段（2个）

**字段5：场景图**

```
字段类型：附件
字段名：场景图
必填：否
限制：仅图片
说明：第二张图：参考场景（可选）
```

**字段6：状态**

```
字段类型：单选
字段名：状态
必填：否
选项：
  - 待处理（默认）
  - 处理中
  - 已完成
  - 生成失败
说明：任务状态（自动更新）
```

#### 高级字段（3个，可选）

**字段7：AI模型**

```
字段类型：单选
字段名：AI模型
必填：否
选项：
  - Gemini-3-Pro-Image（默认）
  - Gemini-2-Flash
  - 其他模型...
说明：如果为空，使用默认值
```

**字段8：尺寸比例**

```
字段类型：单选
字段名：尺寸比例
必填：否
选项：
  - 1:1（1024x1024）
  - 3:4（768x1024，默认）
  - 16:9（1344x768）
  - 9:16（768x1344）
说明：如果为空，使用默认值3:4
```

**字段9：生成数量**

```
字段类型：数字
字段名：生成数量
必填：否
默认值：4
范围：1-8
说明：如果为空，使用默认值4
```

### 步骤3：获取 App Token 和 Table ID

1. 打开你的飞书多维表格
2. 在浏览器地址栏中找到 URL，例如：
   ```
   https://example.feishu.cn/base/appabc123def456/basenop789qrt012?table=tbl345uvw678xyz
   ```
3. **App Token** = `appabc123def456`
4. **Table ID** = `tbl345uvw678xyz`

---

## N8N 工作流1：前端触发

### 工作流概述

**文件**: `docs/n8n-workflow-frontend.json`

**功能**: 接收前端请求 → 调用DeerAPI → 回调后端

**节点数**: 14个

### 导入步骤

1. 打开N8N界面
2. 点击右上角 **"+"** 按钮
3. 选择 **"Import from File"**
4. 选择文件：`docs/n8n-workflow-frontend.json`
5. 点击 **"Import"**

### 节点说明

| 节点序号 | 节点名称      | 类型               | 说明                     |
| -------- | ------------- | ------------------ | ------------------------ |
| 1        | Webhook触发器 | Webhook            | 接收前端POST请求         |
| 2        | 解析请求参数  | Set                | 提取所有参数             |
| 3-6      | 判断比例      | IF (x4)            | 判断1:1、3:4、16:9、9:16 |
| 7-10     | 设置尺寸      | Set (x4)           | 设置对应尺寸             |
| 11       | AI图片生成    | HTTP Request       | 调用DeerAPI              |
| 12       | 格式化结果    | Set                | 提取结果图片             |
| 13       | 回调后端API   | HTTP Request       | 回调通知后端             |
| 14       | 返回成功响应  | Respond to Webhook | 返回成功消息             |

### 需要配置的参数

#### 节点11：AI图片生成

**凭证配置**:

```
凭证类型：Header Auth
凭证名称：DeerAPI account
```

**Body参数**:

```json
{
  "model": "{{ $json.aiModel }}",
  "prompt": "{{ $json.prompt }}",
  "image": "{{ $json.productImageUrl }}",
  "image2": "{{ $json.sceneImageUrl }}",
  "width": {{ $json.width }},
  "height": {{ $json.height }},
  "num_images": {{ $json.imageCount }}
}
```

**关键点**:

- ✅ `model` 使用前端传来的值（默认 Gemini-3-Pro-Image）
- ✅ `image2` 是可选的（如果有场景图）

---

## N8N 工作流2：飞书触发

### 工作流概述

**文件**: `docs/n8n-workflow-feishu-v2.json` ⚠️ 注意：使用v2版本

**功能**: 接收Webhook → 读取记录 → 下载图片 → 调用DeerAPI → 更新飞书

**节点数**: 20个

**重要更新**:

- ✅ v2版本已修复场景图可选问题
- ✅ 使用标准Webhook触发器（更稳定）
- ✅ 优化了并行分支处理逻辑

### 导入步骤

1. 打开N8N界面
2. 点击右上角 **"+"** 按钮
3. 选择 **"Import from File"**
4. 选择文件：`docs/n8n-workflow-feishu-v2.json` ⚠️ 注意：选择v2版本
5. 点击 **"Import"**

### 节点说明

| 节点序号 | 节点名称          | 类型               | 说明                     |
| -------- | ----------------- | ------------------ | ------------------------ |
| 1        | Webhook触发器     | Webhook            | 接收飞书自动化Webhook    |
| 2        | 读取飞书记录      | Feishu Bitable     | 读取完整记录数据         |
| 3        | 提取参数          | Set                | 从记录中提取参数         |
| 4        | 更新状态为处理中  | Feishu Bitable     | 更新状态字段             |
| 5        | 下载商品图片      | HTTP Request       | 下载第一张图             |
| 6        | 判断是否有场景图  | IF                 | 判断是否有场景图         |
| 7        | 下载场景图        | HTTP Request       | 下载第二张图（可选）     |
| 8        | 二进制数据处理    | Code               | ⚠️ 关键节点，必须保留    |
| 9        | 设置图片URL和参数 | Set                | 整理所有参数             |
| 10-13    | 判断比例          | IF (x4)            | 判断1:1、3:4、16:9、9:16 |
| 14-17    | 设置尺寸          | Set (x4)           | 设置对应尺寸             |
| 18       | AI图片生成        | HTTP Request       | 调用DeerAPI              |
| 19       | 格式化结果        | Set                | 格式化为飞书格式         |
| 20       | 更新飞书记录      | Feishu Bitable     | 写入结果                 |
| 21       | 返回成功响应      | Respond to Webhook | 返回成功消息             |

**v2版本改进**:

- ✅ 移除了"设置场景图URL"节点（不再需要）
- ✅ 使用 `$binary.scene_image` 对象处理场景图（更可靠）
- ✅ 场景图可选逻辑更健壮（不会报错）

### 需要手动配置的参数

#### ⚠️ 节点2：读取飞书记录

**必须手动修改的地方**:

```
App Token: app_你的AppToken  ← 替换这里
Table ID: tbl_你的TableID      ← 替换这里
```

#### ⚠️ 节点4、21：更新状态和记录

**必须手动修改的地方**:

```
App Token: app_你的AppToken  ← 替换这里
Table ID: tbl_你的TableID      ← 替换这里
```

#### 节点9：二进制数据处理（关键）

**JavaScript代码**（已包含，不要修改）:

```javascript
const items = $input.all();
for (let i = 0; i < items.length; i++) {
  const item = items[i];
  if (item.binary && item.binary.data) {
    const buffer = await this.helpers.getBinaryDataBuffer(i, 'data');
    item.json.real_size = buffer.length;
    item.json.file_name = 'final_product.png';
  }
}
return items;
```

**⚠️ 这个节点必须保留，否则飞书上传会失败！**

---

## 凭证配置

### DeerAPI 凭证

1. 在N8N界面，点击左侧菜单的 **"Credentials"**
2. 点击 **"Create New"**
3. 选择 **"Header Auth"**
4. 配置：
   ```
   Name: DeerAPI account
   Header Name: Authorization
   Header Value: Bearer YOUR_DEERAPI_KEY
   ```
5. 点击 **"Save"**

### Feishu Credentials

1. 在N8N界面，点击左侧菜单的 **"Credentials"**
2. 点击 **"Create New"**
3. 选择 **"Feishu Credentials API"**
4. 配置：
   ```
   Name: Feishu Credentials account
   App ID: 你的飞书App ID
   App Secret: 你的飞书App Secret
   ```
5. 点击 **"Save"**

---

## 飞书自动化配置（v2版本必须）

### 步骤1：创建飞书自动化

1. 打开飞书多维表格
2. 点击右上角 **"自动化"** 按钮
3. 点击 **"新建自动化"**

### 步骤2：配置触发器

```
触发条件：按钮被点击
选择字段：点击按钮
```

### 步骤3：配置操作

```
操作类型：发送Webhook请求
请求URL：从N8N的Webhook触发器节点复制
请求方法：POST
请求头：
  Content-Type: application/json
请求体：
  {
    "record_id": 触发记录ID
  }
```

### 如何获取Webhook URL

1. 在N8N中打开 `n8n-workflow-feishu-v2.json` 工作流
2. 点击第一个节点 **"Webhook触发器"**
3. 查看 **"Test URL"** 或 **"Production URL"**
4. 复制URL（例如：`https://your-n8n-instance.com/webhook/feishu-trigger`）
5. 粘贴到飞书自动化的请求URL中

### 完整配置示例

```
自动化名称：AI图片生成触发

触发器：
  - 当：点击按钮
  - 字段：点击按钮

操作：
  - 发送Webhook请求
  - URL：https://your-n8n-instance.com/webhook/feishu-trigger
  - 方法：POST
  - Headers：
      Content-Type: application/json
  - Body：
      {
        "record_id": 触发记录ID
      }
```

### 保存并启用

1. 点击右上角 **"保存"**
2. 点击右上角 **"启用"**
3. 测试：在表格中点击"点击按钮"

---

## 测试验证

### 测试1：前端路径

1. 在前端页面填写：
   - 提示词：`时尚模特在繁华街头`
   - 上传商品图片
   - （可选）上传场景图
   - AI模型：保持默认 `Gemini-3-Pro-Image`
   - 尺寸比例：保持默认 `3:4`
   - 生成数量：保持默认 `4`

2. 点击生成

3. 检查后端日志，应该看到：

   ```
   [API] N8N 工作流触发成功
   ```

4. N8N工作流应该执行：
   - 接收参数 ✅
   - 判断比例（3:4）✅
   - 设置尺寸（768x1024）✅
   - 调用DeerAPI ✅
   - 回调后端 ✅

### 测试2：飞书路径（v2版本）

**前提条件**:

- ✅ 已配置飞书自动化（发送Webhook请求）
- ✅ 已获取Webhook URL并配置到飞书自动化
- ✅ 飞书自动化已启用

1. 在飞书多维表格中新建记录

2. 填写字段：
   - 提示词：`时尚模特在繁华街头`
   - 商品图片：上传一张图片
   - （可选）场景图：上传一张图片
   - （可选）AI模型：选择或保持默认
   - （可选）尺寸比例：选择或保持默认
   - （可选）生成数量：选择或保持默认

3. 点击 **"点击按钮"**

4. 观察N8N工作流执行：
   - Webhook触发器接收 ✅（v2使用Webhook）
   - 读取记录成功 ✅
   - 状态变为"处理中" ✅
   - 下载图片成功 ✅
   - DeerAPI生成成功 ✅
   - 状态变为"已完成" ✅
   - 生成结果字段写入图片 ✅

### 测试3：场景图可选（v2版本重要测试）

**测试3a：有场景图**

1. 在飞书表格中新建记录
2. 填写：
   - 提示词：`时尚模特在繁华街头`
   - 商品图片：上传一张图片
   - **场景图：上传一张图片** ⬅️ 有场景图
3. 点击 **"点击按钮"**
4. 检查DeerAPI调用：`image2` 应该有URL ✅
5. 检查生成结果 ✅

**测试3b：无场景图（重要）**

1. 在飞书表格中新建记录
2. 填写：
   - 提示词：`时尚模特在繁华街头`
   - 商品图片：上传一张图片
   - **场景图：留空** ⬅️ 无场景图
3. 点击 **"点击按钮"**
4. 检查工作流不报错 ✅（v2修复了此问题）
5. 检查DeerAPI调用：`image2` 为空字符串 ✅
6. 检查生成结果 ✅

**v2版本优势**:

- ✅ 无场景图时不会报错
- ✅ 自动处理可选参数
- ✅ 更健壮的错误处理

---

## 常见问题

### Q1: 导入JSON后节点位置乱了？

**A**: 不影响功能，只是显示问题。可以手动拖拽调整。

### Q2: 提示"凭证未找到"？

**A**: 检查凭证配置：

1. 确认凭证已创建
2. 确认凭证名称正确（DeerAPI account、Feishu Credentials account）
3. 在节点中重新选择凭证

### Q3: 飞书工作流没有触发？

**A** (v2版本): 检查：

1. 飞书自动化是否已启用
2. Webhook URL是否正确配置
3. N8N工作流是否已激活（Active）
4. App Token和Table ID是否正确
5. 点击按钮后查看飞书自动化日志
6. 查看N8N的Executions（执行记录）

### Q4: 生成的图片尺寸不对？

**A**: 检查：

1. 尺寸比例字段是否正确填写
2. IF节点的条件是否正确
3. 尺寸节点的数值是否正确

### Q5: 场景图没有生效？

**A**: 检查：

1. 场景图字段是否有值
2. IF判断节点是否正确
3. DeerAPI的image2参数是否传递

### Q6: 状态没有更新？

**A**: 检查：

1. 飞书凭证权限是否足够
2. App Token和Table ID是否正确
3. 字段名是否完全匹配（区分大小写）

### Q7: 前端和飞书的结果不一致？

**A**:

- 前端结果存储在后端数据库
- 飞书结果存储在飞书表格
- 两者是独立的，需要额外的同步机制

### Q8: 如何查看工作流执行日志？

**A**:

1. 点击N8N左侧菜单的 **"Executions"**
2. 找到对应的执行记录
3. 点击查看每个节点的输入输出

---

## 📊 数据流图

### 前端路径

```
前端页面
  ↓
用户填写：提示词、上传图片、选择参数
  ↓
后端API (POST /api/tasks)
  ↓
创建任务（数据库：status=pending）
  ↓
调用N8N工作流1
  ↓
DeerAPI生成（使用Gemini-3-Pro-Image）
  ↓
回调后端API
  ↓
更新数据库（status=completed）
  ↓
同步到飞书表格
  ↓
前端显示结果
```

### 飞书路径

```
飞书多维表格
  ↓
用户填写：提示词、上传图片
  ↓
点击"点击按钮"
  ↓
触发N8N工作流2
  ↓
读取记录数据
  ↓
更新状态为"处理中"
  ↓
下载商品图片
  ↓
（可选）下载场景图
  ↓
二进制数据处理（关键节点）
  ↓
DeerAPI生成（使用Gemini-3-Pro-Image）
  ↓
更新飞书记录：
  - 生成结果：[图片数组]
  - 状态：已完成
  ↓
完成
```

---

## ✅ 配置检查清单

### 飞书表格

- [ ] 字段1：提示词（多行文本）
- [ ] 字段2：商品图片（附件）
- [ ] 字段3：点击按钮（按钮）
- [ ] 字段4：生成结果（附件）
- [ ] 字段5：场景图（附件，可选）
- [ ] 字段6：状态（单选，可选）
- [ ] 字段7：AI模型（单选，可选）
- [ ] 字段8：尺寸比例（单选，可选）
- [ ] 字段9：生成数量（数字，可选）

### N8N工作流1（前端）

- [ ] 导入JSON成功
- [ ] DeerAPI凭证已配置
- [ ] Webhook已激活
- [ ] 测试成功

### N8N工作流2（飞书v2版本）

- [ ] 导入JSON成功（n8n-workflow-feishu-v2.json）⚠️ 注意v2
- [ ] App Token已配置（3处）
- [ ] Table ID已配置（3处）
- [ ] DeerAPI凭证已配置
- [ ] Feishu凭证已配置
- [ ] Webhook已激活
- [ ] 飞书自动化已配置
- [ ] 飞书自动化已启用
- [ ] 测试成功（有场景图）
- [ ] 测试成功（无场景图）⚠️ 重要

---

## 🎉 完成后你可以做什么

### 在前端操作

1. 填写提示词
2. 上传商品图片和场景图
3. 选择AI模型、尺寸比例、生成数量
4. 点击生成
5. 等待结果自动显示

### 在飞书表格操作

1. 填写提示词
2. 上传商品图片和场景图
3. （可选）选择AI模型、尺寸比例、生成数量
4. 点击"点击按钮"
5. 等待结果自动写入表格

### 两种方式的数据都会

- ✅ 使用 Gemini-3-Pro-Image 模型
- ✅ 支持双图输入（商品图+场景图）
- ✅ 支持多种尺寸比例（1:1、3:4、16:9、9:16）
- ✅ 支持自定义生成数量（1-8张）
- ✅ 状态自动更新
- ✅ 结果图片自动存储

---

## 📞 需要帮助？

如果遇到问题，请检查：

1. **前端代码**：确认3处修改已生效
2. **飞书表格**：确认字段配置正确
3. **N8N工作流**：查看执行日志
4. **凭证配置**：确认凭证有效

**参考文档**：

- [N8N工作流验证报告](./N8N工作流验证报告.md) - v2版本修复说明
- [N8N快速导入指南](./N8N快速导入指南.md) - 5分钟快速导入
- [代码匹配验证报告](./代码匹配验证报告.md)
- [飞书字段配置说明](./FEISHU_FIELD_CONFIG.md)

祝配置顺利！🎊

---

## ⚠️ 重要提示

### 使用v2版本！

- ✅ 前端工作流：`n8n-workflow-frontend.json`
- ✅ 飞书工作流：`n8n-workflow-feishu-v2.json`（注意v2）
- ❌ 不要使用 `n8n-workflow-feishu.json`（v1版本有问题）

### v2版本优势

1. ✅ 修复了场景图可选问题（无场景图不会报错）
2. ✅ 使用标准Webhook触发器（更稳定可靠）
3. ✅ 优化了并行分支处理逻辑
4. ✅ 减少了1个节点（更简洁）
5. ✅ 更健壮的错误处理
