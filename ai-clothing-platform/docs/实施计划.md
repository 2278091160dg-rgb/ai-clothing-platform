# 双轨工作流实施计划

## 开发顺序策略分析

### 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **前端优先** | 快速看到效果<br/>用户体验优先<br/>便于演示迭代 | 需要Mock数据<br/>后期集成可能大改<br/>接口可能不稳定 | 快速原型<br/>需求不确定 |
| **后端优先** | 数据层稳定<br/>避免返工<br/>接口规范 | 前期看不到效果<br/>可能过度设计<br/>前端需求可能变 | 需求明确<br/>大型项目 |
| **并行开发** ⭐ | 速度快<br/>风险分散<br/>迭代灵活 | 需要协调<br/>接口依赖管理 | **推荐方案** |

---

## 推荐方案：分层并行开发

### 核心原则

1. **接口先行**：先定义数据模型和API接口
2. **后端基础**：飞书和N8N改动最小，先确认
3. **前端迭代**：分阶段开发，逐步集成

---

## 实施计划（总时长：5-7天）

### 第1天：数据模型和接口定义

#### 1.1 数据库Schema更新
```bash
# 文件：prisma/schema.prisma

# 新增字段
model Task {
  // ... 现有字段

  // 并发控制（第一阶段）
  version           Int           @default(0)
  lastModifiedBy    String?       // 'web' | 'feishu' | 'api'
  lastModifiedAt    DateTime      @default(now())

  // 提示词优化（第二阶段）
  originalPrompt    String?
  optimizedPrompt   String?
  promptSource      PromptSource  @default(USER)

  // 同步状态（第一阶段）
  syncStatus        SyncStatus    @default(PENDING)
  syncError         String?
}

enum PromptSource {
  USER
  AI_OPTIMIZED
  FEISHU
}

enum SyncStatus {
  PENDING      // 待同步
  SYNCING      // 同步中
  SYNCED       // 已同步
  FAILED       // 同步失败
}
```

#### 1.2 API接口定义
```typescript
// 接口1：创建任务（支持异步同步）
POST /api/tasks
{
  prompt: string
  optimizedPrompt?: string  // 可选
  useOptimized: boolean
  // ... 其他字段
}
Response: {
  task: Task
  syncStatus: 'pending' | 'synced' | 'failed'
}

// 接口2：获取任务（带同步状态）
GET /api/tasks/:id
Response: {
  task: Task
  syncStatus: SyncStatus
  lastSyncAt: Date
  conflictDetected: boolean
}

// 接口3：查询关联
GET /api/tasks/link?taskId=xxx | feishuRecordId=xxx
Response: {
  task: Task
  feishuRecord: Record | null
  linked: boolean
}

// 接口4：解决冲突
POST /api/tasks/:id/resolve-conflict
{
  strategy: 'use_local' | 'use_remote' | 'merge'
}
```

**输出**：
- [x] 更新 prisma/schema.prisma
- [x] 创建 API接口文档
- [x] 定义 TypeScript 接口类型

---

### 第2天：飞书表格 + N8N验证

#### 2.1 飞书表格字段添加
```
在飞书多维表格添加以下字段：

1. 数据来源（单选）
   - 🌐 前端用户
   - 📊 飞书用户
   - 🤖 API自动
   默认值：🌐 前端用户

2. 同步状态（单选）
   - ✅ 已同步
   - 🔄 同步中
   - ⚠️ 冲突
   - ❌ 失败
   默认值：🔄 同步中

3. 前端用户ID（文本）
   默认值：default-user
```

**耗时**：30分钟

#### 2.2 N8N工作流验证
```
验证内容：
1. 确认N8N输入参数包含 feishuRecordId
2. 确认N8N回调正确处理
3. 测试端到端流程

预期结果：N8N工作流零改动
```

**耗时**：1小时

#### 2.3 飞书API测试
```bash
# 测试飞书API连接
curl -X POST https://open.feishu.cn/open-apis/bitable/v1/apps/{app_token}/tables/{table_id}/records

# 验证字段是否正确创建
```

**耗时**：30分钟

**输出**：
- [x] 飞书表格字段已添加
- [x] N8N工作流验证通过
- [x] 飞书API连接测试通过

---

### 第3-4天：前端核心交互（第一阶段）

#### 3.1 冲突解决对话框
```
文件：src/components/ConflictResolutionDialog.tsx

功能：
- 显示冲突字段对比
- 提供三种解决策略
- 实时更新UI状态
```

#### 3.2 同步状态提示
```
文件：src/components/SyncStatusToast.tsx

功能：
- 提交时显示"正在同步到飞书..."
- 成功后显示"✅ 已同步到飞书"
- 失败后显示"⚠️ 同步失败，稍后重试"
- 提供重试按钮
```

#### 3.3 操作确认对话框
```
文件：src/components/DeleteConfirmDialog.tsx

功能：
- 删除任务二次确认
- 显示"将同时删除飞书记录"
- 提供"仅删除本地"选项
```

**输出**：
- [x] ConflictResolutionDialog 组件
- [x] SyncStatusToast 组件
- [x] DeleteConfirmDialog 组件
- [x] 集成到任务创建流程

---

### 第5天：后端冲突检测 + 同步优化

#### 5.1 乐观锁实现
```typescript
// 文件：src/lib/repositories/task.repository.ts

async updateWithVersion(
  taskId: string,
  updates: UpdateTaskInput,
  expectedVersion: number
): Promise<Task> {
  const current = await this.findById(taskId);

  if (current.version !== expectedVersion) {
    throw new VersionConflictError({
      taskId,
      currentVersion: current.version,
      expectedVersion,
      conflict: await this.detectConflict(current, updates),
    });
  }

  return await this.prisma.task.update({
    where: { id: taskId },
    data: {
      ...updates,
      version: { increment: 1 },
      lastModifiedAt: new Date(),
    },
  });
}
```

#### 5.2 异步飞书同步
```typescript
// 文件：src/lib/services/feishu-sync.service.ts

async syncTaskToFeishu(task: Task): Promise<void> {
  try {
    // 使用断路器保护
    await feishuCircuitBreaker.execute(async () => {
      if (task.feishuRecordId) {
        // 更新现有记录
        await feishuService.updateTaskRecord(...);
      } else {
        // 创建新记录
        const record = await feishuService.createTaskRecord(...);
        await taskRepo.update(task.id, {
          feishuRecordId: record.record_id,
          syncStatus: 'SYNCED',
        });
      }
    });
  } catch (error) {
    // 失败时标记状态
    await taskRepo.update(task.id, {
      syncStatus: 'FAILED',
      syncError: error.message,
    });
    throw error;
  }
}
```

**输出**：
- [x] 乐观锁实现
- [x] 冲突检测逻辑
- [x] 异步同步服务
- [x] 断路器集成

---

### 第6-7天：前端增强功能（第二阶段）

#### 6.1 实时编辑状态
```typescript
// 文件：src/components/EditingStatusIndicator.tsx

功能：
- 显示"其他用户正在编辑"
- 显示最后修改者信息
- 提供"刷新"按钮
```

#### 6.2 通知中心
```typescript
// 文件：src/components/NotificationCenter.tsx

功能：
- 集中显示所有通知
- 任务完成通知
- 冲突检测通知
- 同步失败通知
- 标记已读/未读
```

#### 6.3 操作撤销
```typescript
// 文件：src/hooks/useOperationHistory.ts

功能：
- 记录操作历史
- 撤销上一次操作
- 重做已撤销的操作
```

**输出**：
- [x] EditingStatusIndicator 组件
- [x] NotificationCenter 组件
- [x] useOperationHistory hook
- [x] 集成到任务列表页面

---

## 每日任务清单

### Day 1 - 数据模型和接口
- [ ] 更新 prisma/schema.prisma
- [ ] 运行 prisma migrate
- [ ] 创建 API 接口文档
- [ ] 定义 TypeScript 类型
- [ ] 测试数据库变更

### Day 2 - 飞书和N8N
- [ ] 添加飞书表格字段
- [ ] 验证N8N工作流
- [ ] 测试飞书API连接
- [ ] 更新环境变量
- [ ] 端到端测试

### Day 3 - 前端核心组件（1）
- [ ] ConflictResolutionDialog 组件
- [ ] SyncStatusToast 组件
- [ ] DeleteConfirmDialog 组件
- [ ] 单元测试

### Day 4 - 前端核心组件（2）
- [ ] 集成到任务创建流程
- [ ] 集成到任务列表
- [ ] 集成到任务详情
- [ ] E2E测试

### Day 5 - 后端实现
- [ ] 乐观锁实现
- [ ] 冲突检测
- [ ] 异步同步服务
- [ ] API端点更新
- [ ] 集成测试

### Day 6 - 前端增强（1）
- [ ] EditingStatusIndicator
- [ ] NotificationCenter
- [ ] 实时状态订阅
- [ ] WebSocket集成

### Day 7 - 前端增强（2）
- [ ] useOperationHistory hook
- [ ] 操作撤销功能
- [ ] 性能优化
- [ ] 最终测试

---

## 并行开发策略

### 前后端分工

```
前端开发：
├── Day 3-4: 核心交互组件（使用Mock数据）
├── Day 6-7: 增强功能（连接真实API）

后端开发：
├── Day 1: 接口定义和数据库
├── Day 2: 飞书和N8N验证
├── Day 5: 冲突检测和同步逻辑
```

### 接口依赖管理

```typescript
// 前端使用Mock数据开发（Day 3-4）
const mockTasks = [
  { id: '1', prompt: '...', syncStatus: 'SYNCED', ... },
  { id: '2', prompt: '...', syncStatus: 'SYNCING', ... },
];

// 后端接口就绪后切换（Day 5+）
const tasks = await apiService.getTasks();
```

---

## 风险控制

### 风险1：飞书API不稳定
**缓解措施**：
- 断路器保护
- 降级策略（飞书失败不影响主流程）
- 重试机制

### 风险2：N8N工作流需要改动
**缓解措施**：
- Day 2提前验证
- 预留调整时间
- 保持N8N改动最小

### 风险3：前后端集成问题
**缓解措施**：
- 接口先行（Day 1）
- 使用TypeScript严格类型
- 持续集成测试

---

## 测试策略

### 单元测试
```
- 冲突检测逻辑
- 版本比对算法
- 同步状态转换
```

### 集成测试
```
- 前端 → 后端 → 飞书
- N8N回调处理
- 事件系统
```

### E2E测试
```
- 创建任务 → 飞书同步 → N8N处理 → 完成
- 冲突检测 → 用户解决 → 状态更新
- 删除任务 → 飞书同步删除
```

---

## 成功标准

### 第一阶段（Day 1-4）
- [x] 前端创建任务时显示同步状态
- [x] 冲突时弹出解决对话框
- [x] 删除时有二次确认
- [x] 飞书表格正确显示任务

### 第二阶段（Day 5-7）
- [x] 实时显示其他用户编辑状态
- [x] 通知中心正常工作
- [x] 操作可以撤销
- [x] 端到端流程流畅

---

## 下一步行动

### 立即开始（今天）
1. 更新 prisma/schema.prisma
2. 添加飞书表格字段
3. 验证N8N工作流

### 本周完成
4. 实现核心交互组件
5. 实现后端冲突检测
6. 完成端到端测试

### 下周优化
7. 增强功能实现
8. 性能优化
9. 用户反馈收集
